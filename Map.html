<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Disciple Run - World Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff">

<style>
  @font-face {
    font-family: 'DungGeunMo';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
    font-weight: normal;
    font-style: normal;
  }

  body {
    margin: 0; padding: 0;
    width: 100vw; height: 100vh;
    background-color: #2c2c2c;
    font-family: 'DungGeunMo', sans-serif;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* ë§µ ì»¨í…Œì´ë„ˆ: ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ (5:6) */
  #mapContainer {
    position: relative;
    width: 100%;
    max-width: 800px; 
    aspect-ratio: 5 / 6; 
    background-image: url('WorldMap.jpg'); 
    background-size: cover;
    background-position: center;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }

  /* ìƒë‹¨ UI */
  .top-ui {
    position: absolute; top: 10px; left: 10px; right: 10px;
    display: flex; justify-content: space-between;
    z-index: 100;
  }
  .ui-btn {
    background: #5d4037; color: #fff;
    border: 3px solid #3e2723;
    padding: 8px 16px;
    font-family: 'DungGeunMo', sans-serif;
    font-size: 16px; cursor: pointer;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
  }
  .ui-btn:active { transform: translate(2px, 2px); box-shadow: none; }

  /* ì„± ë²„íŠ¼ */
  .castle-btn {
    position: absolute;
    width: 12%; height: 10%;
    background: transparent; 
    cursor: pointer;
    z-index: 10;
    transform: translate(-50%, -50%);
  }
  .castle-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
  }

  /* ì„± ì •ë³´ ë¼ë²¨ */
  .castle-label {
    position: absolute;
    bottom: 100%; left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    border: 2px solid #bcaaa4;
    white-space: nowrap;
    text-align: center;
    font-size: 12px;
    pointer-events: none;
    margin-bottom: 5px;
    text-shadow: 1px 1px 0 #000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
  }
  
  /* ì•„ì´ì½˜ í¬ê¸° ì¡°ì • (ë³´ìŠ¤ ì´ë¯¸ì§€ê°€ ì˜ ë³´ì´ë„ë¡) */
  .lord-icon {
    display: block; width: 40px; height: 40px; margin: 0 auto 4px;
    background-size: contain; background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
  }

  .castle-name { color: #ffd700; font-weight: bold; display: block; margin-bottom: 2px; font-size: 13px; }
  .lord-name { color: #00e5ff; font-size: 11px; }

  /* ë¡œë”© í™”ë©´ */
  #loading {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    color: white; 
    display: flex; 
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    font-size: 20px; 
    z-index: 999;
    backdrop-filter: blur(5px);
  }
  .loading-spinner {
    width: 40px; height: 40px; border: 4px solid #fff; 
    border-top: 4px solid #ff9800; border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 15px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body oncontextmenu="return false" onselectstart="return false">

  <div id="mapContainer">
    <div class="top-ui">
      <button class="ui-btn" onclick="location.href='menu.html'">â† ë©”ë‰´</button>
      <div class="ui-btn" style="background:#333;">ğŸ° ì›”ë“œë§µ (ê³µì„±ì „)</div>
    </div>

    <div id="loading">
      <div class="loading-spinner"></div>
      <div>ì„±ì£¼ ì •ë³´ë¥¼ ìˆ˜ì‹  ì¤‘...</div>
    </div>

    <div id="castlesLayer"></div>
  </div>

<script>
  // 1. Google Apps Script URL (ë³¸ì¸ URL ìœ ì§€)
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  // 2. ì„± ìœ„ì¹˜ ë°ì´í„°
  const CASTLES = [
    { id: 1, name: "ë² ë“œë¡œ ì„±", top: 18, left: 18 },
    { id: 2, name: "ì•ˆë“œë ˆ ì„±", top: 15, left: 50 },
    { id: 3, name: "ì•¼ê³ ë³´ ì„±", top: 20, left: 82 },
    { id: 4, name: "ìš”í•œ ì„±",   top: 38, left: 23 },
    { id: 5, name: "ë¹Œë¦½ ì„±",   top: 40, left: 50 },
    { id: 6, name: "ë°”ëŒë¡œë§¤ ì„±", top: 45, left: 85 },
    { id: 7, name: "ë„ë§ˆ ì„±",   top: 70, left: 16 },
    { id: 8, name: "ë§ˆíƒœ ì„±",   top: 58, left: 38 },
    { id: 9, name: "ì•ŒíŒ¨ì˜¤ ì„±", top: 60, left: 63 },
    { id: 10, name: "ë‹¤ëŒ€ì˜¤ ì„±", top: 82, left: 38 },
    { id: 11, name: "ì‹œëª¬ ì„±",   top: 80, left: 65 },
    { id: 12, name: "ë§›ë””ì•„ ì„±", top: 75, left: 85 }
  ];

  async function loadMapData() {
    try {
      // 1. ì„œë²„ì— ë°ì´í„° ìš”ì²­
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        redirect: "follow",
        body: JSON.stringify({ type: "getAllCastles" })
      });
      const castleData = await res.json();
      
      // 2. ë°ì´í„°ê°€ ì˜¤ë©´ ì„± ê·¸ë¦¬ê¸°
      renderCastles(castleData);
      
    } catch (e) {
      console.error(e);
      alert("ì„± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      renderCastles([]); // ì‹¤íŒ¨ ì‹œ ë¹ˆ ìƒíƒœë¡œë¼ë„ í‘œì‹œ
    } finally {
      // 3. ë¡œë”© í™”ë©´ ì œê±°
      const loadingEl = document.getElementById("loading");
      loadingEl.style.transition = "opacity 0.5s";
      loadingEl.style.opacity = "0";
      setTimeout(() => loadingEl.style.display = "none", 500);
    }
  }

  function renderCastles(serverData) {
    const layer = document.getElementById("castlesLayer");
    layer.innerHTML = "";

    CASTLES.forEach(c => {
      // í•´ë‹¹ ì„±ì˜ ì„±ì£¼ ì •ë³´ ì°¾ê¸°
      const info = serverData ? serverData.find(d => d.id == c.id) : null;
      
      let ownerName = "NPC ìˆ˜í˜¸ì";
      // [ìˆ˜ì • í¬ì¸íŠ¸] ê¸°ë³¸ê°’ì¼ ë•Œ C_boss + ì„±ID ì‚¬ìš© (ì˜ˆ: C_boss1, C_boss12)
      let ownerSkin = "C_boss" + c.id; 
      
      // ì„±ì£¼ê°€ ìˆìœ¼ë©´ ì •ë³´ ê°±ì‹ 
      if (info && info.ownerName) {
        ownerName = `ğŸ‘‘ ${info.ownerName}`;
        ownerSkin = `skin_${info.skin}`;
      }

      const btn = document.createElement("div");
      btn.className = "castle-btn";
      btn.style.top = c.top + "%";
      btn.style.left = c.left + "%";
      btn.onclick = () => enterCastle(c.id);

      const label = document.createElement("div");
      label.className = "castle-label";
      
      // ì´ë¯¸ì§€ ê²½ë¡œ ìƒì„± (ì˜ˆ: C_boss1.png ë˜ëŠ” skin_noel.png)
      const skinUrl = `${ownerSkin}.png`;
      const fallbackUrl = "disciple.png"; // ì´ë¯¸ì§€ ì—†ì„ ë•Œ ê¸°ë³¸ê°’

      label.innerHTML = `
        <div class="lord-icon" style="background-image:url('${skinUrl}'), url('${fallbackUrl}')"></div>
        <span class="castle-name">${c.name}</span>
        <span class="lord-name">${ownerName}</span>
      `;
      
      btn.appendChild(label);
      layer.appendChild(btn);
    });
  }

  function enterCastle(id) {
    // ê³µì„±ì „ í˜ì´ì§€ë¡œ ì´ë™
    window.location.href = `Siege.html?castle=${id}`;
  }

  // ì‹œì‘
  loadMapData();
</script>

</body>
</html>
