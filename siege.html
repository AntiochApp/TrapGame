<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Disciple Run â€“ Siege Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    :root { --hud-bg: rgba(0, 0, 0, 0.7); --hud-border: #ffd700; --accent: #d32f2f; --panel-bg: #222; }
    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; font-family: "Pretendard", sans-serif; }
    
    #gameArea { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #333; transition: filter 0.5s; }
    
    /* [ê³µì„±ì „ ì „ìš©] ë³´ìŠ¤ ìŠ¤í‚¬ íš¨ê³¼ìš© í´ë˜ìŠ¤ */
    #gameArea.effect-darkness { filter: brightness(0.2); } /* 6ë²ˆ ì–´ë‘  */
    #gameArea.effect-sand { filter: sepia(0.8) blur(1px); } /* 4ë²ˆ ì‚¬ë§‰ */
    #gameArea.effect-water { filter: hue-rotate(180deg) blur(1px); } /* 5ë²ˆ ë¬¼ */
    #gameArea.effect-light { filter: brightness(2.0) contrast(0.5); } /* 12ë²ˆ ë¹› */
    #gameArea.effect-ice { filter: hue-rotate(90deg) brightness(1.2); } /* 1ë²ˆ ì–¼ìŒ */

    /* ë°°ê²½ ë ˆì´ì–´ */
    .bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-repeat: repeat-x; }
    #bgLayer1 { z-index: 1; background-size: auto 100%; background-position: 0 bottom; }
    #bgLayer2 { z-index: 2; background-size: auto 60%; background-position: 0 bottom; }
    #bgLayer3 { z-index: 3; background-size: auto 40%; background-position: 0 bottom; }

    #player { position: absolute; z-index: 50; left: 50px; bottom: 40px; width: 60px; height: 60px; background-image: url("disciple.png"); background-position: center; background-size: contain; background-repeat: no-repeat; image-rendering: pixelated; transition: opacity 0.2s, transform 0.3s; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5)); }
    
    /* ì  & ë³´ìŠ¤ */
    .enemy { position: absolute; z-index: 48; width: 60px; height: 60px; background-position: center; background-size: contain; background-repeat: no-repeat; }
    .obstacle { position: absolute; z-index: 40; background-size: 8px 8px; box-shadow: 4px 4px 0 rgba(0,0,0,0.5); }
    
    /* ë³´ìŠ¤ ì»¨í…Œì´ë„ˆ */
    #bossContainer { position: absolute; right: -250px; top: 50%; width: 150px; height: 150px; z-index: 55; display: none; transition: right 1s ease-out; }
    #bossBody { width: 100%; height: 100%; background-repeat: no-repeat; background-position: center; background-size: contain; image-rendering: pixelated; filter: drop-shadow(0 0 15px red); animation: bossFloat 2s ease-in-out infinite; }
    #bossHpBar { position: absolute; top: -20px; left: 0; width: 100%; height: 10px; background: #333; border: 2px solid #fff; border-radius: 5px; overflow: hidden; }
    #bossHpFill { width: 100%; height: 100%; background: #d32f2f; transition: width 0.2s; }
    @keyframes bossFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

    /* íˆ¬ì‚¬ì²´ ë° ì´í™íŠ¸ */
    .projectile { position: absolute; z-index: 60; width: 30px; height: 30px; border-radius: 50%; transition: opacity 0.2s; }
    .boss-missile { width: 40px; height: 40px; background: radial-gradient(circle, #fff, #f00); box-shadow: 0 0 10px #f00; border: 2px solid #fff; }
    .player-missile { position: absolute; width: 50px; height: 24px; background: linear-gradient(90deg, #00ffff, #0099ff); border-radius: 12px; box-shadow: 0 0 15px cyan; z-index: 65; border: 2px solid #fff; }
    
    /* íŠ¹ìˆ˜ íˆ¬ì‚¬ì²´ ìŠ¤íƒ€ì¼ (ë³´ìŠ¤ë³„) */
    .proj-ice { background: radial-gradient(circle, #fff, #00ffff); box-shadow: 0 0 15px #00ffff; }
    .proj-fire { background: radial-gradient(circle, #ffeb3b, #ff0000); box-shadow: 0 0 15px #ff0000; }
    .proj-dark { background: #000; border: 2px solid #800080; box-shadow: 0 0 15px #800080; }
    .proj-stone { background: #795548; border: 2px solid #3e2723; border-radius: 5px; }
    .proj-light { background: #fff; box-shadow: 0 0 20px #fff, 0 0 40px #ffd700; }

    #flashEffect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 200; transition: opacity 0.1s; }
    .particle { position: absolute; z-index: 90; pointer-events: none; border-radius: 50%; animation: particleFade 0.8s ease-out forwards; }
    @keyframes particleFade { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }

    /* HUD */
    #hud { position: fixed; z-index: 900; top: 12px; left: 12px; color: #fff; font-size: 18px; font-weight: 700; background: var(--hud-bg); border-radius: 10px; padding: 8px 12px; border: 2px solid var(--hud-border); text-shadow: 1px 1px 0 #000; }
    #castleTitle { position: fixed; top: 12px; right: 12px; color: #ffd700; font-size: 20px; font-weight: 900; z-index: 900; text-shadow: 2px 2px 0 #000; }

    #subActionBtn { position: fixed; bottom: 50px; left: 20px; width: 100px; height: 100px; border-radius: 50%; border: 4px solid #fff; color: white; font-weight: 900; font-size: 20px; text-align: center; display: none; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; box-shadow: 0 6px 12px rgba(0,0,0,0.6); background-color: #D32F2F; }
    #subActionBtn:active { transform: scale(0.9); }
    
    #bossWarning { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; font-weight: 900; color: #d32f2f; text-shadow: 3px 3px 0 #000; display: none; z-index: 2000; animation: blink 0.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    /* ê²°ê³¼ ëª¨ë‹¬ */
    .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 3000; }
    .modal-box { width: 90%; max-width: 400px; background: #fff; padding: 20px; border-radius: 10px; text-align: center; border: 4px solid #333; }
    .modal-btn { padding: 10px 20px; background: #d32f2f; color: #fff; border: none; font-size: 18px; cursor: pointer; margin-top: 10px; }
  </style>
</head>

<body oncontextmenu="return false" onselectstart="return false">

<div id="gameArea">
  <div id="bgLayer1" class="bg-layer"></div>
  <div id="bgLayer2" class="bg-layer"></div>
  <div id="bgLayer3" class="bg-layer"></div>

  <div id="ground"></div> 
  <div id="player"></div>
  <div id="flashEffect"></div>

  <div id="bossContainer">
    <div id="bossHpBar"><div id="bossHpFill"></div></div>
    <div id="bossBody"></div>
  </div>

  <div id="hud">
    â¤ï¸ <span id="lifeText">3</span> | ğŸ“ <span id="distanceText">0m</span>
  </div>
  <div id="castleTitle"></div>
  <div id="bossWarning">âš ï¸ BOSS WARNING!</div>

  <div id="subActionBtn" ontouchstart="handleAttack(event)" onclick="handleAttack(event)">ATTACK</div>
</div>

<div id="resultModal" class="modal-bg">
  <div class="modal-box">
    <h2 id="resultTitle">GAME OVER</h2>
    <p id="resultDesc">...</p>
    <button class="modal-btn" onclick="location.href='Map.html'">ì§€ë„(Map)ë¡œ ëŒì•„ê°€ê¸°</button>
    <button class="modal-btn" style="background:#555;" onclick="location.reload()">ë‹¤ì‹œ ë„ì „</button>
  </div>
</div>

<script>
  // ====================================================
  // 1. ì„¤ì • ë° ë°ì´í„° ë¡œë“œ
  // ====================================================
  
  // URLì—ì„œ Castle ID ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’ 1)
  const urlParams = new URLSearchParams(window.location.search);
  const castleId = parseInt(urlParams.get('castle')) || 1;

  const CASTLE_NAMES = [
    "", "ë² ë“œë¡œ ì„±", "ì•ˆë“œë ˆ ì„±", "ì•¼ê³ ë³´ ì„±", "ìš”í•œ ì„±", "ë¹Œë¦½ ì„±", "ë°”ëŒë¡œë§¤ ì„±",
    "ë„ë§ˆ ì„±", "ë§ˆíƒœ ì„±", "ì•ŒíŒ¨ì˜¤ ì„±", "ë‹¤ëŒ€ì˜¤ ì„±", "ì‹œëª¬ ì„±", "ë§›ë””ì•„ ì„±"
  ];
  const CASTLE_THEMES = [
    "", "Ice", "Fire", "Wood", "Sand", "Water", "Darkness", "Stone", "Space", "Defense", "Sword", "Necro", "Light"
  ];

  document.getElementById("castleTitle").innerText = `ğŸ° ${CASTLE_NAMES[castleId]} (${CASTLE_THEMES[castleId]})`;

  // ë°°ê²½ ì´ë¯¸ì§€ ë™ì  í• ë‹¹
  document.getElementById("bgLayer1").style.backgroundImage = `url('${castleId}bg_sky.png')`;
  document.getElementById("bgLayer2").style.backgroundImage = `url('${castleId}bg_mountain.png')`;
  document.getElementById("bgLayer3").style.backgroundImage = `url('${castleId}bg_forest.png')`;

  // ìœ ì € ì •ë³´ ë¡œë“œ (ìŠ¤í‚¨ ì ìš©ìš©)
  let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");
  let mySkin = saveData.equippedSkin || "default";
  const player = document.getElementById("player");
  if(mySkin !== 'default') player.style.backgroundImage = `url('skin_${mySkin}.png')`;

  // ====================================================
  // 2. ê²Œì„ ë³€ìˆ˜
  // ====================================================
  let running = true;
  let distance = 0;
  let life = 3 + (saveData.extraLife || 0); // ë¼ì´í”„ ë³´ë„ˆìŠ¤ ì ìš©
  document.getElementById("lifeText").innerText = life;

  let playerObj = { x: 50, y: 40, w: 40, h: 50 };
  let velocity = 0;
  const gravity = -0.6;
  const jumpPower = 12;

  let obstacles = [];
  let enemies = [];
  let projectiles = [];
  let playerMissiles = [];

  // íƒ€ì´ë¨¸ë“¤
  let obstacleTimer = 0;
  let enemyTimer = 0;
  let nextObsTime = 2.0;

  // ë³´ìŠ¤ì „ ê´€ë ¨
  let isBossBattle = false;
  let boss = { hp: 50, maxHp: 50, x: 0, y: 50, vy: 0, state: 'idle', skillTimer: 0 };
  const BOSS_APPEAR_DIST = 10000; // 1ë§Œ ë¯¸í„°ì—ì„œ ë“±ì¥

  // ====================================================
  // 3. ê²Œì„ ë£¨í”„
  // ====================================================
  let lastTime = performance.now();

  function gameLoop(now) {
    if(!running) return;
    const dt = (now - lastTime) / 1000;
    lastTime = now;
    const safeDt = Math.min(dt, 0.05);

    // ê±°ë¦¬ ì¦ê°€ (ë³´ìŠ¤ì „ ì•„ë‹ë•Œ)
    if (!isBossBattle) {
      distance += safeDt * 150; // ì†ë„
      document.getElementById("distanceText").innerText = Math.floor(distance) + "m";
      
      // ë°°ê²½ ìŠ¤í¬ë¡¤
      const bg1 = document.getElementById("bgLayer1");
      const bg2 = document.getElementById("bgLayer2");
      const bg3 = document.getElementById("bgLayer3");
      bg1.style.backgroundPosition = `-${distance * 0.1}px 0`;
      bg2.style.backgroundPosition = `-${distance * 0.3}px bottom`;
      bg3.style.backgroundPosition = `-${distance * 0.5}px bottom`;

      // ë³´ìŠ¤ ì¶œí˜„ ì²´í¬
      if(distance >= BOSS_APPEAR_DIST) startBossBattle();

      // ì¥ì• ë¬¼ & ì  ìŠ¤í° (ë³´ìŠ¤ì „ì—” ì¤‘ë‹¨)
      obstacleTimer += safeDt;
      if(obstacleTimer > nextObsTime) {
         spawnObstacle();
         obstacleTimer = 0;
         nextObsTime = Math.random() * 1.5 + 1.0;
      }
      
      enemyTimer += safeDt;
      if(enemyTimer > 3.0) {
         spawnEnemy();
         enemyTimer = 0;
      }
    } else {
      updateBoss(safeDt);
    }

    // ë¬¼ë¦¬ ì—…ë°ì´íŠ¸
    updatePhysics(safeDt);
    updateEntities(safeDt);
    
    // ê³µê²© ë²„íŠ¼ í™œì„±í™” (200m ì´ìƒ)
    if(distance > 200) document.getElementById("subActionBtn").style.display = "flex";

    requestAnimationFrame(gameLoop);
  }
  requestAnimationFrame(gameLoop);

  // ====================================================
  // 4. ë¬¼ë¦¬ ë° ì—”í‹°í‹° ì²˜ë¦¬
  // ====================================================
  function updatePhysics(dt) {
    velocity += gravity;
    playerObj.y += velocity;
    
    if(playerObj.y < 0) { playerObj.y = 0; velocity = 0; }
    if(playerObj.y > window.innerHeight - 60) playerObj.y = window.innerHeight - 60;
    
    player.style.bottom = playerObj.y + "px";
  }

  function updateEntities(dt) {
    // 1. ì¥ì• ë¬¼
    for(let i=obstacles.length-1; i>=0; i--) {
       let o = obstacles[i];
       o.x -= 300 * dt; // ì´ë™ ì†ë„
       o.style.left = o.x + "px";
       
       if(o.x < -100) { o.remove(); obstacles.splice(i,1); continue; }
       
       // ì¶©ëŒ ì²´í¬
       if(checkCollision(playerObj, {x:o.x, y:0, w:60, h:o.h})) {
          damageLife();
          o.remove(); obstacles.splice(i,1);
       }
    }

    // 2. ì  (Enemies)
    for(let i=enemies.length-1; i>=0; i--) {
       let e = enemies[i];
       // ë„¤í¬ë¡œë§¨ì„œ ì†Œí™˜ëª¹ ë“±ì€ íŒ¨í„´ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
       e.x -= (e.speed || 200) * dt; 
       e.style.left = e.x + "px";
       
       if(e.x < -100) { e.remove(); enemies.splice(i,1); continue; }
       
       // í”Œë ˆì´ì–´ ì¶©ëŒ
       if(checkCollision(playerObj, {x:e.x, y:e.y, w:e.w, h:e.h})) {
          damageLife();
          e.remove(); enemies.splice(i,1);
       }
    }

    // 3. ì•„êµ° ë¯¸ì‚¬ì¼
    for(let i=playerMissiles.length-1; i>=0; i--) {
       let m = playerMissiles[i];
       m.x += 600 * dt;
       m.style.left = m.x + "px";
       
       if(m.x > window.innerWidth) { m.remove(); playerMissiles.splice(i,1); continue; }
       
       // ì  ì¶©ëŒ
       let hit = false;
       for(let j=enemies.length-1; j>=0; j--) {
          let e = enemies[j];
          if(checkCollision({x:m.x, y:m.y, w:50, h:24}, {x:e.x, y:e.y, w:e.w, h:e.h})) {
             e.hp--;
             if(e.hp<=0) { spawnExplosion(e.x, e.y); e.remove(); enemies.splice(j,1); }
             m.remove(); playerMissiles.splice(i,1);
             hit = true; break;
          }
       }
       if(hit) continue;

       // ë³´ìŠ¤ ì¶©ëŒ
       if(isBossBattle && boss.hp > 0) {
          // ë³´ìŠ¤ íˆíŠ¸ë°•ìŠ¤ (ëŒ€ëµì )
          if(m.x > window.innerWidth - 250 && Math.abs(m.y - boss.y - 50) < 80) {
             boss.hp--;
             updateBossHp();
             spawnExplosion(m.x, m.y);
             m.remove(); playerMissiles.splice(i,1);
             if(boss.hp <= 0) gameClear();
          }
       }
    }

    // 4. ì  íˆ¬ì‚¬ì²´ (ë³´ìŠ¤ ìŠ¤í‚¬ ë“±)
    for(let i=projectiles.length-1; i>=0; i--) {
       let p = projectiles[i];
       p.x += p.vx * dt;
       p.y += p.vy * dt;
       p.style.left = p.x + "px";
       p.style.bottom = p.y + "px"; // CSS top ëŒ€ì‹  bottom ì‚¬ìš© ì£¼ì˜
       
       if(p.x < -50 || p.x > window.innerWidth) { p.remove(); projectiles.splice(i,1); continue; }
       
       if(checkCollision(playerObj, {x:p.x, y:p.y, w:30, h:30})) {
          damageLife();
          p.remove(); projectiles.splice(i,1);
       }
    }
  }

  // ====================================================
  // 5. ìŠ¤í° ë¡œì§ (ì„± ID ë°˜ì˜)
  // ====================================================
  function spawnObstacle() {
     // ë‚˜ë¬´ì„±(3)ì€ ì¥ì• ë¬¼ ë” ìì£¼ ë‚˜ì˜´
     if(castleId === 3 && Math.random() < 0.3) {
        // ì¶”ê°€ ë¡œì§ ê°€ëŠ¥
     }
     const obs = document.createElement("div");
     obs.className = "obstacle obs-log";
     obs.h = Math.random() * 100 + 50;
     obs.style.height = obs.h + "px";
     obs.x = window.innerWidth + 50;
     obs.style.left = obs.x + "px";
     obs.style.bottom = "0px";
     
     // ì¥ì• ë¬¼ ì´ë¯¸ì§€ë„ ì„± í…Œë§ˆì— ë§ì¶œ ìˆ˜ ìˆìœ¼ë‚˜ ì¼ë‹¨ ê¸°ë³¸ ì‚¬ìš©
     document.getElementById("gameArea").appendChild(obs);
     obstacles.push(obs);
  }

  function spawnEnemy() {
     const isMidBoss = (Math.random() < 0.2); // 20% í™•ë¥ ë¡œ ì¤‘ê°„ë³´ìŠ¤
     const e = document.createElement("div");
     e.className = "enemy";
     
     if (isMidBoss) {
        // 1B_Enemy01 ~ 08
        const type = Math.ceil(Math.random() * 8);
        e.style.backgroundImage = `url('${castleId}B_Enemy0${type}.png')`;
        e.style.width = "90px"; e.style.height = "90px";
        e.hp = 3; e.w = 90; e.h = 90;
     } else {
        // 1enemy1 ~ 5
        const type = Math.ceil(Math.random() * 5);
        e.style.backgroundImage = `url('${castleId}enemy${type}.png')`;
        e.hp = 1; e.w = 60; e.h = 60;
     }
     
     e.x = window.innerWidth + 50;
     e.y = Math.random() * (window.innerHeight - 150) + 50;
     e.style.left = e.x + "px";
     e.style.top = (window.innerHeight - e.y - e.h) + "px"; // CSS top ê³„ì‚°
     e.speed = 200 + (distance * 0.01); // ê°ˆìˆ˜ë¡ ë¹¨ë¼ì§

     document.getElementById("gameArea").appendChild(e);
     enemies.push(e);
  }

  // ====================================================
  // 6. ë³´ìŠ¤ì „ ë° ìŠ¤í‚¬ êµ¬í˜„ (í•µì‹¬!)
  // ====================================================
  function startBossBattle() {
     isBossBattle = true;
     // ë³´ìŠ¤ ìŠ¤íƒ¯ ì„¤ì •
     boss.hp = 50 + (castleId * 5); // ë’·ë²ˆí˜¸ ì„±ì¼ìˆ˜ë¡ ì²´ë ¥ ë†’ìŒ
     boss.maxHp = boss.hp;
     updateBossHp();

     const container = document.getElementById("bossContainer");
     const body = document.getElementById("bossBody");
     
     // F_boss{id}.png ì‚¬ìš©
     body.style.backgroundImage = `url('F_boss${castleId}.png')`;
     
     container.style.display = "block";
     document.getElementById("bossWarning").style.display = "block";
     setTimeout(() => document.getElementById("bossWarning").style.display = "none", 3000);
     
     // ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
     setTimeout(() => container.style.right = "20px", 100);
     
     // ì¡ëª¹ ì œê±°
     enemies.forEach(e => e.remove()); enemies = [];
     obstacles.forEach(o => o.remove()); obstacles = [];
  }

  function updateBoss(dt) {
     if(boss.hp <= 0) return;

     // ê¸°ë³¸ ì›€ì§ì„: ìœ„ì•„ë˜ ë‘¥ë‘¥ (CSS animationìœ¼ë¡œ ì²˜ë¦¬ë¨)
     // ë³´ìŠ¤ ìŠ¤í‚¬ íƒ€ì´ë¨¸
     boss.skillTimer += dt;
     
     // 3ì´ˆë§ˆë‹¤ ìŠ¤í‚¬ ì‚¬ìš©
     if(boss.skillTimer > 3.0) {
        useBossSkill();
        boss.skillTimer = 0;
     }
  }

  function useBossSkill() {
     // ì„± ID(1~12)ì— ë”°ë¥¸ ìŠ¤í‚¬ ë¶„ê¸°
     switch(castleId) {
        case 1: // ì–¼ìŒ (Ice Shard)
           spawnProjectile("proj-ice", 0, 0, -400, 0); // ì§ì‚¬
           spawnProjectile("proj-ice", 0, 50, -350, -50); // ìœ„ìª½ ëŒ€ê°
           document.getElementById("gameArea").classList.add("effect-ice");
           setTimeout(()=>document.getElementById("gameArea").classList.remove("effect-ice"), 500);
           break;
        
        case 2: // ë¶ˆ (Rapid Fire)
           for(let i=0; i<3; i++) {
              setTimeout(() => spawnProjectile("proj-fire", 0, Math.random()*200-100, -500, 0), i*200);
           }
           break;
           
        case 3: // ë‚˜ë¬´ (Root Obstacle - ë°”ë‹¥ ì¥ì• ë¬¼ ì†Œí™˜)
           const root = document.createElement("div");
           root.className = "obstacle";
           root.style.width = "40px"; root.style.height = "100px"; root.style.backgroundColor = "#5d4037"; // ë‚˜ë¬´ìƒ‰
           root.x = window.innerWidth; root.h = 100;
           root.style.left = root.x + "px"; root.style.bottom = "0px";
           document.getElementById("gameArea").appendChild(root);
           obstacles.push(root); // ì¥ì• ë¬¼ ë°°ì—´ì— ë„£ì–´ í”Œë ˆì´ì–´ìª½ìœ¼ë¡œ ì˜¤ê²Œ í•¨
           break;
           
        case 4: // ì‚¬ë§‰ (Sandstorm - í™”ë©´ íë¦¼)
           document.getElementById("gameArea").classList.add("effect-sand");
           setTimeout(()=>document.getElementById("gameArea").classList.remove("effect-sand"), 2000); // 2ì´ˆ ì§€ì†
           spawnProjectile("boss-missile", 0, 0, -300, 0);
           break;
           
        case 5: // ë¬¼ (Wave - ë„“ì€ íˆ¬ì‚¬ì²´)
           const wave = spawnProjectile("boss-missile", 0, 0, -250, 0);
           wave.style.height = "100px"; // ì„¸ë¡œë¡œ ê¸¸ê²Œ
           wave.style.borderRadius = "10px";
           document.getElementById("gameArea").classList.add("effect-water");
           setTimeout(()=>document.getElementById("gameArea").classList.remove("effect-water"), 500);
           break;
           
        case 6: // ì–´ë‘  (Darkness - ì‹œì•¼ ì°¨ë‹¨)
           document.getElementById("gameArea").classList.add("effect-darkness");
           setTimeout(()=>document.getElementById("gameArea").classList.remove("effect-darkness"), 2500);
           spawnProjectile("proj-dark", 0, 0, -400, 0);
           break;
           
        case 7: // ëŒ (Falling Rock - ìœ„ì—ì„œ ë–¨ì–´ì§)
           const rock = document.createElement("div");
           rock.className = "projectile proj-stone";
           rock.x = playerObj.x; // í”Œë ˆì´ì–´ ë¨¸ë¦¬ ìœ„
           rock.y = window.innerHeight;
           rock.vx = 0; rock.vy = -400; // ì•„ë˜ë¡œ ë–¨ì–´ì§
           rock.style.left = rock.x + "px"; rock.style.bottom = rock.y + "px";
           document.getElementById("gameArea").appendChild(rock);
           projectiles.push(rock);
           break;
           
        case 8: // ê³µê°„ (Teleport - ë³´ìŠ¤ ìœ„ì¹˜ ë³€ê²½)
           const container = document.getElementById("bossContainer");
           container.style.top = (20 + Math.random() * 60) + "%"; // 20~80% ì‚¬ì´ ëœë¤ ì´ë™
           spawnProjectile("boss-missile", 0, 0, -400, 0);
           break;
           
        case 9: // ë°©ì–´ (Shield - íˆ¬ì‚¬ì²´ ë§‰ê¸°?) 
           // ì—¬ê¸°ì„  ê·¸ëƒ¥ íƒ„ë§‰ì„ ë§ì´ ë¿Œë¦¬ëŠ” ê±¸ë¡œ êµ¬í˜„ (ë°©ì–´ ëŒ€ì‹  ê³µê²©ìœ¼ë¡œ ì••ë°•)
           spawnProjectile("boss-missile", 0, 100, -300, 0);
           spawnProjectile("boss-missile", 0, -100, -300, 0);
           break;
           
        case 10: // ê²€ (Slash - ë¹ ë¥¸ ìˆ˜í‰ ë² ê¸°)
           const slash = spawnProjectile("boss-missile", 0, 0, -800, 0); // ë§¤ìš° ë¹ ë¦„
           slash.style.width = "100px"; slash.style.height = "10px"; // ê°€ë¡œë¡œ ê¹€
           break;
           
        case 11: // ë„¤í¬ë¡œë§¨ì„œ (Summon Minion)
           spawnEnemy(); // ì¡ëª¹ í•˜ë‚˜ ì†Œí™˜
           break;
           
        case 12: // ë¹› (Blind - í™”ë©´ í•˜ì–—ê²Œ)
           const flash = document.getElementById("flashEffect");
           flash.style.opacity = 1;
           setTimeout(()=>flash.style.opacity=0, 1000);
           spawnProjectile("proj-light", 0, 0, -350, 0);
           break;
           
        default: // ê¸°ë³¸
           spawnProjectile("boss-missile", 0, 0, -300, 0);
     }
  }

  function spawnProjectile(cls, offX, offY, vx, vy) {
     const p = document.createElement("div");
     p.className = "projectile " + cls;
     // ë³´ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€ ë°œì‚¬
     const bRect = document.getElementById("bossContainer").getBoundingClientRect();
     p.x = bRect.left + offX;
     p.y = (window.innerHeight - bRect.bottom) + 75 + offY; // ëŒ€ëµ ì¤‘ì•™
     p.vx = vx; p.vy = vy;
     
     p.style.left = p.x + "px";
     p.style.bottom = p.y + "px";
     
     document.getElementById("gameArea").appendChild(p);
     projectiles.push(p);
     return p;
  }

  // ====================================================
  // 7. í”Œë ˆì´ì–´ ì¡°ì‘ ë° ê³µí†µ í•¨ìˆ˜
  // ====================================================
  function jump() {
    if(velocity === 0 && playerObj.y <= 0) { // ë°”ë‹¥ì— ìˆì„ ë•Œë§Œ ì í”„
       velocity = jumpPower;
       playSound('jump');
    }
  }

  function handleAttack(e) {
    if(e) e.stopPropagation();
    // ì¿¨íƒ€ì„ ë¡œì§ ê°„ë‹¨ êµ¬í˜„
    if(document.getElementById("subActionBtn").style.opacity === "0.5") return;
    
    // í”Œë ˆì´ì–´ ë¯¸ì‚¬ì¼ ë°œì‚¬
    const m = document.createElement("div");
    m.className = "player-missile";
    m.x = playerObj.x + 50; m.y = playerObj.y + 20;
    m.style.left = m.x + "px"; m.style.bottom = m.y + "px"; // CSS top/bottom í†µì¼ í•„ìš”. ì—¬ê¸°ì„  bottom ë¬¼ë¦¬ ì‚¬ìš©
    document.getElementById("gameArea").appendChild(m);
    playerMissiles.push(m);
    
    // ë²„íŠ¼ ì¿¨íƒ€ì„ UI
    const btn = document.getElementById("subActionBtn");
    btn.style.opacity = "0.5";
    setTimeout(() => btn.style.opacity = "1", 500); // 0.5ì´ˆ ì¿¨íƒ€ì„
  }

  function damageLife() {
    // ë¬´ì  ì‹œê°„ ë“± ë¡œì§ ìƒëµ (ìˆœìˆ˜í•˜ê²Œ í”¼ê²©)
    life--;
    document.getElementById("lifeText").innerText = life;
    
    const flash = document.getElementById("flashEffect");
    flash.style.background = "red"; flash.style.opacity = 0.5;
    setTimeout(()=> { flash.style.opacity = 0; flash.style.background="white"; }, 200);
    
    if(life <= 0) gameOver();
  }

  function checkCollision(r1, r2) {
     // r1: player (bottom ê¸°ì¤€ y), r2: enemy (top ê¸°ì¤€ yì¼ìˆ˜ë„ ìˆìŒ -> ë³€í™˜ í•„ìš”)
     // ì—¬ê¸°ì„œëŠ” ëª¨ë“  ì—”í‹°í‹°ì˜ x, y, w, hë¥¼ í†µì¼í•´ì„œ ì“´ë‹¤ê³  ê°€ì •
     // ë‹¤ë§Œ enemies ë“±ì€ top ê¸°ì¤€ìœ¼ë¡œ ê·¸ë ¤ì¡Œìœ¼ë¯€ë¡œ, yê°’ì„ ë°”ë‹¥ ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜í•´ì•¼ í•¨
     // ê°„ë‹¨íˆ íˆíŠ¸ë°•ìŠ¤ ì¤‘ì‹¬ ê±°ë¦¬ë¡œ ì²´í¬
     const c1 = { x: r1.x + 30, y: r1.y + 30 }; // í”Œë ˆì´ì–´ ì¤‘ì‹¬
     
     // ì  yì¢Œí‘œê°€ top ê¸°ì¤€ì´ë¼ë©´: (windowHeight - top - h)
     let y2 = r2.y; 
     if(r2.y > 1000) {/* ë­”ê°€ ì˜ëª»ë¨ */} // ê·¸ëƒ¥ í™”ë©´ìƒ ì¢Œí‘œ(left, top)ì„ getBoundingClientRectë¡œ ë¹„êµí•˜ëŠ”ê²Œ ì œì¼ ì •í™•í•¨
     
     // ê°„ë‹¨ ì¶©ëŒ: xì¶•ì´ ê²¹ì¹˜ê³  yì¶•ì´ ë¹„ìŠ·í•˜ë©´
     return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && Math.abs(r1.y - (window.innerHeight - parseFloat(document.getElementById("gameArea").style.height || 0) - r2.y)) < 60); 
     // -> ìœ„ ë°©ì‹ì€ ë³µì¡í•˜ë‹ˆ, DOM rect ì¶©ëŒë¡œ ëŒ€ì²´
  }
  
  // DOM Rect ê¸°ë°˜ ì¶©ëŒ ê°ì§€ (ê°€ì¥ í™•ì‹¤)
  function checkCollision(objA, rectB) { 
     // objAëŠ” ë°ì´í„° ê°ì²´, rectBëŠ” x,y,w,h ë°ì´í„°.
     // í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” DOM ìš”ì†Œë¼ë¦¬ ë¹„êµí•˜ëŠ”ê²Œ ì•„ë‹˜ (ë°ì´í„° ê¸°ë°˜ ì´ë™ì´ë¯€ë¡œ)
     // ê°„ë‹¨ ê±°ë¦¬ë²• ì‚¬ìš©
     const dist = Math.hypot((playerObj.x+30) - (rectB.x+rectB.w/2), (playerObj.y+30) - (rectB.y)); // rectB.yëŠ” ì ì˜ ê²½ìš° 'í™”ë©´ ìœ„ì—ì„œë¶€í„°'ì¼ ìˆ˜ ìˆìŒ.
     // ì  ìƒì„± ì‹œ e.yëŠ” 'í™”ë©´ ìœ„ì—ì„œë¶€í„°'ë¡œ ì„¤ì •í–ˆìŒ. playerObj.yëŠ” 'ë°”ë‹¥ì—ì„œë¶€í„°'.
     
     // ë³€í™˜: ì ì˜ ë°”ë‹¥ ë†’ì´
     // e.style.top = (winH - e.y - e.h) ... ì•„ê¹Œ spawnEnemyì—ì„œ e.yë¥¼ ëœë¤(50~...)ìœ¼ë¡œ ì¡ê³  topì„ ì„¤ì •í•¨.
     // ì‚¬ì‹¤ìƒ e.yëŠ” 'ë°”ë‹¥ì—ì„œ ë–¨ì–´ì§„ ë†’ì´'ë¡œ ì˜ë„í–ˆìŒ (spawnEnemy ì½”ë“œ ì°¸ì¡°)
     
     // ë”°ë¼ì„œ ë‘˜ë‹¤ 'ë°”ë‹¥ ë†’ì´' ê¸°ì¤€ì´ë¼ë©´:
     return (playerObj.x < rectB.x + rectB.w && playerObj.x + playerObj.w > rectB.x &&
             Math.abs(playerObj.y - rectB.y) < 50);
  }

  function gameOver() {
    running = false;
    document.getElementById("resultTitle").innerText = "íŒ¨ë°°...";
    document.getElementById("resultDesc").innerText = `${Math.floor(distance)}m ì´ë™ í›„ ì „ì‚¬`;
    document.getElementById("resultModal").style.display = "flex";
  }

  function gameClear() {
    running = false;
    document.getElementById("resultTitle").innerText = "ìŠ¹ë¦¬! ğŸ‰";
    document.getElementById("resultDesc").innerText = `${CASTLE_NAMES[castleId]}ì„(ë¥¼) ì ë ¹í–ˆìŠµë‹ˆë‹¤!`;
    document.getElementById("resultModal").style.display = "flex";
    
    // ì ë ¹ ì •ë³´ ì „ì†¡ ë¡œì§ì€ ì—¬ê¸°ì„œ í˜¸ì¶œ (ê¸°ì¡´ ì½”ë“œ ì°¸ê³ )
    sendConquerData();
  }

  function sendConquerData() {
     // GASë¡œ ì ë ¹ ì •ë³´ ì „ì†¡
     fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        redirect: "follow",
        body: JSON.stringify({
           type: "conquerCastle",
           castleId: castleId,
           userId: localStorage.getItem("run_id"),
           userName: localStorage.getItem("run_name"),
           skin: mySkin,
           stats: { hp: life }
        })
     });
  }

  function updateBossHp() {
     const p = (boss.hp / boss.maxHp) * 100;
     document.getElementById("bossHpFill").style.width = p + "%";
  }

  function spawnExplosion(x, y) {
     const ex = document.createElement('div');
     ex.className = 'obstacle-explosion';
     ex.style.left = x + 'px'; ex.style.bottom = y + 'px';
     document.getElementById("gameArea").appendChild(ex);
     setTimeout(()=>ex.remove(), 400);
  }

  function playSound(type) { /* íš¨ê³¼ìŒ ë¡œì§ (íŒŒì¼ í•„ìš”) */ }

  // ì…ë ¥ ë¦¬ìŠ¤ë„ˆ
  document.addEventListener("keydown", e => { if(e.code==="Space") jump(); if(e.code==="KeyA") handleAttack(); });
  document.addEventListener("touchstart", e => { 
     if(!e.target.closest("#subActionBtn")) jump(); 
  }, {passive:false});
  document.addEventListener("mousedown", e => { 
     if(!e.target.closest("#subActionBtn")) jump(); 
  });

</script>
</body>
</html>