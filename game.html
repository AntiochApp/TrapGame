<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Disciple Run ‚Äì Game</title>

<style>
  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #dce7f3;
    font-family: "Pretendard", sans-serif;
  }

  #gameArea {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: linear-gradient(#a8d0f0, #f2f9ff);
  }

  #player {
    position: absolute;
    left: 120px;
    bottom: 40px;
    width: 55px;
    height: 55px;
    background: url('disciple.png') center/contain no-repeat;
    transition: opacity 0.2s;
  }

  .obstacle {
    position: absolute;
    width: 60px;
    background: #8c6239;
  }

  #hud {
    position: absolute;
    top: 10px; left: 10px;
    color: #333;
    font-size: 22px;
    font-weight: 600;
  }

  #quizModal,
  #gameOverModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.55);
    justify-content: center;
    align-items: center;
  }

  .modal-box {
    width: 90%;
    max-width: 380px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }

  .quizBtn {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    background: #6a4a2b;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    font-size: 15px;
  }
</style>
</head>

<body>

<div id="gameArea">
  <div id="player"></div>

  <div id="hud">
    ‚ù§Ô∏è <span id="lifeText"></span><br>
    üìè <span id="distanceText">0m</span><br>
    ‚úù Faith: <span id="faithText"></span>
  </div>
</div>

<!-- QUIZ MODAL -->
<div id="quizModal">
  <div class="modal-box">
    <h2>ÏÑ±Í≤Ω ÌÄ¥Ï¶à</h2>
    <p id="quizQuestion"></p>
    <button class="quizBtn" onclick="answerQuiz('A')" id="btnA"></button>
    <button class="quizBtn" onclick="answerQuiz('B')" id="btnB"></button>
    <button class="quizBtn" onclick="answerQuiz('C')" id="btnC"></button>
  </div>
</div>

<!-- GAME OVER MODAL -->
<div id="gameOverModal">
  <div class="modal-box">
    <h2>GAME OVER</h2>
    <p><b><span id="finalDist"></span>m</b> Îã¨Î†∏ÏäµÎãàÎã§!</p>

    <input id="rankMsg" type="text" placeholder="Î∞©Î™ÖÎ°ù(ÏΩîÎ©òÌä∏)" style="width:100%; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #ccc;">

    <button class="quizBtn" onclick="saveRanking()">Îû≠ÌÇπ Îì±Î°ù</button>
    <button class="quizBtn" onclick="goMenu()">Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  // -------------------- Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨ --------------------
  const id = localStorage.getItem("run_id");
  const name = localStorage.getItem("run_name");

  if (!id) {
    alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
    window.location.href = "index.html";
  }

  // -------------------- Ï†ÑÏó≠ Î≥ÄÏàò --------------------
  let saveData = {};
  let life = 3;
  let faith = 0;
  let jumpPower = 8;

  let playerY = 40;
  let velocity = 0;
  let gravity = -0.4;

  let distance = 0;
  let gameSpeed = 4;
  let lastQuizPoint = 0;

  let obstacles = [];
  let running = false;
  let invincible = false;

  const gameArea = document.getElementById("gameArea");
  const player = document.getElementById("player");

  // -------------------- ÏÑúÎ≤ÑÏóêÏÑú ÏµúÏã† Ï†ÄÏû• Î∂àÎü¨Ïò§Í∏∞ --------------------
  async function loadSaveData() {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "getSaveData", id })
    });

    const txt = await res.text();
    if (txt !== "fail") {
      saveData = JSON.parse(txt);
      localStorage.setItem("run_save", txt);
    }

    startGameInit();
  }

  // -------------------- Î∂àÎü¨Ïò® Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Îä•Î†•Ïπò Ï†ÅÏö© --------------------
  function startGameInit() {
    life = 3 + (saveData.extraLife || 0);
    faith = saveData.faith || 0;
    jumpPower = 8 + (saveData.agility || 0);

    document.getElementById("lifeText").innerText = life;
    document.getElementById("faithText").innerText = faith;

    running = true;
    requestAnimationFrame(gameLoop);
  }

  loadSaveData();

  // -------------------- Ï†êÌîÑ --------------------
  function jump() {
    if (!running) return;
    velocity = jumpPower;
  }

  document.body.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      jump();
    }
  });

  document.body.addEventListener("touchstart", jump);

  // -------------------- Ïû•Ïï†Î¨º ÏÉùÏÑ± --------------------
  function spawnObstacle() {
    if (!running) return;

    const topHeight = Math.random() * 200 + 80;
    const gap = 160;

    const topObs = document.createElement("div");
    topObs.classList.add("obstacle");
    topObs.style.height = topHeight + "px";
    topObs.style.left = "100vw";
    topObs.style.top = "0";
    gameArea.appendChild(topObs);

    const bottomObs = document.createElement("div");
    bottomObs.classList.add("obstacle");
    bottomObs.style.height = (window.innerHeight - topHeight - gap) + "px";
    bottomObs.style.left = "100vw";
    bottomObs.style.bottom = "0";
    gameArea.appendChild(bottomObs);

    obstacles.push(topObs, bottomObs);
  }

  setInterval(spawnObstacle, 1800);

  // -------------------- Í≤åÏûÑ Î£®ÌîÑ --------------------
  function gameLoop() {
    if (!running) return;

    distance += 0.016 * 60;
    document.getElementById("distanceText").innerText = Math.floor(distance) + "m";

    if (Math.floor(distance / 50) > Math.floor(lastQuizPoint / 50)) {
      lastQuizPoint = distance;
      gameSpeed += 0.4;
      pauseForQuiz();
    }

    velocity += gravity;
    playerY += velocity;

    if (playerY < 0) playerY = 0;
    if (playerY > window.innerHeight - 80) playerY = window.innerHeight - 80;

    player.style.bottom = playerY + "px";

    obstacles.forEach(obs => {
      const left = parseFloat(obs.style.left);
      obs.style.left = (left - gameSpeed) + "px";

      if (left + 60 < 0) obs.remove();

      const rectP = player.getBoundingClientRect();
      const rectO = obs.getBoundingClientRect();

      if (!invincible &&
          rectP.left < rectO.right &&
          rectP.right > rectO.left &&
          rectP.top < rectO.bottom &&
          rectP.bottom > rectO.top) {
        damageLife();
      }
    });

    requestAnimationFrame(gameLoop);
  }

  // -------------------- ÏÉùÎ™Ö Í∞êÏÜå --------------------
  function damageLife() {
    if (invincible || !running) return;

    life--;
    document.getElementById("lifeText").innerText = life;

    invincible = true;
    player.style.opacity = "0.4";

    setTimeout(() => {
      invincible = false;
      player.style.opacity = "1";
    }, 800);

    if (life <= 0) gameOver();
  }

  // -------------------- ÌÄ¥Ï¶à --------------------
  async function pauseForQuiz() {
    running = false;

    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "getQuiz" })
    });

    const txt = await res.text();
    if (txt === "noquiz") {
      running = true;
      requestAnimationFrame(gameLoop);
      return;
    }

    const quiz = JSON.parse(txt);

    document.getElementById("quizQuestion").innerText = quiz.question;
    document.getElementById("btnA").innerText = "A) " + quiz.A;
    document.getElementById("btnB").innerText = "B) " + quiz.B;
    document.getElementById("btnC").innerText = "C) " + quiz.C;

    window.correctAnswer = quiz.answer;

    document.getElementById("quizModal").style.display = "flex";
  }

  function answerQuiz(sel) {
    document.getElementById("quizModal").style.display = "none";

    if (sel === window.correctAnswer) {
      faith++;
      saveData.faith = faith;
      document.getElementById("faithText").innerText = faith;
      saveProgress();
    } else {
      damageLife();
    }

    if (life > 0) {
      running = true;
      requestAnimationFrame(gameLoop);
    }
  }

  // -------------------- Ï†ÄÏû• --------------------
  async function saveProgress() {
    try {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "save", id, saveData })
      });
    } catch (e) {}

    localStorage.setItem("run_save", JSON.stringify(saveData));
  }

  // -------------------- Í≤åÏûÑ Ïò§Î≤Ñ --------------------
  function gameOver() {
    running = false;
    invincible = true;
    player.style.opacity = "0.4";

    document.getElementById("finalDist").innerText = Math.floor(distance);
    document.getElementById("gameOverModal").style.display = "flex";
  }

  // -------------------- Îû≠ÌÇπ Ï†ÄÏû• --------------------
  async function saveRanking() {
    const message = document.getElementById("rankMsg").value.trim();
    const dist = Math.floor(distance);

    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        type: "updateRanking",
        id, name,
        distance: dist,
        message
      })
    });

    alert("Îû≠ÌÇπ Îì±Î°ù ÏôÑÎ£å!");
    window.location.href = "menu.html";
  }

  function goMenu() {
    window.location.href = "menu.html";
  }

</script>

</body>
</html>
