<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Disciple Run â€“ Game</title>

<style>
  :root {
    --hud-bg: rgba(255, 248, 235, 0.9);
    --hud-border: #3a2513;
    --accent: #c47a3f;
    --accent-dark: #8b4f26;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  }

  #gameArea {
    position: relative;
    z-index: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background:
      linear-gradient(#88c6ff 0%, #b7e3ff 45%, #f7f0d9 45%, #f0e0b0 100%);
  }

  /* ---------------- íŒ¨ëŸ´ë™ìŠ¤ ë°°ê²½ ë ˆì´ì–´ ---------------- */
  #bgLayer1, #bgLayer2, #bgLayer3 {
    position: absolute;
    left: 0;
    top: 0;
    width: 300%;
    height: 100%;
    image-rendering: pixelated;
    pointer-events: none;
    background-repeat: repeat-x;
    background-position: 0 0;
  }

  #bgLayer1 {
    background-image: url('https://antiochapp.github.io/TrapGame/bg_sky.png');
    z-index: 1;
  }

  #bgLayer2 {
    background-image: url('https://antiochapp.github.io/TrapGame/bg_mountain.png');
    z-index: 2;
  }

  #bgLayer3 {
    background-image: url('https://antiochapp.github.io/TrapGame/bg_forest.png');
    z-index: 3;
  }

  /* í”½ì…€ íƒ€ì¼ ë°”ë‹¥ */
  #ground {
    position: absolute;
    z-index: 5;
    left: 0;
    bottom: 0;
    width: 200%;
    height: 80px;
    background-image: linear-gradient(90deg, #d9b178 0 16px, #c09054 16px 32px);
    image-rendering: pixelated;
    animation: groundMove 0.6s linear infinite;
    display: none;
  }

  @keyframes groundMove {
    from { transform: translateX(0); }
    to   { transform: translateX(-32px); }
  }

  #player {
    position: absolute;
    z-index: 6;
    left: 120px;
    bottom: 40px;
    width: 60px;
    height: 60px;
    background: url('disciple.png') center/contain no-repeat;
    image-rendering: pixelated;
    transition: opacity 0.2s;
  }

  .obstacle {
    position: absolute;
    z-index: 4;
    width: 60px;
    background: #8c6239;
    image-rendering: pixelated;
  }

  #hud {
    position: absolute;
    top: 12px; left: 12px;
    color: #3a2513;
    font-size: 18px;
    font-weight: 700;
    background: var(--hud-bg);
    border-radius: 10px;
    padding: 8px 12px;
    border: 3px solid var(--hud-border);
  }

  #hud span {
    display: inline-block;
    min-width: 60px;
  }

  .modal-box {
    width: 100%;
    max-width: 380px;
    background: #fffdf2;
    padding: 22px 20px 18px;
    border-radius: 12px;
    text-align: center;
    border: 4px solid #3a2513;
    box-shadow: 0 0 0 4px #fff, 0 8px 0 #b79b76;
  }

  #quizModal,
  #gameOverModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.55);
    justify-content: center;
    align-items: center;
    padding: 16px;
  }

  /* ëœë¤ ì•„ì´í…œ */
  .item {
    position: absolute;
    width: 48px;
    height: 48px;
    image-rendering: pixelated;
  }

  /* COMBO ì´í™íŠ¸ */
  #comboEffect {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 40px;
    font-weight: 900;
    color: #ffe24f;
    text-shadow: 3px 3px #8b4f26;
    display: none;
    z-index: 9999;
  }

  /* ì •ë‹µ ì´í™íŠ¸ */
  #correctEffect {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 48px;
    font-weight: 900;
    color: #00ffcc;
    text-shadow: 3px 3px #006644;
    display: none;
    z-index: 9999;
  }

</style>
</head>

<body>
  
<div id="gameArea">

  <!-- START GUIDE MODAL -->
  <div id="startGuide" style="
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.55);
    display:flex; justify-content:center; align-items:center;
    padding:16px; z-index:9999;">
    <div class="modal-box" style="max-width:420px;">
      <h2>ê²Œì„ ë°©ë²• / How to Play</h2>
      <p style="text-align:left; font-size:15px; line-height:1.5;">
        â€¢ <b>Space</b> ë˜ëŠ” í™”ë©´ í„°ì¹˜ë¡œ ì í”„<br>
        â€¢ ì¥ì• ë¬¼ì„ í”¼í•´ <b>ì‹ ì•™ ì ìˆ˜(Faith)</b> íšë“<br>
        â€¢ ìƒì ì—ì„œ ë¯¼ì²©/ìƒëª…ë ¥/ëœë¤ ë½‘ê¸° êµí™˜<br>
        â€¢ <b>ë¯¼ì²©:</b> ì í”„ë ¥ ë‚®ì•„ì§(ì •êµí•œ ì»¨íŠ¸ë¡¤)<br>
        â€¢ <b>ìƒëª…ë ¥:</b> ì¶”ê°€ ë¼ì´í”„<br>
        â€¢ <b>ëœë¤ë½‘ê¸°:</b> ê¸°í”„íŠ¸ì¹´ë“œ ë‹¹ì²¨ ê°€ëŠ¥<br><br>

        â€¢ Tap screen / press <b>Space</b> to jump<br>
        â€¢ Avoid obstacles â†’ Get Faith<br>
        â€¢ Buy Agility/Life/Loot in Shop<br>
        â€¢ <b>Agility:</b> Lower jump = finer control<br>
        â€¢ <b>Life:</b> Extra HP<br>
      </p>

      <button class="quizBtn" onclick="startGameNow()" style="margin-top:12px;">
        â–¶ ì‹œì‘í•˜ê¸° / Start
      </button>
    </div>
  </div>

  <!-- íŒ¨ëŸ´ë™ìŠ¤ ë°°ê²½ -->
  <div id="bgLayer1"></div>
  <div id="bgLayer2"></div>
  <div id="bgLayer3"></div>

  <div id="ground"></div>
  <div id="player"></div>

  <div id="hud">
    â¤ï¸ <span id="lifeText"></span>
    ğŸ“ <span id="distanceText">0m</span>
    âœ <span id="faithText"></span>
  </div>
</div>

<div id="comboEffect">COMBO +1!</div>
<div id="correctEffect">+5 Faith!</div>

<!-- QUIZ MODAL -->
<div id="quizModal">
  <div class="modal-box">
    <h2>ì„±ê²½ í€´ì¦ˆ</h2>
    <p id="quizQuestion"></p>
    <button class="quizBtn" onclick="answerQuiz('A')" id="btnA"></button>
    <button class="quizBtn" onclick="answerQuiz('B')" id="btnB"></button>
    <button class="quizBtn" onclick="answerQuiz('C')" id="btnC"></button>
  </div>
</div>

<!-- GAME OVER MODAL -->
<div id="gameOverModal">
  <div class="modal-box">
    <h2>GAME OVER</h2>
    <p><b><span id="finalDist"></span>m</b> ë‹¬ë ¸ìŠµë‹ˆë‹¤!</p>

    <input id="rankMsg" type="text" placeholder="ë°©ëª…ë¡(ì½”ë©˜íŠ¸)"
      style="width:100%; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #ccc;">

    <button class="quizBtn" onclick="saveRanking()">ë­í‚¹ ë“±ë¡</button>
    <button class="quizBtn" onclick="goMenu()">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>
</div>

<!-- LOADING MODAL -->
<div id="loadingQuiz" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); justify-content:center; align-items:center;
  color:white; font-size:22px; font-weight:700; backdrop-filter: blur(2px);
  z-index: 9999;">
  â³ ì„±ê²½ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
</div>

<script>
/* ------------------------- API -------------------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

/* ----------------------- ì €ì¥ì •ë³´ ------------------------ */
let id = localStorage.getItem("run_id");
let name = localStorage.getItem("run_name");
let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");

if (!id) {
  alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
  window.location.href = "/TrapGame/index.html";
}

/* ---------------------- ë°ì¼ë¦¬ ë¯¸ì…˜ ------------------------ */
let daily = JSON.parse(localStorage.getItem("dailyMission") || "{}");

function initDailyMission() {
  return {
    date: new Date().toDateString(),
    run200: false,
    quiz3: 0,
    faith20: 0
  };
}

if (!daily.date || daily.date !== new Date().toDateString()) {
  daily = initDailyMission();
  localStorage.setItem("dailyMission", JSON.stringify(daily));
}

/* ------------------------ ê¸°ë³¸ ë³€ìˆ˜ ------------------------ */
let life = 3 + (saveData.extraLife || 0);
let faith = saveData.faith || 0;

document.getElementById("lifeText").innerText = life;
document.getElementById("faithText").innerText = faith;

const gameArea = document.getElementById("gameArea");
const player = document.getElementById("player");
const bg1 = document.getElementById("bgLayer1");
const bg2 = document.getElementById("bgLayer2");
const bg3 = document.getElementById("bgLayer3");

let playerY = 40;
let velocity = 0;
let gravity = -0.4;
let agility = saveData.agility || 0;

let jumpPower = 8 - agility * 0.05;
jumpPower = Math.max(3, jumpPower);

let distance = 0;
let obstacles = [];
let running = false;
let invincible = false;

const BASE_SPEED = 200;
let gameSpeed = BASE_SPEED;

let lastTime = performance.now();
let quizTimer = 0;
let nextFaithMilestone = 100;

let obstacleTimer = 0;
let nextObstacleTime = 1.6;

/* -------------------- ëœë¤ ì•„ì´í…œ -------------------- */
let items = [];
let itemTimer = 0;
let nextItemTime = 8;

/* -------------------- ì½¤ë³´ ì‹œìŠ¤í…œ -------------------- */
let combo = 0;
let obstacleSurviveCount = 0;

/* -------------------- ë‚œì´ë„ ì‹œìŠ¤í…œ -------------------- */
function getDifficulty(dist) {
  if (dist < 150) return 1;
  if (dist < 300) return 2;
  return 3;
}

function randBetween(min, max) {
  return Math.random() * (max - min) + min;
}

/* ---------------------- jump ----------------------- */
function jump() {
  if (!running) return;
  velocity = jumpPower;
}

document.body.addEventListener("keydown", (e) => {
  if (e.code === "Space" || e.code === "ArrowUp") {
    e.preventDefault();
    jump();
  }
});

document.body.addEventListener("touchstart", jump);

/* -------------------- ì¥ì• ë¬¼ ë°œìƒ -------------------- */
function scheduleNextObstacle() {
  const d = getDifficulty(distance);
  if (d === 1) nextObstacleTime = randBetween(1.5, 2.2);
  else if (d === 2) nextObstacleTime = randBetween(1.2, 1.8);
  else nextObstacleTime = randBetween(0.9, 1.4);
}

function spawnObstacle() {
  if (!running) return;
  const difficulty = getDifficulty(distance);

  const randi = (min, max) => Math.floor(Math.random() * (max - min)) + min;
  let pattern;

  if (difficulty === 1) {
    const easy = [
      { top: randi(80, 160), gap: 190 },
      { top: randi(110, 190), gap: 180 },
      { groundBox: true, height: 70 }
    ];
    pattern = easy[randi(0, easy.length)];
  } else if (difficulty === 2) {
    const normal = [
      { top: randi(130, 240), gap: 150 },
      { top: randi(150, 260), gap: 140 },
      { groundBox: true, height: 90 }
    ];
    pattern = normal[randi(0, normal.length)];
  } else {
    const hard = [
      { top: randi(180, 320), gap: 120 },
      { top: randi(200, 340), gap: 110 },
      { top: randi(60, 140), gap: randi(110, 130) },
      { groundBox: true, height: randi(90, 120) }
    ];
    pattern = hard[randi(0, hard.length)];
  }

  const screenH = window.innerHeight;
  const startX = window.innerWidth + 80;

  if (pattern.groundBox) {
    const box = document.createElement("div");
    box.classList.add("obstacle");
    box.style.height = pattern.height + "px";
    box.style.width = "60px";
    box.style.left = startX + "px";
    box.style.bottom = "0";
    gameArea.appendChild(box);
    obstacles.push(box);
    return;
  }

  const topHeight = pattern.top;
  const gap = pattern.gap;
  const bottomHeight = Math.max(60, screenH - topHeight - gap);

  const topObs = document.createElement("div");
  topObs.classList.add("obstacle");
  topObs.style.height = topHeight + "px";
  topObs.style.left = startX + "px";
  topObs.style.top = "0";
  gameArea.appendChild(topObs);

  const bottomObs = document.createElement("div");
  bottomObs.classList.add("obstacle");
  bottomObs.style.height = bottomHeight + "px";
  bottomObs.style.left = startX + "px";
  bottomObs.style.bottom = "0";
  gameArea.appendChild(bottomObs);

  obstacles.push(topObs, bottomObs);
}

/* ---------------------- ëœë¤ ì•„ì´í…œ ---------------------- */
function spawnItem() {
  const types = ["cross", "wings", "wind", "bible"];
  const type = types[Math.floor(Math.random() * types.length)];

  const item = document.createElement("div");
  item.classList.add("item");
  item.dataset.type = type;
  item.style.left = window.innerWidth + "px";
  item.style.bottom = (Math.random() * 250 + 100) + "px";

  // ì„ì‹œ ì•„ì´í…œ ì´ë¯¸ì§€ ê²½ë¡œ (ì›í•˜ë©´ ë°”ê¿”ë„ ë¨)
  item.style.background = `url('https://antiochapp.github.io/TrapGame/item_${type}.png') center/contain no-repeat`;

  gameArea.appendChild(item);
  items.push(item);
}

/* ----------- ì•„ì´í…œ íš¨ê³¼ ----------- */
function activateItem(type) {
  if (type === "cross") {
    invincible = true;
    setTimeout(() => invincible = false, 10000);
  }
  if (type === "wings") {
    jumpPower /= 2;
    setTimeout(() => jumpPower *= 2, 10000);
  }
  if (type === "wind") {
    gameSpeed /= 2;
    setTimeout(() => gameSpeed *= 2, 10000);
  }
  if (type === "bible") {
    faith += 10;
    saveData.faith = faith;
    document.getElementById("faithText").innerText = faith;
    saveProgress();
  }
}

/* ------------------- ë©”ì¸ ë£¨í”„ ------------------- */
function gameLoop(now) {
  if (!running) return;

  const delta = (now - lastTime) / 1000;
  lastTime = now;

  /* ë°ì¼ë¦¬ ë¯¸ì…˜ ì²´í¬ */
  if (!daily.run200 && distance >= 200) {
    daily.run200 = true;
  }
  daily.faith20 = faith;
  localStorage.setItem("dailyMission", JSON.stringify(daily));

  /* ê±°ë¦¬ ì¦ê°€ */
  distance += delta * 1;
  document.getElementById("distanceText").innerText = Math.floor(distance) + "m";

  /* ë‚œì´ë„ë³„ ì†ë„ */
  const diff = getDifficulty(distance);
  gameSpeed = BASE_SPEED * (1 + (diff - 1) * 0.25);

  /* 100më§ˆë‹¤ Faith +1 */
  if (distance >= nextFaithMilestone) {
    faith++;
    saveData.faith = faith;
    nextFaithMilestone += 100;
    document.getElementById("faithText").innerText = faith;
    saveProgress();
  }

  /* í€´ì¦ˆ íƒ€ì´ë¨¸ */
  quizTimer += delta;
  const quizSoon = (quizTimer >= 27 && quizTimer < 30);

  /* ì¥ì• ë¬¼ ìƒì„± */
  if (!quizSoon) {
    obstacleTimer += delta;
    if (obstacleTimer >= nextObstacleTime) {
      spawnObstacle();
      obstacleTimer = 0;
      scheduleNextObstacle();
    }
  }

  /* ì í”„ ë¬¼ë¦¬ */
  velocity += gravity;
  playerY += velocity;

  if (playerY < 0) playerY = 0;
  if (playerY > window.innerHeight - 110)
    playerY = window.innerHeight - 110;

  player.style.bottom = playerY + "px";

  /* ì¥ì• ë¬¼ ì´ë™ + ì¶©ëŒ */
  for (let i = obstacles.length - 1; i >= 0; i--) {
    const obs = obstacles[i];

    let left = parseFloat(obs.style.left) || 0;
    left -= gameSpeed * delta;
    obs.style.left = left + "px";

    if (left + 60 < 0) {
      obs.remove();
      obstacles.splice(i, 1);

      // ì½¤ë³´ ì²˜ë¦¬
      obstacleSurviveCount++;
      if (obstacleSurviveCount >= 5) {
        combo++;
        faith++;
        saveData.faith = faith;

        const ce = document.getElementById("comboEffect");
        ce.style.display = "block";
        ce.innerText = `COMBO +${combo}!`;
        setTimeout(() => ce.style.display = "none", 1000);

        obstacleSurviveCount = 0;
        saveProgress();
      }

      continue;
    }

    const rectP = player.getBoundingClientRect();
    const rectO = obs.getBoundingClientRect();

    if (
      rectP.left < rectO.right &&
      rectP.right > rectO.left &&
      rectP.top < rectO.bottom &&
      rectP.bottom > rectO.top
    ) {
      damageLife();
    }
  }

  /* ì•„ì´í…œ ì´ë™ + ì¶©ëŒ */
  itemTimer += delta;
  if (itemTimer >= nextItemTime) {
    spawnItem();
    nextItemTime = Math.random() * 6 + 6;
    itemTimer = 0;
  }

  for (let i = items.length - 1; i >= 0; i--) {
    let it = items[i];
    let left = parseFloat(it.style.left) || 0;
    left -= gameSpeed * delta;
    it.style.left = left + "px";

    if (left < -60) {
      it.remove();
      items.splice(i, 1);
      continue;
    }

    const rectP = player.getBoundingClientRect();
    const rectI = it.getBoundingClientRect();

    if (
      rectP.left < rectI.right &&
      rectP.right > rectI.left &&
      rectP.top < rectI.bottom &&
      rectP.bottom > rectI.top
    ) {
      activateItem(it.dataset.type);
      it.remove();
      items.splice(i, 1);
      continue;
    }
  }

  /* ë°°ê²½ íŒ¨ëŸ´ë™ìŠ¤ */
  bg1.style.backgroundPosition = `${(now / 50) % 300}px 0`;
  bg2.style.backgroundPosition = `${(now / 30) % 300}px 0`;
  bg3.style.backgroundPosition = `${(now / 20) % 300}px 0`;

  /* í€´ì¦ˆ */
  if (quizTimer >= 30) {
    quizTimer = 0;
    pauseForQuiz();
    return;
  }

  requestAnimationFrame(gameLoop);
}

/* -------------------- ìƒëª… ê°ì†Œ -------------------- */
function damageLife() {
  if (invincible || !running) return;

  life--;
  document.getElementById("lifeText").innerText = life;

  invincible = true;
  player.style.opacity = "0.4";
  setTimeout(() => {
    invincible = false;
    player.style.opacity = "1";
  }, 800);

  if (life <= 0) {
    gameOver();
  }
}

/* -------------------- ì„±ê²½ í€´ì¦ˆ -------------------- */
async function pauseForQuiz() {
  if (!running) return;
  running = false;

  document.getElementById("loadingQuiz").style.display = "flex";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "getQuiz" })
    });

    const txt = await res.text();
    document.getElementById("loadingQuiz").style.display = "none";

    if (txt === "noquiz") {
      running = true;
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
      return;
    }

    const quiz = JSON.parse(txt);
    document.getElementById("quizQuestion").innerText = quiz.question;
    document.getElementById("btnA").innerText = "A) " + quiz.A;
    document.getElementById("btnB").innerText = "B) " + quiz.B;
    document.getElementById("btnC").innerText = "C) " + quiz.C;

    window.correctAnswer = quiz.answer;
    document.getElementById("quizModal").style.display = "flex";
  } catch (err) {
    document.getElementById("loadingQuiz").style.display = "none";
    running = true;
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
  }
}

/* -------------------- ì •ë‹µ ì²˜ë¦¬ -------------------- */
function answerQuiz(sel) {
  document.getElementById("quizModal").style.display = "none";

  if (sel === window.correctAnswer) {
    const ef = document.getElementById("correctEffect");
    ef.style.display = "block";
    setTimeout(() => ef.style.display = "none", 800);

    faith += 5;
    saveData.faith = faith;
    document.getElementById("faithText").innerText = faith;

    daily.quiz3++;
    localStorage.setItem("dailyMission", JSON.stringify(daily));

    saveProgress();
  } else {
    damageLife();
  }

  if (life > 0) {
    running = true;
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
  }
}

/* -------------------- ì €ì¥ -------------------- */
async function saveProgress() {
  try {
    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "save", id, saveData })
    });
  } catch (e) {}
  localStorage.setItem("run_save", JSON.stringify(saveData));
}

/* -------------------- GAME Start -------------------- */
function startGameNow() {
  document.getElementById("startGuide").style.display = "none";
  running = true;
  lastTime = performance.now();
  requestAnimationFrame(gameLoop);
}

/* -------------------- GAME OVER -------------------- */
function gameOver() {
  running = false;
  invincible = true;
  player.style.opacity = "0.4";

  document.getElementById("finalDist").innerText = Math.floor(distance);
  document.getElementById("gameOverModal").style.display = "flex";
}

/* -------------------- ë­í‚¹ ì €ì¥ -------------------- */
async function saveRanking() {
  const msg = document.getElementById("rankMsg").value.trim();
  const dist = Math.floor(distance);

  try {
    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        type: "updateRanking",
        id, name,
        distance: dist,
        message: msg
      })
    });
    alert("ë­í‚¹ ë“±ë¡ ì™„ë£Œ!");
  } catch (e) {}

  window.location.href = "/TrapGame/menu.html";
}

function goMenu() {
  window.location.href = "/TrapGame/menu.html";
}

</script>
</body>
</html>
