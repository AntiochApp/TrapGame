<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Disciple Run â€“ Game</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    :root {
      --hud-bg: rgba(255, 248, 235, 0.9);
      --hud-border: #3a2513;
      --accent: #c47a3f;
      --accent-dark: #8b4f26;
      --panel-bg: #fdfaf2;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
      touch-action: none;
      font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* ------------ ê²Œì„ ì˜ì—­ ------------ */
    #gameArea {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background:
        linear-gradient(#88c6ff 0%, #b7e3ff 45%, #f7f0d9 45%, #f0e0b0 100%);
    }

    /* ------------ íŒ¨ëŸ´ë™ìŠ¤ ë°°ê²½ ------------ */
    #bgLayer1, #bgLayer2, #bgLayer3 {
      position: absolute;
      left: 0;
      top: 0;
      width: 200%;
      height: 100%;
      background-repeat: repeat-x;
      background-position-y: bottom;
      background-size: auto 100%;
      image-rendering: pixelated;
      pointer-events: none;
    }

    #bgLayer1 {
      background-image: url("https://antiochapp.github.io/TrapGame/bg_sky.png");
      z-index: 1;
    }
    #bgLayer2 {
      background-image: url("https://antiochapp.github.io/TrapGame/bg_mountain.png");
      z-index: 2;
    }
    #bgLayer3 {
      background-image: url("https://antiochapp.github.io/TrapGame/bg_forest.png");
      z-index: 3;
      background-position-y: 40px;
    }

    /* ------------ ë°”ë‹¥ ------------ */
    #ground {
      position: absolute;
      z-index: 5;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 100px;
      background-image: linear-gradient(90deg, #d9b178 0 16px, #c09054 16px 32px);
      image-rendering: pixelated;
      animation: groundMove 0.6s linear infinite;
    }
    @keyframes groundMove {
      from { transform: translateX(0); }
      to   { transform: translateX(-32px); }
    }

    /* ------------ í”Œë ˆì´ì–´ ------------ */
    #player {
      position: absolute;
      z-index: 12;
      left: 120px;
      bottom: 40px;
      width: 60px;
      height: 60px;
      background: url("disciple.png") center/contain no-repeat;
      image-rendering: pixelated;
      transition: opacity 0.2s;
    }

    /* ------------ ì¥ì• ë¬¼ ------------ */
    .obstacle {
      position: absolute;
      z-index: 10;
      width: 60px;
      background: #8c6239;
      image-rendering: pixelated;
    }

    /* ------------ HUD ------------ */
    #hud {
      position: absolute;
      z-index: 20;
      top: 12px;
      left: 12px;
      color: #3a2513;
      font-size: 18px;
      font-weight: 700;
      background: var(--hud-bg);
      border-radius: 10px;
      padding: 8px 12px;
      border: 3px solid var(--hud-border);
    }
    #hud span {
      display: inline-block;
      min-width: 60px;
    }

    /* ------------ ëœë¤ ì•„ì´í…œ ------------ */
    .item {
      position: absolute;
      z-index: 11;
      width: 48px;
      height: 48px;
      image-rendering: pixelated;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
    }

    /* ------------ ì½¤ë³´ / ì •ë‹µ ì´í™íŠ¸ ------------ */
    #comboEffect, #correctEffect {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: none;
      pointer-events: none;
    }
    #comboEffect {
      top: 20%;
      font-size: 40px;
      font-weight: 900;
      color: #ffe24f;
      text-shadow: 3px 3px #8b4f26;
    }
    #correctEffect {
      top: 40%;
      font-size: 48px;
      font-weight: 900;
      color: #00ffcc;
      text-shadow: 3px 3px #006644;
    }

    /* ------------ ê³µí†µ ëª¨ë‹¬ ------------ */
    .modal-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 16px;
      z-index: 9999;
    }

    .modal-box {
      width: 90%;
      max-width: 420px;
      background: var(--panel-bg);
      border-radius: 14px;
      border: 4px solid #3a2513;
      padding: 28px 24px;
      box-shadow:
        0 0 0 4px #fff,
        0 10px 0 #b79b76;
      text-align: center;
    }

    .modal-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 18px;
    }

    .modal-desc {
      font-size: 17px;
      margin-bottom: 22px;
      line-height: 1.45;
      white-space: pre-line;
    }

    .choice-btn,
    .action-btn,
    .start-btn {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      background: var(--accent);
      border: 0;
      border-radius: 10px;
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 4px 0 var(--accent-dark);
      cursor: pointer;
    }
    .choice-btn:active,
    .action-btn:active,
    .start-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 var(--accent-dark);
    }

    .modal-input {
      width: 85%;           /* ë°•ìŠ¤ë³´ë‹¤ ì§§ê²Œ 85% */
      max-width: 320px;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #b8a792;
      margin: 8px auto 18px;
      display: block;
    }

    /* ------------ ë¡œë”© ëª¨ë‹¬ ------------ */
    #loadingQuiz {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 22px;
      font-weight: 700;
      backdrop-filter: blur(2px);
      z-index: 9999;
    }
  </style>
</head>

<body>
<div id="gameArea">
  <div id="startGuide" class="modal-bg" style="display:flex;">
    <div class="modal-box">
      <div class="modal-title">ê²Œì„ ë°©ë²• / How to Play</div>
      <div class="modal-desc" style="text-align:left; font-size:15px;">
â€¢ <b>Space</b> ë˜ëŠ” í™”ë©´ í„°ì¹˜ë¡œ ì í”„
â€¢ ì¥ì• ë¬¼ì„ í”¼í•´ <b>ì‹ ì•™ ì ìˆ˜(Faith)</b> íšë“
â€¢ ìƒì ì—ì„œ ë¯¼ì²©/ìƒëª…ë ¥/ëœë¤ ë½‘ê¸° êµí™˜
â€¢ <b>ë¯¼ì²©:</b> ì í”„ë ¥ ë‚®ì•„ì§(ì •êµí•œ ì»¨íŠ¸ë¡¤)
â€¢ <b>ìƒëª…ë ¥:</b> ì¶”ê°€ ë¼ì´í”„
â€¢ <b>ëœë¤ë½‘ê¸°:</b> ê¸°í”„íŠ¸ì¹´ë“œ ë‹¹ì²¨ ê°€ëŠ¥

â€¢ Tap screen / press <b>Space</b> to jump
â€¢ Avoid obstacles â†’ Get Faith
â€¢ Buy Agility/Life/Loot in Shop
â€¢ <b>Agility:</b> Lower jump = finer control
â€¢ <b>Life:</b> Extra HP
      </div>
      <button class="start-btn" onclick="startGameNow()">â–¶ ì‹œì‘í•˜ê¸° / Start</button>
    </div>
  </div>

  <div id="bgLayer1"></div>
  <div id="bgLayer2"></div>
  <div id="bgLayer3"></div>

  <div id="ground"></div>
  <div id="player"></div>

  <div id="hud">
    â¤ï¸ <span id="lifeText"></span>
    ğŸ“ <span id="distanceText">0m</span>
    âœ <span id="faithText"></span>
  </div>
</div>

<div id="comboEffect">COMBO +1!</div>
<div id="correctEffect">+5 Faith!</div>

<div id="quizModal" class="modal-bg">
  <div class="modal-box">
    <div class="modal-title">ì„±ê²½ í€´ì¦ˆ</div>
    <div class="modal-desc" id="quizQuestion"></div>
    <button class="choice-btn" onclick="answerQuiz('A')" id="btnA"></button>
    <button class="choice-btn" onclick="answerQuiz('B')" id="btnB"></button>
    <button class="choice-btn" onclick="answerQuiz('C')" id="btnC"></button>
  </div>
</div>

<div id="gameOverModal" class="modal-bg">
  <div class="modal-box">
    <div class="modal-title">GAME OVER</div>
    <div class="modal-desc">
      <b><span id="finalDist"></span>m</b> ë‹¬ë ¸ìŠµë‹ˆë‹¤!
    </div>

    <input id="rankMsg" class="modal-input"
           type="text" placeholder="ì†Œê° ì…ë ¥(ì„ íƒ)" />

    <button class="action-btn" onclick="confirmRanking()">[ìˆœìœ„ë“±ë¡]</button>
  </div>
</div>

<div id="loadingQuiz">â³ ì„±ê²½ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

<script>
  /* ------------ API URL ------------ */
  const API_URL =
    "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  /* ------------ ë¡œê·¸ì¸ ì²´í¬ ------------ */
  let id = localStorage.getItem("run_id");
  let name = localStorage.getItem("run_name");
  let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");

  if (!id) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "/TrapGame/index.html";
  }

  /* ------------ ë°ì¼ë¦¬ ë¯¸ì…˜ ------------ */
  let daily = JSON.parse(localStorage.getItem("dailyMission") || "{}");
  function initDailyMission() {
    return {
      date: new Date().toDateString(),
      run200: false,
      quiz3: 0,
      faith20: 0
    };
  }
  if (!daily.date || daily.date !== new Date().toDateString()) {
    daily = initDailyMission();
    localStorage.setItem("dailyMission", JSON.stringify(daily));
  }

  /* ------------ ê¸°ë³¸ ë³€ìˆ˜ ------------ */
  let life  = 3 + (saveData.extraLife || 0);
  let faith = saveData.faith || 0;

  document.getElementById("lifeText").innerText  = life;
  document.getElementById("faithText").innerText = faith;

  const gameArea = document.getElementById("gameArea");
  const player   = document.getElementById("player");
  const bg1      = document.getElementById("bgLayer1");
  const bg2      = document.getElementById("bgLayer2");
  const bg3      = document.getElementById("bgLayer3");

  let playerY  = 40;
  let velocity = 0;
  let gravity  = -0.4;

  let agility   = saveData.agility || 0;
  let jumpPower = 8 - agility * 0.05;
  jumpPower     = Math.max(3, jumpPower);

  let distance  = 0;
  let obstacles = [];
  let running   = false;
  let invincible = false;

  const BASE_SPEED = 200;
  let gameSpeed    = BASE_SPEED;

  let lastTime            = performance.now();
  let quizTimer           = 0;
  let nextFaithMilestone  = 100;

  let obstacleTimer   = 0;
  let nextObstacleTime = 1.6;

  let bg1X = 0, bg2X = 0, bg3X = 0;
  const BG1_SPEED = 20;
  const BG2_SPEED = 40;
  const BG3_SPEED = 60;

  /* ëœë¤ ì•„ì´í…œ */
  let items        = [];
  let itemTimer    = 0;
  let nextItemTime = 8;

  /* ì½¤ë³´ */
  let combo = 0;
  let obstacleSurviveCount = 0;

  /* ê²Œì„ ì˜¤ë²„ ì‹œ ì¤‘ë³µ ì €ì¥ ë°©ì§€ */
  let rankingSaved = false;

  /* ------------ ë‚œì´ë„ ------------ */
  function getDifficulty(dist) {
    if (dist < 150) return 1;
    if (dist < 300) return 2;
    return 3;
  }
  function randBetween(min, max) {
    return Math.random() * (max - min) + min;
  }

  /* ------------ ì í”„ ------------ */
  function jump() {
    if (!running) return;
    velocity = jumpPower;
  }
  document.body.addEventListener("keydown", e => {
    if (e.code === "Space" || e.code === "ArrowUp") {
      e.preventDefault();
      jump();
    }
  });
  document.body.addEventListener("touchstart", jump);

  /* ------------ ì¥ì• ë¬¼ íƒ€ì´ë° ------------ */
  function scheduleNextObstacle() {
    const d = getDifficulty(distance);
    if (d === 1) nextObstacleTime = randBetween(1.6, 2.4);
    else if (d === 2) nextObstacleTime = randBetween(1.2, 1.9);
    else nextObstacleTime = randBetween(0.9, 1.5);
  }

  /* ------------ ì¥ì• ë¬¼ ìƒì„± (í˜¼í•© íŒ¨í„´) ------------ */
  function spawnObstacle() {
    if (!running) return;
    const difficulty = getDifficulty(distance);
    const randi = (min, max) => Math.floor(Math.random() * (max - min)) + min;
    let pattern;

    // íŒ¨í„´ 50%: ì§€ìƒ ê¸°ë‘¥, 50%: ìœ„/ì•„ë˜ ê¸°ë‘¥
    const useGroundBox = Math.random() < 0.5;

    if (useGroundBox) {
      // ì§€ìƒ ê¸°ë‘¥
      let minH = difficulty === 1 ? 90 : (difficulty === 2 ? 120 : 150);
      let maxH = difficulty === 1 ? 140 : (difficulty === 2 ? 180 : 220);
      pattern = { groundBox: true, height: randi(minH, maxH) };
    } else {
      // ìœ„/ì•„ë˜ ê¸°ë‘¥
      let topRangeMin, topRangeMax, gapBase, gapVar;
      if (difficulty === 1) {
        topRangeMin = 120; topRangeMax = 220;
        gapBase = 190; gapVar = 25;
      } else if (difficulty === 2) {
        topRangeMin = 150; topRangeMax = 260;
        gapBase = 160; gapVar = 25;
      } else {
        topRangeMin = 180; topRangeMax = 320;
        gapBase = 135; gapVar = 20;
      }
      pattern = {
        groundBox: false,
        top: randi(topRangeMin, topRangeMax),
        gap: randi(gapBase - gapVar, gapBase + gapVar)
      };
    }

    const screenH = window.innerHeight;
    const startX  = window.innerWidth + 80;

    if (pattern.groundBox) {
      const box = document.createElement("div");
      box.classList.add("obstacle");
      box.style.height = pattern.height + "px";
      box.style.left   = startX + "px";
      box.style.bottom = "0";
      gameArea.appendChild(box);
      obstacles.push(box);
      return;
    }

    // ìœ„ì•„ë˜ ê¸°ë‘¥
    const topHeight     = pattern.top;
    const gap           = pattern.gap;
    const bottomHeight = Math.max(80, screenH - topHeight - gap);

    const topObs = document.createElement("div");
    topObs.classList.add("obstacle");
    topObs.style.height = topHeight + "px";
    topObs.style.left   = startX + "px";
    topObs.style.top    = "0";
    gameArea.appendChild(topObs);

    const bottomObs = document.createElement("div");
    bottomObs.classList.add("obstacle");
    bottomObs.style.height = bottomHeight + "px";
    bottomObs.style.left   = startX + "px";
    bottomObs.style.bottom = "0";
    gameArea.appendChild(bottomObs);

    obstacles.push(topObs, bottomObs);
  }

  /* ------------ ëœë¤ ì•„ì´í…œ ìƒì„± ------------ */
  function spawnItem() {
    const types = ["cross", "wings", "wind", "bible"];
    const type  = types[Math.floor(Math.random() * types.length)];

    const item  = document.createElement("div");
    item.classList.add("item");
    item.dataset.type = type;
    item.style.left   = window.innerWidth + "px";
    item.style.bottom = (Math.random() * 250 + 120) + "px";
    item.style.backgroundImage =
      `url('https://antiochapp.github.io/TrapGame/item_${type}.png')`;

    gameArea.appendChild(item);
    items.push(item);
  }

  /* ------------ ì•„ì´í…œ íš¨ê³¼ ------------ */
  function activateItem(type) {
    if (type === "cross") {
      invincible = true;
      setTimeout(() => invincible = false, 10000);
    }
    if (type === "wings") {
      jumpPower /= 2;
      setTimeout(() => jumpPower *= 2, 10000);
    }
    if (type === "wind") {
      gameSpeed /= 2;
      setTimeout(() => gameSpeed *= 2, 10000);
    }
    if (type === "bible") {
      faith += 10;
      saveData.faith = faith;
      document.getElementById("faithText").innerText = faith;
      saveProgress();
    }
  }

  /* ------------ ë©”ì¸ ë£¨í”„ ------------ */
  function gameLoop(now) {
    if (!running) return;

    const delta = (now - lastTime) / 1000;
    lastTime = now;

    // ë°ì¼ë¦¬ ë¯¸ì…˜
    if (!daily.run200 && distance >= 200) daily.run200 = true;
    daily.faith20 = faith;
    localStorage.setItem("dailyMission", JSON.stringify(daily));

    // ê±°ë¦¬ ì¦ê°€
    distance += delta * 1;
    document.getElementById("distanceText").innerText =
      Math.floor(distance) + "m";

    // ë‚œì´ë„ë³„ ì†ë„
    const diff = getDifficulty(distance);
    gameSpeed = BASE_SPEED * (1 + (diff - 1) * 0.25);

    // 100më§ˆë‹¤ Faith +1
    if (distance >= nextFaithMilestone) {
      faith++;
      saveData.faith = faith;
      nextFaithMilestone += 100;
      document.getElementById("faithText").innerText = faith;
      saveProgress();
    }

    // í€´ì¦ˆ íƒ€ì´ë¨¸
    quizTimer += delta;
    const quizSoon = (quizTimer >= 27 && quizTimer < 30);

    // ì¥ì• ë¬¼ ìƒì„±
    if (!quizSoon) {
      obstacleTimer += delta;
      if (obstacleTimer >= nextObstacleTime) {
        spawnObstacle();
        obstacleTimer = 0;
        scheduleNextObstacle();
      }
    }

    // ì í”„ ë¬¼ë¦¬
    velocity += gravity;
    playerY += velocity;

    if (playerY < 0) playerY = 0;
    if (playerY > window.innerHeight - 110)
      playerY = window.innerHeight - 110;

    player.style.bottom = playerY + "px";

    // ì¥ì• ë¬¼ ì´ë™ + ì¶©ëŒ
    for (let i = obstacles.length - 1; i >= 0; i--) {
      const obs  = obstacles[i];
      let left   = parseFloat(obs.style.left) || 0;
      left      -= gameSpeed * delta;
      obs.style.left = left + "px";

      // í™”ë©´ ë°– â†’ ì œê±°
      if (left + 60 < 0) {
        obs.remove();
        obstacles.splice(i, 1);

        obstacleSurviveCount++;
        if (obstacleSurviveCount >= 5) {
          combo++;
          faith++;
          saveData.faith = faith;
          document.getElementById("faithText").innerText = faith;

          const ce = document.getElementById("comboEffect");
          ce.style.display = "block";
          ce.innerText = `COMBO +${combo}!`;
          setTimeout(() => ce.style.display = "none", 1000);

          obstacleSurviveCount = 0;
          saveProgress();
        }
        continue;
      }

      // ì¶©ëŒ ì²´í¬
      const rectP = player.getBoundingClientRect();
      const rectO = obs.getBoundingClientRect();

      if (
        rectP.left < rectO.right &&
        rectP.right > rectO.left &&
        rectP.top < rectO.bottom &&
        rectP.bottom > rectO.top
      ) {
        damageLife();
        // í•œ í”„ë ˆì„ì— ì—¬ëŸ¬ ë²ˆ ê¹ì´ì§€ ì•Šë„ë¡
        break;
      }
    }

    // ì•„ì´í…œ ì´ë™ + ì¶©ëŒ
    itemTimer += delta;
    if (itemTimer >= nextItemTime) {
      spawnItem();
      nextItemTime = Math.random() * 6 + 6;
      itemTimer = 0;
    }

    for (let i = items.length - 1; i >= 0; i--) {
      let it   = items[i];
      let left = parseFloat(it.style.left) || 0;
      left    -= gameSpeed * delta;
      it.style.left = left + "px";

      if (left < -60) {
        it.remove();
        items.splice(i, 1);
        continue;
      }

      const rectP = player.getBoundingClientRect();
      const rectI = it.getBoundingClientRect();

      if (
        rectP.left < rectI.right &&
        rectP.right > rectI.left &&
        rectP.top < rectI.bottom &&
        rectP.bottom > rectI.top
      ) {
        activateItem(it.dataset.type);
        it.remove();
        items.splice(i, 1);
        continue;
      }
    }

    // ë°°ê²½ íŒ¨ëŸ´ë™ìŠ¤
    bg1X = (bg1X - BG1_SPEED * delta) % window.innerWidth;
    bg2X = (bg2X - BG2_SPEED * delta) % window.innerWidth;
    bg3X = (bg3X - BG3_SPEED * delta) % window.innerWidth;

    bg1.style.backgroundPosition = `${bg1X}px 0`;
    bg2.style.backgroundPosition = `${bg2X}px 0`;
    bg3.style.backgroundPosition = `${bg3X}px 0`;

    // í€´ì¦ˆ í˜¸ì¶œ
    if (quizTimer >= 30) {
      quizTimer = 0;
      pauseForQuiz();
      return;
    }

    requestAnimationFrame(gameLoop);
  }

  /* ------------ ë°ë¯¸ì§€ ------------ */
  function damageLife() {
    if (invincible || !running) return;

    life--;
    document.getElementById("lifeText").innerText = life;

    invincible = true;
    player.style.opacity = "0.4";
    setTimeout(() => {
      invincible = false;
      player.style.opacity = "1";
    }, 800);

    if (life <= 0) {
      gameOver();
    }
  }

  /* ------------ ì„±ê²½ í€´ì¦ˆ ------------ */
  async function pauseForQuiz() {
    if (!running) return;
    running = false;

    document.getElementById("loadingQuiz").style.display = "flex";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "getQuiz" })
      });

      const txt = await res.text();
      document.getElementById("loadingQuiz").style.display = "none";

      if (txt === "noquiz") {
        running = true;
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
        return;
      }

      const quiz = JSON.parse(txt);
      document.getElementById("quizQuestion").innerText = quiz.question;
      document.getElementById("btnA").innerText = "A) " + quiz.A;
      document.getElementById("btnB").innerText = "B) " + quiz.B;
      document.getElementById("btnC").innerText = "C) " + quiz.C;

      window.correctAnswer = quiz.answer;
      document.getElementById("quizModal").style.display = "flex";
    } catch (err) {
      document.getElementById("loadingQuiz").style.display = "none";
      running = true;
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
    }
  }

  function answerQuiz(sel) {
    document.getElementById("quizModal").style.display = "none";

    if (sel === window.correctAnswer) {
      const ef = document.getElementById("correctEffect");
      ef.style.display = "block";
      setTimeout(() => (ef.style.display = "none"), 800);

      faith += 5;
      saveData.faith = faith;
      document.getElementById("faithText").innerText = faith;

      daily.quiz3++;
      localStorage.setItem("dailyMission", JSON.stringify(daily));

      saveProgress();
    } else {
      damageLife();
    }

    if (life > 0) {
      running = true;
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
    }
  }

  /* ------------ ì§„í–‰ ìƒí™© ì €ì¥ ------------ */
  async function saveProgress() {
    try {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "save", id, saveData })
      });
    } catch (e) {
      // ë¬´ì‹œ
    }
    localStorage.setItem("run_save", JSON.stringify(saveData));
  }

  /* ------------ ê²Œì„ ì‹œì‘ ------------ */
  function startGameNow() {
    document.getElementById("startGuide").style.display = "none";
    running = true;
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
  }

  /* ------------ ê²Œì„ ì˜¤ë²„ ------------ */
  async function gameOver() {
    if (rankingSaved) return; // ì¤‘ë³µ ë°©ì§€

    running = false;
    invincible = true;
    player.style.opacity = "0.4";

    const dist = Math.floor(distance);
    document.getElementById("finalDist").innerText = dist;
    document.getElementById("gameOverModal").style.display = "flex";

    // ê¸°ë¡ ìë™ ë­í‚¹ ì €ì¥ (ì½”ë©˜íŠ¸ëŠ” ë‚˜ì¤‘ì—)
    try {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          type: "updateRanking",
          id,
          name,
          distance: dist,
          message: ""
        })
      });
    } catch (e) {
      // ì‹¤íŒ¨í•´ë„ ì¼ë‹¨ ê³„ì† ì§„í–‰
    }
    rankingSaved = true;
  }

  /* ------------ ì½”ë©˜íŠ¸ ì €ì¥ í›„ ë©”ë‰´ë¡œ ------------ */
  async function confirmRanking() {
    const msg = document.getElementById("rankMsg").value.trim();

    if (msg) {
      try {
        await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            type: "updateComment",
            id,
            message: msg
          })
        });
      } catch (e) {
        // ì‹¤íŒ¨í•´ë„ ì¼ë‹¨ ë©”ë‰´ ì´ë™
      }
    }
    window.location.href = "/TrapGame/menu.html";
  }

  function goMenu() {
    window.location.href = "/TrapGame/menu.html";
  }

  // ëª¨ë°”ì¼ ë”ë¸”íƒ­ í™•ëŒ€ ë°©ì§€
  let lastTouch = 0;
  document.addEventListener(
    "touchend",
    e => {
      const now = Date.now();
      if (now - lastTouch < 300) {
        e.preventDefault();
      }
      lastTouch = now;
    },
    { passive: false }
  );
</script>
</body>
</html>
