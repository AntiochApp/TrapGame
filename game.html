<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Disciple Run â€“ Boss Battle</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    /* ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) ... */
    :root {
      --hud-bg: rgba(255, 248, 235, 0.9);
      --hud-border: #3a2513;
      --accent: #c47a3f;
      --accent-dark: #8b4f26;
      --panel-bg: #fdfaf2;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; overscroll-behavior: none; touch-action: none;
      font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #gameArea {
      position: relative; width: 100vw; height: 100vh; overflow: hidden;
      background: linear-gradient(#88c6ff 0%, #b7e3ff 45%, #f7f0d9 45%, #f0e0b0 100%);
    }

    /* ë°°ê²½ */
    #bgLayer1, #bgLayer2, #bgLayer3 {
      position: absolute; left: 0; top: 0; width: 200%; height: 100%;
      background-repeat: repeat-x; image-rendering: pixelated; pointer-events: none;
      will-change: background-position;
    }
    #bgLayer1 { background-image: url("https://antiochapp.github.io/TrapGame/bg_sky.png"); z-index: 1; background-size: auto 100%; background-position: 0 bottom; }
    #bgLayer2 { background-image: url("https://antiochapp.github.io/TrapGame/bg_mountain.png"); z-index: 2; background-size: auto 100%; background-position: 0 bottom; }
    #bgLayer3 { background-image: url("https://antiochapp.github.io/TrapGame/bg_forest.png"); z-index: 3; background-size: auto 60%; background-position: 0 bottom; }

    #ground { display: none; }

    #player {
      position: absolute; z-index: 50; 
      left: 120px; bottom: 40px; 
      width: 60px; height: 60px;
      background-image: url("disciple.png");
      background-position: center; background-size: contain; background-repeat: no-repeat;
      image-rendering: pixelated;
      transition: opacity 0.2s, filter 0.3s; 
      filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.2)); 
    }

    /* ì¥ì• ë¬¼ ë° ì•„ì´í…œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
    .obstacle { position: absolute; z-index: 40; background-size: 8px 8px; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); }
    .obs-cap::after { content: ''; position: absolute; left: -10%; width: 120%; height: 24px; box-sizing: border-box; border-radius: 4px; }
    .obs-ground.obs-cap::after { top: -12px; }
    .obs-ceil.obs-cap::after { bottom: -12px; }
    .obs-log { width: 60px; background-color: #8D6E63; border-left: 4px solid #5D4037; border-right: 4px solid #5D4037; background-image: linear-gradient(90deg, rgba(0,0,0,0.05) 50%, transparent 50%), linear-gradient(rgba(0,0,0,0.05) 50%, transparent 50%); }
    .obs-log.obs-cap::after { background-color: #66BB6A; border: 4px solid #1B5E20; background-image: linear-gradient(45deg, transparent 80%, rgba(255,255,255,0.3) 80%); }
    .obs-rock { width: 60px; background-color: #9E9E9E; border-left: 4px solid #616161; border-right: 4px solid #616161; background-image: radial-gradient(circle, rgba(0,0,0,0.1) 20%, transparent 20%), radial-gradient(circle, rgba(255,255,255,0.1) 20%, transparent 20%); background-size: 16px 16px; }
    .obs-rock.obs-cap::after { background-color: #BDBDBD; border: 4px solid #424242; }
    .obs-long { width: 240px; height: 35px; background-color: #5D4037; background-image: linear-gradient(0deg, rgba(0,0,0,0.2) 50%, transparent 50%); background-size: 100% 10px; border: 3px solid #3E2723; border-radius: 8px; box-shadow: 0 5px 5px rgba(0,0,0,0.3); }
    
    .item { position: absolute; z-index: 45; width: 48px; height: 48px; image-rendering: pixelated; background-position: center; background-repeat: no-repeat; background-size: contain; animation: itemFloat 1.5s ease-in-out infinite alternate; }
    @keyframes itemFloat { from { transform: translateY(0); } to { transform: translateY(-8px); } }

    /* íˆ¬ì‚¬ì²´ (ìš´ì„, ë¯¸ì‚¬ì¼, ë³´ìŠ¤ ë¯¸ì‚¬ì¼ ê³µí†µ) */
    .projectile { 
      position: absolute; z-index: 60; width: 40px; height: 40px; 
      border-radius: 50%; 
      background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff5722); 
      box-shadow: 0 0 10px #ff9800; 
      animation: spinMeteor 1s linear infinite; 
    }
    .projectile::before { 
      content: ''; position: absolute; top: -30px; right: -30px; width: 80px; height: 80px; 
      background: linear-gradient(45deg, transparent 60%, rgba(255,87,34,0.8)); 
      transform: rotate(45deg); z-index: -1; border-radius: 50%; filter: blur(4px); 
    }
    .missile-style { filter: hue-rotate(220deg) brightness(1.2); } /* íŒŒë€ìƒ‰ */
    .boss-missile { filter: hue-rotate(290deg) brightness(0.8); } /* ë³´ë¼ìƒ‰ (ë³´ìŠ¤ìš©) */
    .reflected-missile { filter: hue-rotate(90deg) brightness(1.5); box-shadow: 0 0 15px #00ff00; } /* ì´ˆë¡ìƒ‰ (ë°˜ì‚¬ë¨) */

    @keyframes spinMeteor { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* UI ìš”ì†Œë“¤ */
    #hud { position: fixed; z-index: 900; top: 12px; left: 12px; color: #3a2513; font-size: 18px; font-weight: 700; background: var(--hud-bg); border-radius: 10px; padding: 8px 12px; border: 3px solid var(--hud-border); }
    #hud span { display: inline-block; min-width: 60px; }
    #buffArea { position: fixed; z-index: 2147483647; bottom: 20px; right: 15px; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 8px; pointer-events: none; transform: translateZ(0); }
    .buff-tag { background: rgba(0, 0, 0, 0.85); color: #fff; padding: 8px 14px; border-radius: 8px; font-size: 16px; font-weight: 700; box-shadow: 0 4px 8px rgba(0,0,0,0.5); border-left: 5px solid; }

    #abilityBtn {
      position: fixed; bottom: 20px; right: 20px; width: 80px; height: 80px;
      background: #ff5722; color: white; border-radius: 50%; border: 4px solid #fff;
      font-weight: bold; font-size: 24px; display: none;
      justify-content: center; align-items: center; cursor: pointer; z-index: 1000;
      box-shadow: 0 6px 12px rgba(0,0,0,0.6); user-select: none;
      flex-direction: column; text-align: center; line-height: 1.1;
    }
    #abilityBtn.cooldown { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; background: #555; }
    #abilityBtn span { font-size: 12px; display: block; margin-top: 2px; }

    /* [ì‹ ê·œ] ë°©íŒ¨(íŒ¨ë§) ë²„íŠ¼ */
    #shieldBtn {
      position: fixed; bottom: 20px; left: 20px; width: 90px; height: 90px;
      background: #2196F3; color: white; border-radius: 50%; border: 4px solid #fff;
      font-weight: bold; font-size: 16px; display: none; /* ë³´ìŠ¤ì „ì—ì„œë§Œ ë“±ì¥ */
      justify-content: center; align-items: center; cursor: pointer; z-index: 1000;
      box-shadow: 0 6px 12px rgba(0,0,0,0.6); user-select: none;
      text-align: center;
    }
    #shieldBtn:active { transform: scale(0.95); background: #1976D2; }
    #shieldBtn.cooldown { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }

    /* [ì‹ ê·œ] ë³´ìŠ¤ ìŠ¤íƒ€ì¼ */
    #bossContainer {
      position: absolute; right: -200px; top: 50%; width: 120px; height: 120px;
      z-index: 55; display: none; transition: right 1s ease-out;
    }
    #bossBody {
      width: 100%; height: 100%;
      background: url('https://cdn-icons-png.flaticon.com/512/477/477464.png') no-repeat center/contain; /* ì„ì‹œ ë³´ìŠ¤ ì´ë¯¸ì§€ (ì•…ë§ˆ ì•„ì´ì½˜) */
      filter: drop-shadow(0 0 10px red);
      animation: bossFloat 2s ease-in-out infinite;
    }
    @keyframes bossFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    
    #bossHpBar {
      position: absolute; top: -20px; left: 0; width: 100%; height: 10px;
      background: #333; border: 2px solid #000; border-radius: 5px; overflow: hidden;
    }
    #bossHpFill { width: 100%; height: 100%; background: #d32f2f; transition: width 0.2s; }

    /* ê²½ê³  ë©”ì‹œì§€ */
    #bossWarning {
      position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
      font-size: 50px; font-weight: 900; color: #d32f2f; text-shadow: 3px 3px 0 #000;
      display: none; z-index: 2000; animation: blink 0.5s infinite; pointer-events: none;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    /* ì´í™íŠ¸ */
    #speedLines { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 80; background: radial-gradient(circle, transparent 40%, rgba(255, 255, 255, 0.8) 90%); mix-blend-mode: overlay; pointer-events: none; animation: speedShake 0.1s infinite; }
    @keyframes speedShake { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }
    .float-text { position: absolute; color: #ffe24f; font-weight: 900; font-size: 20px; text-shadow: 2px 2px 0 #3a2513; z-index: 1000; pointer-events: none; animation: floatUp 1s ease-out forwards; }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }
    #comboEffect, #correctEffect { position: fixed; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; pointer-events: none; }
    #comboEffect { top: 20%; font-size: 40px; font-weight: 900; color: #ffe24f; text-shadow: 3px 3px #8b4f26; }
    #correctEffect { top: 40%; font-size: 48px; font-weight: 900; color: #00ffcc; text-shadow: 3px 3px #006644; }

    /* ëª¨ë‹¬ */
    .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.55); display: none; justify-content: center; align-items: center; padding: 16px; z-index: 20000; }
    .modal-box { width: 90%; max-width: 420px; background: var(--panel-bg); border-radius: 14px; border: 4px solid #3a2513; padding: 28px 24px; box-shadow: 0 0 0 4px #fff, 0 10px 0 #b79b76; text-align: center; }
    .modal-title { font-size: 28px; font-weight: 800; margin-bottom: 18px; }
    .modal-desc { font-size: 17px; margin-bottom: 22px; line-height: 1.45; white-space: pre-line; }
    .choice-btn, .action-btn, .start-btn { width: 100%; padding: 14px; margin: 8px 0; background: var(--accent); border: 0; border-radius: 10px; color: #fff; font-size: 18px; font-weight: 700; box-shadow: 0 4px 0 var(--accent-dark); cursor: pointer; }
    .choice-btn:active, .action-btn:active, .start-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--accent-dark); }
    .action-btn:disabled { background: #999; cursor: not-allowed; box-shadow: none; }
    .modal-input { width: 85%; max-width: 320px; padding: 12px; font-size: 16px; border-radius: 8px; border: 2px solid #b8a792; margin: 8px auto 18px; display: block; }
    #loadingQuiz { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; color: #fff; font-size: 22px; font-weight: 700; backdrop-filter: blur(2px); z-index: 20001; }
  </style>
</head>

<body>
<div id="gameArea">
  <div id="startGuide" class="modal-bg" style="display:flex;">
    <div class="modal-box">
      <div class="modal-title">ê²Œì„ ë°©ë²• / How to Play</div>
      <div class="modal-desc" style="text-align:left; font-size:15px;">
â€¢ <b>Space</b> / <b>í„°ì¹˜</b>: ì í”„
â€¢ <b>Aí‚¤</b> / <b>ë²„íŠ¼</b>: íŠ¹ìˆ˜ëŠ¥ë ¥
â€¢ <b>ë°©íŒ¨ ë²„íŠ¼</b>: ë³´ìŠ¤ ë¯¸ì‚¬ì¼ ë°˜ì‚¬! (400m ë“±ì¥)

[ì•„ì´í…œ íš¨ê³¼]
âœï¸ <b>ì‹­ìê°€:</b> ë¬´ì 
ğŸ•Šï¸ <b>ë‚ ê°œ:</b> í„°ë³´ ëª¨ë“œ
ğŸƒ <b>ë°”ëŒ:</b> ì†ë„ ê°ì†Œ
ğŸ“˜ <b>ì„±ê²½:</b> Faith +10
      </div>
      <button class="start-btn" onclick="startGameNow()">â–¶ ì‹œì‘í•˜ê¸° / Start</button>
    </div>
  </div>

  <div id="bgLayer1"></div>
  <div id="bgLayer2"></div>
  <div id="bgLayer3"></div>
  <div id="speedLines"></div>
  <div id="ground"></div>
  <div id="player"></div>

  <div id="bossContainer">
    <div id="bossHpBar"><div id="bossHpFill"></div></div>
    <div id="bossBody"></div>
  </div>

  <div id="hud">
    â¤ï¸ <span id="lifeText"></span> 
    ğŸ“ <span id="distanceText">0m</span> 
    âœ <span id="faithText"></span>
  </div>
  
  <div id="abilityBtn" onclick="useAbility()">A<br><span>Ready</span></div>
  <div id="shieldBtn" onclick="useShield()">ğŸ›¡ï¸<br>ë°˜ì‚¬!</div>
</div>

<div id="buffArea"></div>
<div id="bossWarning">âš ï¸ BOSS WARNING!</div>
<div id="comboEffect">COMBO +1!</div>
<div id="correctEffect">+5 Faith!</div>

<div id="quizModal" class="modal-bg">
  <div class="modal-box">
    <div class="modal-title">ì„±ê²½ í€´ì¦ˆ</div>
    <div class="modal-desc" id="quizQuestion"></div>
    <button class="choice-btn" onclick="answerQuiz('A')" id="btnA"></button>
    <button class="choice-btn" onclick="answerQuiz('B')" id="btnB"></button>
    <button class="choice-btn" onclick="answerQuiz('C')" id="btnC"></button>
  </div>
</div>

<div id="gameOverModal" class="modal-bg">
  <div class="modal-box">
    <div class="modal-title">GAME OVER</div>
    <div class="modal-desc">
      <b><span id="finalDist"></span>m</b> ë‹¬ë ¸ìŠµë‹ˆë‹¤!
    </div>
    <input id="rankMsg" class="modal-input" type="text" placeholder="ì†Œê° ì…ë ¥(ì„ íƒ)" />
    <button class="action-btn" style="background:#5d4037;" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œí•˜ê¸°</button>
    <button class="action-btn" onclick="confirmRanking()">[ìˆœìœ„ë“±ë¡]</button>
  </div>
</div>

<div id="loadingQuiz">â³ ì„±ê²½ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  let id = localStorage.getItem("run_id");
  let name = localStorage.getItem("run_name");
  let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");

  if (!id) {
    alert("ë¡œê·¸ì¸ í•„ìš”");
    window.location.href = "/TrapGame/index.html";
  }

  let daily = JSON.parse(localStorage.getItem("dailyMission") || "{}");
  function initDailyMission() {
    return { date: new Date().toDateString(), run200: false, quiz3: 0, faith20: 0 };
  }
  if (!daily.date || daily.date !== new Date().toDateString()) {
    daily = initDailyMission();
    localStorage.setItem("dailyMission", JSON.stringify(daily));
  }

  // --- ë³€ìˆ˜ ì´ˆê¸°í™” ---
  let life  = 3 + (saveData.extraLife || 0);
  let faith = saveData.faith || 0;
  let agility = saveData.agility || 0;
  let lvlInvincible = saveData.up_invincible || 0;
  let lvlTurbo = saveData.up_turbo || 0;
  let lvlSlow = saveData.up_slow || 0;
  let currentSkin = saveData.equippedSkin || "default";

  // ìŠ¤í‚¨ ë°ì´í„°
  const SKIN_DATA = {
    default: { type: "none" },
    noel: { type: "Active", cd: 60, name: "ë…¸ì—˜" },
    jeonchan: { type: "Passive", cd: 40, name: "ì „ì°¬" },
    haeun: { type: "Passive", cd: 30, name: "í•˜ì€" },
    jaeguk: { type: "Active", cd: 120, name: "ì¬êµ­" },
    hahwi: { type: "Passive", cd: 20, name: "í•˜íœ˜" },
    jihye: { type: "Passive", name: "ì§€í˜œ" },
    jun: { type: "Passive", name: "ì¤€" },
    stephanie: { type: "Passive", name: "ìŠ¤í…ŒíŒŒë‹ˆ" },
    yejun: { type: "Active", cd: 180, name: "ì˜ˆì¤€" },
    ganghui: { type: "Passive", cd: 20, name: "ê°•í¬" },
    jieun: { type: "Active", cd: 120, name: "ì§€ì€" }
  };

  const abilityBtn = document.getElementById('abilityBtn');
  if(SKIN_DATA[currentSkin].type === "Active") abilityBtn.style.display = 'flex';

  document.getElementById("lifeText").innerText  = life;
  document.getElementById("faithText").innerText = faith;

  const gameArea = document.getElementById("gameArea");
  const player   = document.getElementById("player");
  const bg1 = document.getElementById("bgLayer1");
  const bg2 = document.getElementById("bgLayer2");
  const bg3 = document.getElementById("bgLayer3");

  if (currentSkin !== 'default') player.style.backgroundImage = `url('skin_${currentSkin}.png')`;
  else player.style.backgroundImage = `url('disciple.png')`;

  let buffArea = document.getElementById("buffArea") || createEl("div", "buffArea", document.body);
  let speedLines = document.getElementById("speedLines") || createEl("div", "speedLines", gameArea, player);

  function createEl(tag, id, parent, before) {
    let el = document.createElement(tag); el.id = id;
    if(before) parent.insertBefore(el, before); else parent.appendChild(el);
    return el;
  }

  let playerY  = 40;
  let velocity = 0;
  let gravity  = -0.25; 
  let jumpPower = 6.5 - agility * 0.05;
  jumpPower = Math.max(3, jumpPower);
  let targetY = 0;

  let distance  = 0;
  let obstacles = [];
  let projectiles = []; 
  let running   = false;
  let invincible = false;

  const BASE_SPEED = 170; 
  let gameSpeed    = BASE_SPEED;
  let lastTime = performance.now();
  let quizTimer = 0;
  let nextFaithMilestone = 100;
  
  let obstacleTimer = 0; let nextObstacleTime = 2.0;
  let meteorTimer = 0; let missileTimer = 0;
  let itemTimer = 0; let nextItemTime = 8;
  let skinTimer = 0; let abilityCD = 0;

  let bg1X = 0, bg2X = 0, bg3X = 0;
  const BG1_SPEED = 20; const BG2_SPEED = 40; const BG3_SPEED = 60;

  let items = [];
  let combo = 0;
  let obstacleSurviveCount = 0;
  let rankingSaved = false;

  let activeEffects = { turbo: 0, invincible: 0, slow: 0, fly: 0, revive: 0, summon: 0 };

  /* ------------ ë³´ìŠ¤ì „ ê´€ë ¨ ë³€ìˆ˜ ------------ */
  let isBossBattle = false;
  let boss = { hp: 6, maxHp: 6, x: 0, y: 50, vy: 2, state: 'idle', shootTimer: 0 };
  let bossContainer = document.getElementById('bossContainer');
  let bossHpFill = document.getElementById('bossHpFill');
  let shieldBtn = document.getElementById('shieldBtn');
  let shieldCooldown = 0;

  function randBetween(min, max) { return Math.random() * (max - min) + min; }

  function jump() {
    if (!running) return;
    if (activeEffects.turbo > 0 || activeEffects.fly > 0) return;
    velocity = jumpPower;
  }
  
  document.body.addEventListener("keydown", e => {
    if (e.code === "Space" || e.code === "ArrowUp") { e.preventDefault(); jump(); }
    if (e.code === "KeyA") useAbility();
    if (e.code === "KeyS" && isBossBattle) useShield(); // Sí‚¤ë¡œë„ íŒ¨ë§ ê°€ëŠ¥
  });
  document.body.addEventListener("touchstart", jump);
  window.addEventListener('mousemove', e => targetY = window.innerHeight - e.clientY);
  window.addEventListener('touchmove', e => targetY = window.innerHeight - e.touches[0].clientY);

  /* íŒ¨ë§(ë°˜ì‚¬) ìŠ¤í‚¬ */
  function useShield() {
    if (!isBossBattle || shieldCooldown > 0) return;
    
    // ì¿¨íƒ€ì„ ì„¤ì • (0.5ì´ˆ)
    shieldCooldown = 0.5;
    shieldBtn.classList.add('cooldown');
    
    // ì£¼ë³€ì˜ ë³´ìŠ¤ ë¯¸ì‚¬ì¼ ì°¾ê¸°
    let reflected = false;
    projectiles.forEach(p => {
        if (p.isBossMissile && !p.isReflected) {
            // ë¯¸ì‚¬ì¼ê³¼ì˜ ê±°ë¦¬ ê³„ì‚°
            // í”Œë ˆì´ì–´ ì¤‘ì‹¬ (150, playerY+30)
            const px = 150; 
            const py = window.innerHeight - playerY - 30;
            const dist = Math.sqrt(Math.pow(p.x - px, 2) + Math.pow(p.y - py, 2));

            // ê±°ë¦¬ 150px ì´ë‚´ë©´ ë°˜ì‚¬ ì„±ê³µ
            if (dist < 150) {
                p.isReflected = true;
                p.classList.remove('boss-missile');
                p.classList.add('reflected-missile');
                
                // ì†ë„ ë°˜ì „ ë° ê°€ì† (ë³´ìŠ¤ì—ê²Œ ë˜ëŒë¦¬ê¸°)
                p.vx = Math.abs(p.vx) * 1.5; 
                p.vy = -p.vy * 0.5; // ì•½ê°„ ìœ ë„ ëŠë‚Œ
                reflected = true;
            }
        }
    });

    if (reflected) showFloatText("âš”ï¸ ë°˜ì‚¬ ì„±ê³µ!");
    else showFloatText("ğŸ›¡ï¸ ë°©ì–´!");
  }

  function useAbility() {
    if(!running || abilityCD > 0) return;
    const s = SKIN_DATA[currentSkin];
    if(currentSkin === 'noel') {
      showFloatText("ğŸŒŠ ê¸¸ ì—´ë¦¼!");
      document.querySelectorAll('.obstacle').forEach(el => {
        if(el.style.bottom === '0px') el.style.bottom = '-150px'; 
        else el.style.top = '-150px';
      });
    } else if(currentSkin === 'jaeguk') {
      activeEffects.revive = 30; showFloatText("ğŸ‘¼ ìë™ ë¶€í™œ On");
    } else if(currentSkin === 'yejun') {
      activeEffects.fly = 30; showFloatText("âœˆï¸ ììœ  ë¹„í–‰");
    } else if(currentSkin === 'jieun') {
      activeEffects.summon = 20; showFloatText("ğŸ›¡ï¸ ë…¸ì—˜ ì†Œí™˜!");
    }
    abilityCD = s.cd;
  }

  function updateBuffUI(delta) {
    // ë²„í”„ ì‹œê°„ ê°ì†Œ
    for(let k in activeEffects) if(activeEffects[k] > 0) activeEffects[k] -= delta;
    if(shieldCooldown > 0) {
        shieldCooldown -= delta;
        if(shieldCooldown <= 0) shieldBtn.classList.remove('cooldown');
    }
    updateAbilityBtn(delta);
  }

  function updateAbilityBtn(dt) {
    if(abilityCD > 0) {
      abilityCD -= dt;
      abilityBtn.classList.add('cooldown');
      abilityBtn.innerHTML = Math.ceil(abilityCD);
    } else {
      abilityBtn.classList.remove('cooldown');
      abilityBtn.innerHTML = "A<br><span>Ready</span>";
    }
  }

  /* ------------ ë©”ì¸ ê²Œì„ ë£¨í”„ ------------ */
  function gameLoop(now) {
    if (!running) return;
    const delta = (now - lastTime) / 1000;
    lastTime = now;

    updateBuffUI(delta);
    
    // ê±°ë¦¬ ë° ì†ë„ ê³„ì‚°
    if (!isBossBattle) { // ë³´ìŠ¤ì „ ì•„ë‹ ë•Œë§Œ ê±°ë¦¬ ì¦ê°€
        let distMultiplier = (activeEffects.turbo > 0) ? 4 : 1;
        distance += delta * 1 * distMultiplier;
        document.getElementById("distanceText").innerText = Math.floor(distance) + "m";
        
        let progress = Math.min(distance / 3000, 1);
        let speedMultiplier = 1 + (progress * 14);
        let currentSpeed = BASE_SPEED * speedMultiplier;
        if (activeEffects.slow > 0) currentSpeed *= 0.5;
        if (activeEffects.turbo > 0) currentSpeed *= 2.0; 
        gameSpeed = currentSpeed;
    } else {
        // ë³´ìŠ¤ì „ì¼ ë•Œ ë°°ê²½ ì²œì²œíˆ ì´ë™
        gameSpeed = BASE_SPEED * 0.5; 
    }

    // ë³´ìŠ¤ì „ íŠ¸ë¦¬ê±° (400m)
    if (!isBossBattle && distance >= 400 && boss.hp > 0) {
        startBossBattle();
    }

    if (isBossBattle) {
        updateBoss(delta);
    } else {
        // ì¼ë°˜ íŒ¨í„´ (ì¥ì• ë¬¼, ìš´ì„, ë¯¸ì‚¬ì¼)
        obstacleTimer += delta;
        if (obstacleTimer >= nextObstacleTime) {
            spawnObstacle(); 
            obstacleTimer = 0; 
            // ì†ë„ì— ë”°ë¼ ì¥ì• ë¬¼ ê°„ê²© ì¡°ì •
            let sm = gameSpeed / BASE_SPEED;
            let baseTime = randBetween(1.8, 2.6);
            nextObstacleTime = baseTime / (1 + (sm - 1) * 0.6); 
            if (nextObstacleTime < 0.2) nextObstacleTime = 0.2;
        }

        // 150m ìš´ì„
        if (distance > 150 && activeEffects.turbo <= 0) {
            meteorTimer += delta;
            if (meteorTimer > 3.0 / (gameSpeed/BASE_SPEED)) {
                spawnMeteor(gameSpeed/BASE_SPEED); meteorTimer = 0;
            }
        }
        // 200m ë¯¸ì‚¬ì¼
        if (distance > 200 && activeEffects.turbo <= 0) {
            missileTimer += delta;
            if (missileTimer > 4.0 / (gameSpeed/BASE_SPEED)) {
                spawnMissile(gameSpeed/BASE_SPEED); missileTimer = 0;
            }
        }
    }

    updatePhysics(delta);
    
    // ë°°ê²½ ì´ë™
    let speedMult = (gameSpeed / BASE_SPEED); 
    bg1X -= BG1_SPEED * speedMult * delta;
    bg2X -= BG2_SPEED * speedMult * delta;
    bg3X -= BG3_SPEED * speedMult * delta;
    bg1.style.backgroundPosition = `${bg1X}px 0`;
    bg2.style.backgroundPosition = `${bg2X}px bottom`;
    bg3.style.backgroundPosition = `${bg3X}px bottom`;

    requestAnimationFrame(gameLoop);
  }

  /* ------------ ë³´ìŠ¤ ë¡œì§ ------------ */
  function startBossBattle() {
    isBossBattle = true;
    showFloatText("âš ï¸ WARNING: BOSS!!");
    const warning = document.getElementById('bossWarning');
    warning.style.display = 'block';
    setTimeout(() => warning.style.display = 'none', 3000);

    // ì¥ì• ë¬¼ í´ë¦¬ì–´
    obstacles.forEach(o => o.remove());
    obstacles = [];
    
    // ë³´ìŠ¤ ë“±ì¥
    bossContainer.style.display = 'block';
    setTimeout(() => { bossContainer.style.right = '20px'; }, 100);
    
    // ë°©íŒ¨ ë²„íŠ¼ í™œì„±í™”
    shieldBtn.style.display = 'flex';
  }

  function updateBoss(delta) {
    if (boss.hp <= 0) return;

    // ë³´ìŠ¤ ìƒí•˜ ì´ë™ (ì‚¬ì¸íŒŒ)
    boss.y += boss.vy;
    if (boss.y > 80 || boss.y < 20) boss.vy *= -1; // í™”ë©´ % ê¸°ì¤€ ëŒ€ëµì  ì´ë™
    bossContainer.style.top = boss.y + "%";

    // ë³´ìŠ¤ ê³µê²© íŒ¨í„´
    boss.shootTimer += delta;
    
    let shootInterval = 2.0; // ê¸°ë³¸ 2ì´ˆ
    let missileCount = 1;
    let missileSpeedMult = 1.0;

    if (boss.hp <= 4) { missileCount = 2; missileSpeedMult = 1.3; }
    if (boss.hp <= 2) { missileCount = 3; missileSpeedMult = 1.7; shootInterval = 1.5; }

    if (boss.shootTimer > shootInterval) {
        bossShoot(missileCount, missileSpeedMult);
        boss.shootTimer = 0;
    }
  }

  function bossShoot(count, speedMult) {
    for(let i=0; i<count; i++) {
        setTimeout(() => {
            const m = document.createElement("div");
            m.classList.add("projectile", "boss-missile");
            
            // ë³´ìŠ¤ ìœ„ì¹˜ì—ì„œ ì‹œì‘
            const rect = bossContainer.getBoundingClientRect();
            const startX = rect.left; 
            const startY = rect.top + 30; // ë³´ìŠ¤ ì¤‘ì•™

            // í”Œë ˆì´ì–´ ì¡°ì¤€
            const pX = 120; 
            const pY = window.innerHeight - playerY - 30;
            const dx = pX - startX;
            const dy = pY - startY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            const speed = 300 * speedMult;
            const vx = (dx / dist) * speed;
            const vy = (dy / dist) * speed;

            m.style.left = startX + "px";
            m.style.top = startY + "px";
            m.x = startX; m.y = startY;
            m.vx = vx; m.vy = vy;
            m.w = 40; m.h = 40;
            m.isBossMissile = true; // íƒœê·¸

            gameArea.appendChild(m);
            projectiles.push(m);
        }, i * 300); // ì—°ë°œ ê°„ê²©
    }
  }

  function damageBoss() {
    boss.hp--;
    // HP Bar Update
    bossHpFill.style.width = (boss.hp / boss.maxHp * 100) + "%";
    showFloatText("ğŸ’¥ ë³´ìŠ¤ íƒ€ê²©!");

    if (boss.hp <= 0) {
        // ë³´ìŠ¤ ì‚¬ë§ ì²˜ë¦¬
        bossContainer.style.transition = "top 1s ease-in";
        bossContainer.style.top = "120%"; // ì¶”ë½
        setTimeout(() => { 
            bossContainer.style.display = 'none'; 
            isBossBattle = false;
            shieldBtn.style.display = 'none';
            faith += 50; // ë³´ìƒ
            showFloatText("ğŸ‰ ë³´ìŠ¤ ì²˜ì¹˜! (+50 Faith)");
        }, 1000);
    }
  }

  /* ------------ ë¬¼ë¦¬ ë° ì¶©ëŒ ------------ */
  function updatePhysics(delta) {
    // í”Œë ˆì´ì–´ ì´ë™
    if (activeEffects.fly > 0) {
      playerY += (targetY - playerY) * 0.1; velocity = 0;
      if(speedLines) speedLines.style.display = "none";
    } else if (activeEffects.turbo > 0) {
      let tY = 200; playerY += (tY - playerY) * 0.1; velocity = 0;
      if(speedLines) speedLines.style.display = "block";
    } else {
      velocity += gravity; playerY += velocity;
      if(speedLines) speedLines.style.display = "none";
    }

    if (playerY < 0) playerY = 0;
    if (playerY > window.innerHeight - 110) playerY = window.innerHeight - 110;
    player.style.bottom = playerY + "px";

    // í”Œë ˆì´ì–´ íˆíŠ¸ë°•ìŠ¤
    const px = 120, py = window.innerHeight - playerY - 60, pw = 60, ph = 60;

    // íˆ¬ì‚¬ì²´ ì´ë™ ë° ì¶©ëŒ
    for (let i = projectiles.length - 1; i >= 0; i--) {
        let p = projectiles[i];
        p.x += p.vx * delta;
        p.y += p.vy * delta;
        p.style.left = p.x + "px";
        p.style.top = p.y + "px";

        // í™”ë©´ ë°– ì œê±°
        if (p.x < -100 || p.x > window.innerWidth + 100 || p.y < -100 || p.y > window.innerHeight + 100) {
            p.remove(); projectiles.splice(i, 1); continue;
        }

        // 1. í”Œë ˆì´ì–´ ì¶©ëŒ (ë³´ìŠ¤ ë¯¸ì‚¬ì¼ or ì¼ë°˜ íˆ¬ì‚¬ì²´)
        // ë‹¨, ë°˜ì‚¬ëœ ë¯¸ì‚¬ì¼ì€ í”Œë ˆì´ì–´ì—ê²Œ í•´ë¥¼ ì…íˆì§€ ì•ŠìŒ
        if (!p.isReflected && !activeEffects.invincible && !invincible && activeEffects.summon <= 0 && activeEffects.turbo <= 0) {
            if (px < p.x + p.w && px + pw > p.x && py < p.y + p.h && py + ph > p.y) {
                damageLife();
                p.remove(); projectiles.splice(i, 1);
                continue;
            }
        }

        // 2. ë³´ìŠ¤ ì¶©ëŒ (ë°˜ì‚¬ëœ ë¯¸ì‚¬ì¼ë§Œ)
        if (isBossBattle && p.isReflected) {
            const bRect = bossContainer.getBoundingClientRect();
            // ë³´ìŠ¤ íˆíŠ¸ë°•ìŠ¤ ê·¼ì‚¬ê°’
            if (p.x > bRect.left && p.x < bRect.right && p.y > bRect.top && p.y < bRect.bottom) {
                damageBoss();
                p.remove(); projectiles.splice(i, 1);
                continue;
            }
        }
    }

    // ì¥ì• ë¬¼ ì´ë™
    for (let i = obstacles.length - 1; i >= 0; i--) {
        let o = obstacles[i];
        let left = parseFloat(o.style.left) || 0;
        left -= gameSpeed * delta;
        o.style.left = left + "px";
        
        let rw = o.offsetWidth || 60;
        if (left + rw < 0) {
            o.remove(); obstacles.splice(i, 1); continue;
        }
        
        // ì¶©ëŒ (getBoundingClientRect ì‚¬ìš©, ì•ˆì „)
        if (!activeEffects.invincible && !invincible && activeEffects.summon <= 0 && activeEffects.turbo <= 0) {
            const rP = player.getBoundingClientRect();
            const rO = o.getBoundingClientRect();
            if (rP.right > rO.left + 10 && rP.left < rO.right - 10 && rP.bottom > rO.top + 10 && rP.top < rO.bottom - 10) {
                damageLife(); break;
            }
        }
    }
  }

  // ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ìŠ¤í°, ë°ë¯¸ì§€ ë“±)
  function spawnMeteor(mult) { /* ... (ì´ì „ ì½”ë“œì™€ ë™ì¼, ì¶©ëŒì€ ìœ„ì—ì„œ í†µí•© ì²˜ë¦¬) ... */ 
    const m = document.createElement("div"); m.classList.add("projectile");
    const sx = window.innerWidth + Math.random()*200; const sy = -100;
    // ì†ë„ ê³„ì‚°
    let s = 150 + (mult * 200);
    m.style.left=sx+"px"; m.style.top=sy+"px";
    m.x=sx; m.y=sy; m.vx=-s*0.8; m.vy=s; m.w=40; m.h=40;
    gameArea.appendChild(m); projectiles.push(m);
  }
  
  function spawnMissile(mult) { 
    const m = document.createElement("div"); m.classList.add("projectile", "missile-style");
    const sx = window.innerWidth+50; const sy = Math.random()*(window.innerHeight-100);
    const px = 150; const py = window.innerHeight - playerY - 30;
    const dx=px-sx; const dy=py-sy; const d=Math.sqrt(dx*dx+dy*dy);
    let s = 250 + (mult * 250);
    m.style.left=sx+"px"; m.style.top=sy+"px";
    m.x=sx; m.y=sy; m.vx=(dx/d)*s; m.vy=(dy/d)*s; m.w=40; m.h=40;
    gameArea.appendChild(m); projectiles.push(m);
  }

  function spawnObstacle() { /* ... (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ) ... */ 
    if(!running || activeEffects.turbo>0) return;
    const randi = (min,max)=>Math.floor(Math.random()*(max-min))+min;
    // ê°€ë¡œ ì¥ì• ë¬¼
    if(distance > 50 && Math.random() < 0.65) {
        let cnt = (Math.random()<0.3)?2:1;
        for(let k=0; k<cnt; k++) {
            const b = document.createElement("div"); b.classList.add("obstacle", "obs-long");
            b.style.left = (window.innerWidth+80)+"px";
            let sh = window.innerHeight;
            if(cnt===2) { if(k===0) b.style.bottom=randBetween(30, sh*0.35)+"px"; else b.style.bottom=randBetween(sh*0.55, sh*0.85)+"px"; }
            else { let r=Math.random(); if(r<0.2) b.style.bottom="0px"; else if(r<0.4) b.style.top="0px"; else b.style.bottom=randBetween(50, sh-120)+"px"; }
            gameArea.appendChild(b); obstacles.push(b);
        }
        return;
    }
    // ì„¸ë¡œ ì¥ì• ë¬¼
    const type = (Math.random()<0.5)?'obs-log':'obs-rock';
    const sx = window.innerWidth+80;
    if(Math.random()<0.5) {
        const b = document.createElement("div"); b.classList.add("obstacle", "obs-cap", "obs-ground", type);
        b.style.height=randi(90,220)+"px"; b.style.left=sx+"px"; b.style.bottom="0";
        gameArea.appendChild(b); obstacles.push(b);
    } else {
        let th=randi(120,260); let gap=randi(160,220); let bh=Math.max(80, window.innerHeight-th-gap);
        const t = document.createElement("div"); t.classList.add("obstacle", "obs-cap", "obs-ceil", type);
        t.style.height=th+"px"; t.style.left=sx+"px"; t.style.top="0";
        const b = document.createElement("div"); b.classList.add("obstacle", "obs-cap", "obs-ground", type);
        b.style.height=bh+"px"; b.style.left=sx+"px"; b.style.bottom="0";
        gameArea.appendChild(t); obstacles.push(t); gameArea.appendChild(b); obstacles.push(b);
    }
  }

  function damageLife() {
    if(activeEffects.revive > 0) { life=3; document.getElementById("lifeText").innerText=life; activeEffects.revive=0; activeEffects.invincible=3; showFloatText("ğŸ‘¼ ë¶€í™œ!"); return; }
    if(activeEffects.turbo>0 || activeEffects.invincible>0 || invincible || !running) return;
    life--; document.getElementById("lifeText").innerText=life;
    invincible=true; player.style.opacity="0.4"; setTimeout(()=>{invincible=false; player.style.opacity="1";},800);
    if(life<=0) gameOver();
  }

  /* ------------ (ë‚˜ë¨¸ì§€ ìœ í‹¸ í•¨ìˆ˜ë“¤: saveProgress, showFloatText ë“± ê¸°ì¡´ ìœ ì§€) ------------ */
  function showFloatText(text) { const r=player.getBoundingClientRect(); const e=document.createElement("div"); e.classList.add("float-text"); e.innerText=text; e.style.left=(r.left+10)+"px"; e.style.top=(r.top-20)+"px"; document.body.appendChild(e); setTimeout(()=>e.remove(),1000); }
  function startGameNow() { document.getElementById("startGuide").style.display="none"; running=true; lastTime=performance.now(); requestAnimationFrame(gameLoop); }
  async function saveProgress() { try{await fetch(API_URL,{method:"POST",body:JSON.stringify({type:"save",id,saveData})});}catch(e){} localStorage.setItem("run_save",JSON.stringify(saveData)); }
  async function gameOver() { if(rankingSaved)return; running=false; invincible=true; player.style.opacity="0.4"; document.getElementById("finalDist").innerText=Math.floor(distance); document.getElementById("gameOverModal").style.display="flex"; try{await fetch(API_URL,{method:"POST",body:JSON.stringify({type:"updateRanking",id,name,distance:Math.floor(distance),message:""})});}catch(e){} rankingSaved=true; }
  async function confirmRanking() { const msg=document.getElementById("rankMsg").value.trim(); try{await fetch(API_URL,{method:"POST",body:JSON.stringify({type:"updateComment",id,message:msg})}); alert("ë“±ë¡ì™„ë£Œ"); window.location.href="/TrapGame/menu.html";}catch(e){alert("ì˜¤ë¥˜"); window.location.href="/TrapGame/menu.html";} }
  
  let lastT=0; document.addEventListener("touchend",e=>{const n=Date.now();if(n-lastT<300)e.preventDefault();lastT=n;},{passive:false});
</script>
</body>
</html>
