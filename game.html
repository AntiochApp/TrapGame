<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Disciple Run â€“ Game</title>

<style>
  :root {
    --hud-bg: rgba(255, 248, 235, 0.9);
    --hud-border: #3a2513;
    --accent: #c47a3f;
    --accent-dark: #8b4f26;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  }

  #gameArea {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background:
      linear-gradient(#88c6ff 0%, #b7e3ff 45%, #f7f0d9 45%, #f0e0b0 100%);
  }

  /* ---------------- íŒ¨ëŸ´ë™ìŠ¤ ë°°ê²½ ë ˆì´ì–´ ---------------- */
  #bgLayer1, #bgLayer2, #bgLayer3 {
    position: absolute;
    left: 0;
    top: 0;
    width: 300%; /* ë°˜ë³µ ìì—°ìŠ¤ëŸ½ê²Œ ë³´ì´ë„ë¡ ë„‰ë„‰íˆ */
    height: 100%;
    image-rendering: pixelated;
    pointer-events: none;
    background-repeat: repeat-x;
    background-position: 0 0;
  }

#bgLayer1 {
      background-image: url('bg_sky.png'); /* í•˜ëŠ˜ */
      z-index: -3;
} 

#bgLayer2 {
       background-image: url('bg_mountain.png'); /* ì‚° (íˆ¬ëª… PNG) */
       z-index: -2;
}

 #bgLayer3 {
        background-image: url('bg_forest.png'); /* ìˆ² (íˆ¬ëª… PNG) */
        z-index: -1;
 }

  /* í”½ì…€ íƒ€ì¼ ë°”ë‹¥ */
  #ground {
    position: absolute;
    left: 0;
    bottom: 0;
    width: 200%;
    height: 80px;
    background-image: linear-gradient(90deg, #d9b178 0 16px, #c09054 16px 32px);
    image-rendering: pixelated;
    animation: groundMove 0.6s linear infinite;
  }

  @keyframes groundMove {
    from { transform: translateX(0); }
    to   { transform: translateX(-32px); }
  }

  #player {
    position: absolute;
    left: 120px;
    bottom: 40px;
    width: 60px;
    height: 60px;
    background: url('disciple.png') center/contain no-repeat;
    image-rendering: pixelated;
    transition: opacity 0.2s;
  }

  .obstacle {
    position: absolute;
    width: 60px;
    background: #8c6239;
    image-rendering: pixelated;
  }

  #hud {
    position: absolute;
    top: 12px; left: 12px;
    color: #3a2513;
    font-size: 18px;
    font-weight: 700;
    background: var(--hud-bg);
    border-radius: 10px;
    padding: 8px 12px;
    border: 3px solid var(--hud-border);
  }

  #hud span {
    display: inline-block;
    min-width: 60px;
  }

  #quizModal,
  #gameOverModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.55);
    justify-content: center;
    align-items: center;
    padding: 16px;
  }

  .modal-box {
    width: 100%;
    max-width: 380px;
    background: #fffdf2;
    padding: 22px 20px 18px;
    border-radius: 12px;
    text-align: center;
    border: 4px solid #3a2513;
    box-shadow:
      0 0 0 4px #fff,
      0 8px 0 #b79b76;
  }

  .modal-box h2 {
    margin-top: 0;
    margin-bottom: 10px;
  }

  .quizBtn {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    background: var(--accent);
    color: white;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    font-size: 15px;
    box-shadow: 0 4px 0 var(--accent-dark);
  }
  .quizBtn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 var(--accent-dark);
  }

  @media (max-width: 600px) {
    #player {
      left: 80px;
    }
    #hud {
      font-size: 16px;
    }
  }
</style>
</head>

<body>
  
<div id="gameArea">

  <!-- START GUIDE MODAL -->
<div id="startGuide" style="
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.55);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:16px;
  z-index:9999;
">
  <div class="modal-box" style="max-width:420px;">
    <h2>ê²Œì„ ë°©ë²• / How to Play</h2>

    <p style="text-align:left; font-size:15px; line-height:1.5;">
      â€¢ <b>Space</b> ë˜ëŠ” í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ì í”„í•©ë‹ˆë‹¤.<br>
      â€¢ ì¥ì• ë¬¼ì„ í”¼í•˜ë©° <b>ì‹ ì•™ ì ìˆ˜(Faith)</b>ë¥¼ íšë“í•˜ì„¸ìš”.<br>
      â€¢ ìƒì ì—ì„œ ë¯¼ì²© / ìƒëª…ë ¥ / ëœë¤ë½‘ê¸° êµí™˜ ê°€ëŠ¥<br>
      â€¢ <b>ë¯¼ì²©</b>: ì í”„ë ¥ì´ ë‚®ì•„ì ¸ ì •êµí•œ ì»¨íŠ¸ë¡¤ ê°€ëŠ¥<br>
      â€¢ <b>ìƒëª…ë ¥</b>: ì—¬ë¶„ì˜ ë¼ì´í”„ë¥¼ íšë“<br>
      â€¢ <b>ëœë¤ë½‘ê¸°</b>: í™•ë¥ ì ìœ¼ë¡œ ìŠ¤íƒ€ë²…ìŠ¤ / ì•„ë§ˆì¡´ ê¸°í”„íŠ¸ì¹´ë“œ ë‹¹ì²¨<br>
      <br>
      â€¢ Tap screen or press <b>Space</b> to jump.<br>
      â€¢ Avoid obstacles to earn <b>Faith Points</b>.<br>
      â€¢ Upgrade Agility / Life / Random Loots in the shop.<br>
      â€¢ <b>Agility</b>: Lower jump = finer control.<br>
      â€¢ <b>Life</b>: Adds extra life slot.<br>
      â€¢ <b>Random Loot</b>: Chance to win Starbucks/Amazon Gift Cards!<br>
    </p>

    <button class="quizBtn" onclick="startGameNow()" style="margin-top:12px;">
      â–¶ ì‹œì‘í•˜ê¸° / Start Game
    </button>
  </div>
</div>
  
  <!-- íŒ¨ëŸ´ë™ìŠ¤ ë°°ê²½ -->
  <div id="bgLayer1"></div>  <!-- í•˜ëŠ˜ -->
  <div id="bgLayer2"></div>  <!-- ì‚° -->
  <div id="bgLayer3"></div>  <!-- ìˆ² -->

  <div id="ground"></div>
  <div id="player"></div>

  <div id="hud">
    â¤ï¸ <span id="lifeText"></span>
    ğŸ“ <span id="distanceText">0m</span>
    âœ <span id="faithText"></span>
  </div>
</div>

<!-- QUIZ MODAL -->
<div id="quizModal">
  <div class="modal-box">
    <h2>ì„±ê²½ í€´ì¦ˆ</h2>
    <p id="quizQuestion"></p>
    <button class="quizBtn" onclick="answerQuiz('A')" id="btnA"></button>
    <button class="quizBtn" onclick="answerQuiz('B')" id="btnB"></button>
    <button class="quizBtn" onclick="answerQuiz('C')" id="btnC"></button>
  </div>
</div>

<!-- GAME OVER MODAL -->
<div id="gameOverModal">
  <div class="modal-box">
    <h2>GAME OVER</h2>
    <p><b><span id="finalDist"></span>m</b> ë‹¬ë ¸ìŠµë‹ˆë‹¤!</p>

    <input id="rankMsg" type="text" placeholder="ë°©ëª…ë¡(ì½”ë©˜íŠ¸)"
      style="width:100%; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #ccc;">

    <button class="quizBtn" onclick="saveRanking()">ë­í‚¹ ë“±ë¡</button>
    <button class="quizBtn" onclick="goMenu()">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>
</div>

  <!-- LOADING MODAL -->
<div id="loadingQuiz" style="
  display:none; 
  position:fixed; 
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  color:white;
  font-size:22px;
  font-weight:700;
  backdrop-filter: blur(2px);
  z-index: 9999;
">
  â³ ì„±ê²½ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
</div>
  
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  // -------------------- ê¸°ë³¸ ì •ë³´ --------------------
  const id   = localStorage.getItem("run_id");
  const name = localStorage.getItem("run_name");
  let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");

  if (!id) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "/TrapGame/index.html";
  }

  let life  = 3 + (saveData.extraLife || 0);
  let faith = saveData.faith || 0;

  document.getElementById("lifeText").innerText  = life;
  document.getElementById("faithText").innerText = faith;

  // -------------------- ê²Œì„ ë³€ìˆ˜ --------------------
  const gameArea = document.getElementById("gameArea");
  const player   = document.getElementById("player");
  const bg1      = document.getElementById("bgLayer1");
  const bg2      = document.getElementById("bgLayer2");
  const bg3      = document.getElementById("bgLayer3");

  let playerY   = 40;
  let velocity  = 0;
  let gravity   = -0.4;                       // ì í”„ ëŠë‚Œì€ ê·¸ëŒ€ë¡œ ìœ ì§€
  let agility = saveData.agility || 0;
let jumpPower = 8 - agility * 0.05;
jumpPower = Math.max(3, jumpPower);

  let distance  = 0;                          // m ë‹¨ìœ„
  let obstacles = [];
  let running   = false;
  let invincible = false;

  // ì¥ì• ë¬¼/ë°°ê²½ ì†ë„
  const BASE_SPEED = 200;                     // ì¥ì• ë¬¼ ì´ë™ ì†ë„(px/ì´ˆ) ì•½ê°„ ëŠë¦¬ê²Œ
  let gameSpeed = BASE_SPEED;

  // ì‹œê°„ ê¸°ë°˜ ë³€ìˆ˜
  let lastTime = performance.now();
  let quizTimer = 0;                          // 30ì´ˆë§ˆë‹¤ í€´ì¦ˆ
  let nextFaithMilestone = 100;               // 100më§ˆë‹¤ Faith +1

  // ì¥ì• ë¬¼ íƒ€ì´ë¨¸ (í”„ë ˆì„ ê¸°ë°˜ ìƒì„±)
  let obstacleTimer = 0;
  let nextObstacleTime = 1.6;                 // ì²« ì¥ì• ë¬¼ ë“±ì¥ê¹Œì§€ ì‹œê°„(ì´ˆ)

  // íŒ¨ëŸ´ë™ìŠ¤ ë°°ê²½ ìœ„ì¹˜
  let bg1X = 0, bg2X = 0, bg3X = 0;
  const BG1_SPEED = 12;                       // ê°€ì¥ ë¨¼ ë°°ê²½
  const BG2_SPEED = 30;                       // ì‚°
  const BG3_SPEED = 70;                       // ìˆ²

  // -------------------- ì…ë ¥ / ì í”„ --------------------
  function jump() {
    if (!running) return;
    velocity = jumpPower;
  }

  document.body.addEventListener("keydown", (e) => {
    if (e.code === "Space" || e.code === "ArrowUp") {
      e.preventDefault();
      jump();
    }
  });

  document.body.addEventListener("touchstart", jump);

  // -------------------- ë‚œì´ë„ ê³„ì‚° --------------------
  function getDifficulty(dist) {
    if (dist < 150) return 1;   // easy
    if (dist < 300) return 2;   // normal
    return 3;                   // hard
  }

  // ë‚œì´ë„ë³„ ì¥ì• ë¬¼ ê°„ê²©(ì´ˆ) ê²°ì •
  function getSpawnInterval() {
    const d = getDifficulty(distance);
    if (d === 1) return randBetween(1.5, 2.2);
    if (d === 2) return randBetween(1.2, 1.8);
    return randBetween(0.9, 1.4);
  }

  function randBetween(min, max) {
    return Math.random() * (max - min) + min;
  }

  function scheduleNextObstacle() {
    nextObstacleTime = getSpawnInterval();
  }

  // -------------------- ì¥ì• ë¬¼ ìƒì„± --------------------
  function spawnObstacle() {
    if (!running) return;

    const difficulty = getDifficulty(distance);
    const randi = (min, max) => Math.floor(Math.random() * (max - min)) + min;

    let pattern;

    if (difficulty === 1) {
      const easy = [
        { top: randi(80, 160), gap: 190 },   // ë„“ì€ ê°­
        { top: randi(110, 190), gap: 180 },
        { groundBox: true, height: 70 }      // ë•…ì— ë°•ìŠ¤ í•˜ë‚˜
      ];
      pattern = easy[randi(0, easy.length)];
    } else if (difficulty === 2) {
      const normal = [
        { top: randi(130, 240), gap: 150 },
        { top: randi(150, 260), gap: 140 },
        { groundBox: true, height: 90 },     // ì¡°ê¸ˆ ë†’ì€ ë•… ë°•ìŠ¤
      ];
      pattern = normal[randi(0, normal.length)];
    } else {
      const hard = [
        { top: randi(180, 320), gap: 120 },
        { top: randi(200, 340), gap: 110 },
        { top: randi(60, 140),  gap: randi(110, 130) },
        { groundBox: true, height: randi(90, 120) }  // ê½¤ ë†’ì€ ë•… ë°•ìŠ¤
      ];
      pattern = hard[randi(0, hard.length)];
    }

    const screenH   = window.innerHeight;
    const startX    = window.innerWidth + 80;  // í™”ë©´ ì˜¤ë¥¸ìª½ ë°–ì—ì„œë¶€í„° ë“±ì¥

    // ë‹¨ì¼ ë°”ë‹¥ ë°•ìŠ¤ íŒ¨í„´
    if (pattern.groundBox) {
      const box = document.createElement("div");
      box.classList.add("obstacle");
      box.style.height = pattern.height + "px";
      box.style.width  = "60px";
      box.style.left   = startX + "px";
      box.style.bottom = "0";
      gameArea.appendChild(box);
      obstacles.push(box);
      return;
    }

    // ìœ„/ì•„ë˜ ê¸°ë‘¥ íŒ¨í„´
    const topHeight    = pattern.top;
    const gap          = pattern.gap;
    const bottomHeight = Math.max(60, screenH - topHeight - gap);

    const topObs = document.createElement("div");
    topObs.classList.add("obstacle");
    topObs.style.height = topHeight + "px";
    topObs.style.left   = startX + "px";
    topObs.style.top    = "0";
    gameArea.appendChild(topObs);

    const bottomObs = document.createElement("div");
    bottomObs.classList.add("obstacle");
    bottomObs.style.height = bottomHeight + "px";
    bottomObs.style.left   = startX + "px";
    bottomObs.style.bottom = "0";
    gameArea.appendChild(bottomObs);

    obstacles.push(topObs, bottomObs);
  }

  // -------------------- ë©”ì¸ ê²Œì„ ë£¨í”„ (ì‹œê°„ ê¸°ë°˜) --------------------
  function gameLoop(now) {
    if (!running) return;

    const delta = (now - lastTime) / 1000;    // ì§€ë‚œ í”„ë ˆì„ì—ì„œ ì§€ë‚œ ì‹œê°„(ì´ˆ)
    lastTime = now;

    // 1) ê±°ë¦¬ ì¦ê°€: 1ì´ˆì— 1m
    distance += delta * 1;
    document.getElementById("distanceText").innerText = Math.floor(distance) + "m";

    // 2) ë‚œì´ë„ì— ë”°ë¼ ì†ë„ ì•½ê°„ ì¦ê°€(ë„ˆë¬´ ì‹¬í•˜ì§€ ì•Šê²Œ)
    const diff = getDifficulty(distance);
    gameSpeed = BASE_SPEED * (1 + (diff - 1) * 0.25); // easy=1.0, normal=1.25, hard=1.5ë°°

    // 3) 100më§ˆë‹¤ Faith +1
    if (distance >= nextFaithMilestone) {
      faith++;
      saveData.faith = faith;
      nextFaithMilestone += 100;
      document.getElementById("faithText").innerText = faith;
      saveProgress();
    }

    // 4) í€´ì¦ˆ íƒ€ì´ë¨¸ (30ì´ˆë§ˆë‹¤)
    quizTimer += delta;

    // í€´ì¦ˆ ì§ì „ 3ì´ˆëŠ” ìƒˆë¡œìš´ ì¥ì• ë¬¼ ìƒì„± ë§‰ê¸° â†’ ì•ˆì „êµ¬ê°„
    const quizSoon = (quizTimer >= 27 && quizTimer < 30);

    // 5) ì¥ì• ë¬¼ ìƒì„± (í”„ë ˆì„ ê¸°ë°˜, í€´ì¦ˆ ì§ì „ì—ëŠ” ìƒì„± ì•ˆ í•¨)
    if (!quizSoon) {
      obstacleTimer += delta;
      if (obstacleTimer >= nextObstacleTime) {
        spawnObstacle();
        obstacleTimer = 0;
        scheduleNextObstacle();
      }
    }

    // 6) ìºë¦­í„° ë¬¼ë¦¬
    velocity += gravity;
    playerY  += velocity;

    if (playerY < 0) playerY = 0;
    if (playerY > window.innerHeight - 110) playerY = window.innerHeight - 110;

    player.style.bottom = playerY + "px";

    // 7) ì¥ì• ë¬¼ ì´ë™ + ì¶©ëŒ ì²´í¬
    for (let i = obstacles.length - 1; i >= 0; i--) {
      const obs = obstacles[i];
      if (!obs.isConnected) {
        obstacles.splice(i, 1);
        continue;
      }

      let left = parseFloat(obs.style.left) || 0;
      left -= gameSpeed * delta;
      obs.style.left = left + "px";

      // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì¥ì• ë¬¼ ì œê±°
      if (left + 60 < 0) {
        obs.remove();
        obstacles.splice(i, 1);
        continue;
      }

      // ì¶©ëŒ íŒì •
      const rectP = player.getBoundingClientRect();
      const rectO = obs.getBoundingClientRect();

      if (rectP.left < rectO.right &&
          rectP.right > rectO.left &&
          rectP.top < rectO.bottom &&
          rectP.bottom > rectO.top) {
        damageLife();
      }
    }

    // 8) íŒ¨ëŸ´ë™ìŠ¤ ë°°ê²½ ì´ë™ (ê²Œì„ ì†ë„ì— ë¹„ë¡€)
    const speedFactor = gameSpeed / BASE_SPEED;
    bg1X -= BG1_SPEED * speedFactor * delta;
    bg2X -= BG2_SPEED * speedFactor * delta;
    bg3X -= BG3_SPEED * speedFactor * delta;

    bg1.style.backgroundPosition = `${bg1X}px 0`;
    bg2.style.backgroundPosition = `${bg2X}px 0`;
    bg3.style.backgroundPosition = `${bg3X}px 0`;

    // 9) í€´ì¦ˆ ì‹¤ì œ í˜¸ì¶œ ì‹œì 
    if (quizTimer >= 30) {
      quizTimer = 0;
      pauseForQuiz();
      return; // í€´ì¦ˆë¡œ ë„˜ì–´ê°€ë©´ì„œ ì´ë²ˆ í”„ë ˆì„ ì¢…ë£Œ
    }
    
    requestAnimationFrame(gameLoop);
  }

  requestAnimationFrame(gameLoop);

  // -------------------- ìƒëª… ê°ì†Œ --------------------
  function damageLife() {
    if (invincible || !running) return;

    life--;
    document.getElementById("lifeText").innerText = life;

    invincible = true;
    player.style.opacity = "0.4";
    setTimeout(() => {
      invincible = false;
      player.style.opacity = "1";
    }, 800);

    if (life <= 0) {
      gameOver();
    }
  }

  // -------------------- ì„±ê²½ í€´ì¦ˆ --------------------
  async function pauseForQuiz() {
  if (!running) return;
  running = false;

  // ğŸ”¥ ë¡œë”©ì°½ í‘œì‹œ
  document.getElementById("loadingQuiz").style.display = "flex";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "getQuiz" })
    });

    const txt = await res.text();

    // ì‘ë‹µ ë„ì°© â†’ ë¡œë”©ì°½ ì œê±°
    document.getElementById("loadingQuiz").style.display = "none";

    if (txt === "noquiz") {
      running = true;
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
      return;
    }

    const quiz = JSON.parse(txt);

    document.getElementById("quizQuestion").innerText = quiz.question;
    document.getElementById("btnA").innerText = "A) " + quiz.A;
    document.getElementById("btnB").innerText = "B) " + quiz.B;
    document.getElementById("btnC").innerText = "C) " + quiz.C;

    window.correctAnswer = quiz.answer;
    document.getElementById("quizModal").style.display = "flex";

  } catch (err) {
    document.getElementById("loadingQuiz").style.display = "none";
    console.warn("í€´ì¦ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    running = true;
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
  }
}


  // -------------------- saveData ì €ì¥ --------------------
  async function saveProgress() {
    try {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "save", id, saveData })
      });
    } catch (e) {
      console.warn("save ì €ì¥ ì‹¤íŒ¨:", e);
    }
    localStorage.setItem("run_save", JSON.stringify(saveData));
  }

 // -------------------- GAME Start --------------------
  function startGameNow() {
  document.getElementById("startGuide").style.display = "none";
  running = true;
  lastTime = performance.now();
  requestAnimationFrame(gameLoop);
}
  
  // -------------------- GAME OVER --------------------
  function gameOver() {
    running = false;
    invincible = true;
    player.style.opacity = "0.4";

    document.getElementById("finalDist").innerText = Math.floor(distance);
    document.getElementById("gameOverModal").style.display = "flex";
  }

  // -------------------- ë­í‚¹ ì €ì¥ --------------------
  async function saveRanking() {
    const message = document.getElementById("rankMsg").value.trim();
    const dist = Math.floor(distance);

    try {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          type: "updateRanking",
          id, name,
          distance: dist,
          message
        })
      });
      alert("ë­í‚¹ ë“±ë¡ ì™„ë£Œ!");
    } catch (e) {
      alert("ë­í‚¹ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }

    window.location.href = "/TrapGame/menu.html";
  }

  function goMenu() {
    window.location.href = "/TrapGame/menu.html";
  }
</script>

</body>
</html>
