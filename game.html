<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Disciple Run â€“ Game</title>

<style>
/* =================== ê¸°ë³¸ ì„¤ì • ====================== */
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    overscroll-behavior: none;
    touch-action: none;
    font-family: "Pretendard", system-ui, sans-serif;
}

:root {
    --hud-bg: rgba(255, 248, 235, 0.9);
    --hud-border: #3a2513;
    --accent: #c47a3f;
    --accent-dark: #8b4f26;
}

/* =================== ê²Œì„ í™”ë©´ ====================== */
#gameArea {
    position: relative;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(#88c6ff 0%, #b7e3ff 45%, #f7f0d9 45%, #f0e0b0 100%);
    overflow: hidden;
}

/* =================== ë°°ê²½ ë ˆì´ì–´ ====================== */
.bgLayer {
    width: 300%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-repeat: repeat-x;
}

#bgLayer1 {
    background-image: url("https://antiochapp.github.io/TrapGame/bg_sky.png");
    background-size: contain;
    z-index: 1;
}

#bgLayer2 {
    background-image: url("https://antiochapp.github.io/TrapGame/bg_mountain.png");
    background-size: contain;
    z-index: 2;
}

#bgLayer3 {
    background-image: url("https://antiochapp.github.io/TrapGame/bg_forest.png");
    background-size: auto 120%;
    background-position-y: 40px;
    z-index: 3;
}

/* =================== í”Œë ˆì´ì–´ ====================== */
#player {
    position: absolute;
    z-index: 12;
    width: 60px;
    height: 60px;
    left: 120px;
    bottom: 40px;
    background: url("disciple.png") center/contain no-repeat;
    image-rendering: pixelated;
    transition: opacity 0.2s;
}

/* =================== ì¥ì• ë¬¼ ====================== */
.obstacle {
    position: absolute;
    width: 60px;
    background: #8c6239;
    image-rendering: pixelated;
    z-index: 10;
}

/* =================== ëœë¤ ì•„ì´í…œ ====================== */
.item {
    position: absolute;
    width: 48px;
    height: 48px;
    z-index: 11;
    image-rendering: pixelated;
}

/* =================== HUD ====================== */
#hud {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 20;
    background: var(--hud-bg);
    padding: 8px 12px;
    border-radius: 10px;
    border: 3px solid var(--hud-border);
    font-size: 18px;
    font-weight: 700;
    color: var(--hud-border);
}

/* =================== ì½¤ë³´ / ë³´ë„ˆìŠ¤ íš¨ê³¼ ====================== */
#comboEffect,
#correctEffect {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    font-weight: 900;
    z-index: 9999;
    display: none;
}

#comboEffect {
    top: 20%;
    font-size: 40px;
    color: #ffe24f;
    text-shadow: 3px 3px #8b4f26;
}

#correctEffect {
    top: 40%;
    font-size: 48px;
    color: #00ffcc;
    text-shadow: 3px 3px #006644;
}

/* =================== ëª¨ë‹¬ ê³µí†µ ====================== */
.modal-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.55);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9000;
}

.modal-box {
    width: 90%;
    max-width: 420px;
    background: #fdfaf2;
    border-radius: 14px;
    border: 4px solid #3a2513;
    padding: 28px 24px;
    text-align: center;
    box-shadow: 0 0 0 4px white, 0 10px 0 #b79b76;
}

.modal-title {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 15px;
}

.modal-desc {
    font-size: 17px;
    line-height: 1.45;
    margin-bottom: 20px;
}

/* ë²„íŠ¼ */
.choice-btn, .action-btn {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border: 0;
    border-radius: 10px;
    background: var(--accent);
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 0 var(--accent-dark);
}

.choice-btn:active,
.action-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 var(--accent-dark);
}

.modal-input {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border-radius: 8px;
    border: 2px solid #b8a792;
    font-size: 16px;
}
</style>
</head>

<body>

<div id="gameArea">

    <!-- íŒ¨ëŸ´ë™ìŠ¤ -->
    <div id="bgLayer1" class="bgLayer"></div>
    <div id="bgLayer2" class="bgLayer"></div>
    <div id="bgLayer3" class="bgLayer"></div>

    <!-- í”Œë ˆì´ì–´ -->
    <div id="player"></div>

    <!-- HUD -->
    <div id="hud">
        â¤ï¸ <span id="lifeText"></span>
        ğŸ“ <span id="distanceText">0m</span>
        âœ <span id="faithText"></span>
    </div>
</div>

<div id="comboEffect">COMBO +1!</div>
<div id="correctEffect">+5 Faith!</div>

<!-- ============= QUIZ MODAL ============== -->
<div id="quizModal" class="modal-bg">
    <div class="modal-box">
        <div class="modal-title">ì„±ê²½ í€´ì¦ˆ</div>
        <div class="modal-desc" id="quizQuestion"></div>

        <button class="choice-btn" id="btnA" onclick="answerQuiz('A')"></button>
        <button class="choice-btn" id="btnB" onclick="answerQuiz('B')"></button>
        <button class="choice-btn" id="btnC" onclick="answerQuiz('C')"></button>
    </div>
</div>

<!-- ============= GAME OVER MODAL ============== -->
<div id="gameOverModal" class="modal-bg">
    <div class="modal-box">
        <div class="modal-title">GAME OVER</div>

        <div class="modal-desc">
            <b><span id="finalDist"></span>m</b> ë‹¬ë ¸ìŠµë‹ˆë‹¤!
        </div>

        <input id="rankMsg" class="modal-input" placeholder="ì†Œê° ì…ë ¥(ì„ íƒ)">
        <button class="action-btn" onclick="saveRanking()">ìˆœìœ„ í™•ì¸</button>
        <button class="action-btn" onclick="goMenu()">ë©”ë‰´ë¡œ</button>
    </div>
</div>

<!-- ============= LOADING QUIZ ============== -->
<div id="loadingQuiz" class="modal-bg" style="color:white; font-size:22px; font-weight:700;">
    â³ ì„±ê²½ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
</div>


<script>
/* =================== API URL ====================== */
const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

/* =================== ê¸°ë³¸ ë°ì´í„° ====================== */
let id = localStorage.getItem("run_id");
let name = localStorage.getItem("run_name");
let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");

if (!id) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "/TrapGame/index.html";
}

/* =================== ê²Œì„ ë³€ìˆ˜ ====================== */
let life = 3 + (saveData.extraLife || 0);
let faith = saveData.faith || 0;

document.getElementById("lifeText").innerText = life;
document.getElementById("faithText").innerText = faith;

const player = document.getElementById("player");

let playerY = 40;
let velocity = 0;
let jumpPower = Math.max(3, 8 - (saveData.agility || 0) * 0.05);
let gravity = -0.4;
let distance = 0;

let obstacles = [];
let items = [];

let running = true;
let invincible = false;

const BASE_SPEED = 200;
let gameSpeed = BASE_SPEED;

let lastTime = performance.now();
let quizTimer = 0;

/* =================== íŒ¨ëŸ´ë™ìŠ¤ ì†ë„ ====================== */
let bgX1 = 0, bgX2 = 0, bgX3 = 0;
const BG1_SPEED = 20;
const BG2_SPEED = 40;
const BG3_SPEED = 60;

/* =================== í„°ì¹˜ â†’ ì í”„ ====================== */
document.body.addEventListener("touchstart", () => jump());
document.body.addEventListener("keydown", e => {
    if (e.code === "Space" || e.code === "ArrowUp") {
        e.preventDefault();
        jump();
    }
});

/* =================== ì í”„ ====================== */
function jump() {
    if (!running) return;
    velocity = jumpPower;
}

/* =================== ì¥ì• ë¬¼ ìƒì„± ====================== */
function spawnObstacle() {
    const obs = document.createElement("div");
    obs.className = "obstacle";
    obs.style.height = (Math.random() * 200 + 60) + "px";
    obs.style.left = (window.innerWidth + 80) + "px";
    obs.style.bottom = "0";
    document.getElementById("gameArea").appendChild(obs);
    obstacles.push(obs);
}

/* =================== ì•„ì´í…œ ìƒì„± ====================== */
function spawnItem() {
    const types = ["cross", "wind", "wings", "bible"];
    const type = types[Math.floor(Math.random() * types.length)];

    const el = document.createElement("div");
    el.className = "item";
    el.dataset.type = type;
    el.style.background = `url('https://antiochapp.github.io/TrapGame/item_${type}.png') center/contain no-repeat`;
    el.style.left = window.innerWidth + "px";
    el.style.bottom = (100 + Math.random() * 250) + "px";

    document.getElementById("gameArea").appendChild(el);
    items.push(el);
}

/* =================== ì•„ì´í…œ íš¨ê³¼ ====================== */
function activateItem(type) {
    if (type === "cross") {
        invincible = true;
        setTimeout(() => invincible = false, 10000);
    }
    if (type === "wind") {
        gameSpeed /= 2;
        setTimeout(() => gameSpeed *= 2, 10000);
    }
    if (type === "wings") {
        jumpPower /= 2;
        setTimeout(() => jumpPower *= 2, 10000);
    }
    if (type === "bible") {
        faith += 10;
        saveData.faith = faith;
        document.getElementById("faithText").innerText = faith;
        saveProgress();
    }
}

/* =================== ì„±ê²½ í€´ì¦ˆ ====================== */
async function pauseForQuiz() {
    running = false;
    document.getElementById("loadingQuiz").style.display = "flex";

    try {
        const raw = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ type: "getQuiz" })
        });
        const txt = await raw.text();
        document.getElementById("loadingQuiz").style.display = "none";

        if (txt === "noquiz") {
            running = true;
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            return;
        }

        const quiz = JSON.parse(txt);

        document.getElementById("quizQuestion").innerText = quiz.question;
        document.getElementById("btnA").innerText = "A. " + quiz.A;
        document.getElementById("btnB").innerText = "B. " + quiz.B;
        document.getElementById("btnC").innerText = "C. " + quiz.C;

        window.correctAnswer = quiz.answer;

        document.getElementById("quizModal").style.display = "flex";

    } catch (e) {
        document.getElementById("loadingQuiz").style.display = "none";
        running = true;
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }
}

function answerQuiz(s) {
    document.getElementById("quizModal").style.display = "none";

    if (s === window.correctAnswer) {
        // ì •ë‹µ íš¨ê³¼
        const ce = document.getElementById("correctEffect");
        ce.style.display = "block";
        setTimeout(() => ce.style.display = "none", 800);

        faith += 5;
        saveData.faith = faith;
        document.getElementById("faithText").innerText = faith;
        saveProgress();

    } else {
        damageLife();
    }

    if (life > 0) {
        running = true;
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }
}

/* =================== ìƒëª… ê°ì†Œ ====================== */
function damageLife() {
    if (invincible) return;

    life--;
    document.getElementById("lifeText").innerText = life;

    if (life <= 0) {
        gameOver();
    }
}

/* =================== ê²Œì„ ì˜¤ë²„ ====================== */
function gameOver() {
    running = false;

    document.getElementById("finalDist").innerText = Math.floor(distance);

    // ì¦‰ì‹œ ë­í‚¹ ë“±ë¡
    fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            type: "updateRanking",
            id, name,
            distance: Math.floor(distance),
            message: ""
        })
    });

    document.getElementById("gameOverModal").style.display = "flex";
}

/* =================== ë­í‚¹ ì €ì¥ + ì†Œê° ì—…ë°ì´íŠ¸ ====================== */
async function saveRanking() {
    const msg = document.getElementById("rankMsg").value.trim();

    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            type: "updateRanking",
            id, name,
            distance: Math.floor(distance),
            message: msg
        })
    });

    window.location.href = "/TrapGame/menu.html";
}

function goMenu() {
    window.location.href = "/TrapGame/menu.html";
}

/* =================== ì €ì¥ ====================== */
async function saveProgress() {
    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "save", id, saveData })
    });
    localStorage.setItem("run_save", JSON.stringify(saveData));
}

/* =================== ë©”ì¸ ë£¨í”„ ====================== */
function gameLoop(now) {
    if (!running) return;

    const delta = (now - lastTime) / 1000;
    lastTime = now;

    /* ê±°ë¦¬ ì¦ê°€ */
    distance += delta * 1;
    document.getElementById("distanceText").innerText = Math.floor(distance) + "m";

    /* íŒ¨ëŸ´ë™ìŠ¤ */
    bgX1 -= BG1_SPEED * delta;
    bgX2 -= BG2_SPEED * delta;
    bgX3 -= BG3_SPEED * delta;

    document.getElementById("bgLayer1").style.backgroundPosition = `${bgX1}px 0`;
    document.getElementById("bgLayer2").style.backgroundPosition = `${bgX2}px 0`;
    document.getElementById("bgLayer3").style.backgroundPosition = `${bgX3}px 0`;

    /* ì í”„ ë¬¼ë¦¬ */
    velocity += gravity;
    playerY += velocity;
    if (playerY < 0) playerY = 0;
    if (playerY > window.innerHeight - 120) playerY = window.innerHeight - 120;
    player.style.bottom = playerY + "px";

    /* ì¥ì• ë¬¼ ìƒì„± */
    if (Math.random() < delta * 0.9) spawnObstacle();

    /* ì•„ì´í…œ ìƒì„± */
    if (Math.random() < delta * 0.2) spawnItem();

    /* ì¥ì• ë¬¼ ì´ë™ / ì¶©ëŒ */
    for (let i = obstacles.length - 1; i >= 0; i--) {
        let o = obstacles[i];
        let x = parseFloat(o.style.left);
        x -= gameSpeed * delta;
        o.style.left = x + "px";

        if (x < -80) {
            o.remove();
            obstacles.splice(i, 1);
            continue;
        }

        const r1 = player.getBoundingClientRect();
        const r2 = o.getBoundingClientRect();

        if (r1.left < r2.right && r1.right > r2.left &&
            r1.top < r2.bottom && r1.bottom > r2.top) {
            damageLife();
        }
    }

    /* ì•„ì´í…œ ì´ë™ / ì¶©ëŒ */
    for (let i = items.length - 1; i >= 0; i--) {
        let it = items[i];
        let x = parseFloat(it.style.left);
        x -= gameSpeed * delta;
        it.style.left = x + "px";

        if (x < -100) {
            it.remove();
            items.splice(i, 1);
            continue;
        }

        const r1 = player.getBoundingClientRect();
        const r2 = it.getBoundingClientRect();

        if (r1.left < r2.right && r1.right > r2.left &&
            r1.top < r2.bottom && r1.bottom > r2.top) {

            activateItem(it.dataset.type);
            it.remove();
            items.splice(i, 1);
        }
    }

    /* í€´ì¦ˆ íƒ€ì´ë¨¸ */
    quizTimer += delta;
    if (quizTimer >= 30) {
        quizTimer = 0;
        pauseForQuiz();
        return;
    }

    requestAnimationFrame(gameLoop);
}

/* =================== ê²Œì„ ì‹œì‘ ====================== */
lastTime = performance.now();
requestAnimationFrame(gameLoop);
</script>

</body>
</html>
