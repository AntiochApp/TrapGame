<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Disciple Run â€“ Remastered Ver. 3.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    /* === ì›ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì‹ ê·œ ì´í™íŠ¸ ì¶”ê°€ === */
    :root { --hud-bg: rgba(255, 248, 235, 0.9); --hud-border: #3a2513; --accent: #c47a3f; --panel-bg: #fdfaf2; }
    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; font-family: "Pretendard", sans-serif; }
    
    #gameArea { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: linear-gradient(#88c6ff 0%, #b7e3ff 45%, #f7f0d9 45%, #f0e0b0 100%); transition: filter 0.5s; }
    
    /* íš¨ê³¼ ëª¨ìŒ */
    #gameArea.fever-mode { filter: sepia(40%) saturate(180%) hue-rotate(-5deg); }
    #gameArea.sandstorm-mode { filter: sepia(80%) contrast(120%) brightness(90%); }
    #gameArea.shake-screen { animation: screenShake 0.1s infinite; }
    @keyframes screenShake { 0% { transform: translate(0, 0); } 25% { transform: translate(-4px, 4px); } 50% { transform: translate(4px, -4px); } 75% { transform: translate(-4px, -4px); } 100% { transform: translate(0, 0); } }

    #flashEffect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 200; transition: opacity 0.1s; }

    /* ì¤€: ì‹œê³µê°„ í¬íƒˆ */
    .time-portal {
        position: absolute; width: 140px; height: 220px;
        background: transparent; border-radius: 50%;
        transform: translate(-50%, -50%) scale(0); z-index: 45; 
        display: flex; justify-content: center; align-items: center;
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .time-portal.active { transform: translate(-50%, -50%) scale(1); }
    .time-portal::before {
        content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
        box-shadow: inset 0 0 30px #00ffff, 0 0 40px #00ffff;
        background: conic-gradient(from 0deg, transparent, #00ffff, rgba(0,0,255,0.5), transparent 50%);
        animation: portalSpin 1.5s infinite linear; mix-blend-mode: screen;
    }
    .time-portal::after {
        content: ''; position: absolute; width: 80%; height: 80%; border-radius: 50%;
        background: radial-gradient(ellipse at center, #000 20%, #000033 60%, transparent 100%);
        box-shadow: inset 0 0 50px #000;
    }
    @keyframes portalSpin { 0% { transform: rotate(0deg); filter: hue-rotate(0deg); } 100% { transform: rotate(360deg); filter: hue-rotate(60deg); } }

    .time-tunnel-bg {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 100; pointer-events: auto; opacity: 0; transition: opacity 0.5s; display: none;
        color: white; flex-direction: column; justify-content: center; align-items: center;
    }
    .tunnel-star { position: absolute; width: 100px; height: 2px; background: #fff; box-shadow: 0 0 10px #fff; animation: warpSpeed 0.5s linear infinite; pointer-events: none; }
    @keyframes warpSpeed { from { transform: translateX(100vw); } to { transform: translateX(-100vw); } }
    
    #junMiniGameUI { text-align: center; z-index: 101; pointer-events: none; }
    #junMiniGameMsg { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 10px cyan; }
    #junDistanceDisplay { font-size: 60px; font-weight: 900; color: #ffe24f; text-shadow: 4px 4px 0 #3a2513; }

    /* ì¤€: ì–´ë¦° ì–‘ */
    .lamb-unit {
        position: absolute; width: 60px; height: 60px;
        background: url('Lam.png') no-repeat center/contain;
        z-index: 51; filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.3));
    }
    .lamb-msg {
        position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
        background: #fff; border: 3px solid #3a2513; padding: 6px 12px;
        border-radius: 15px; font-size: 14px; font-weight: 800; white-space: nowrap;
        box-shadow: 2px 2px 0 rgba(0,0,0,0.2); color: #3a2513;
    }
    .lamb-msg::after {
        content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
        border-width: 10px 8px 0; border-style: solid; border-color: #3a2513 transparent; display: block; width: 0;
    }

    /* ì „ì°¬: ë¦¬ì–¼ ë²ˆê°œ & í•´ë¨¸ */
    .hammer-unit {
        position: absolute; width: 250px; height: 250px;
        background: url('Hammer.png') no-repeat center/contain;
        z-index: 95; filter: drop-shadow(-10px 10px 20px rgba(0,0,0,0.5));
    }
    .hammer-trail {
        position: absolute; top: 50%; left: -100px; width: 200px; height: 100px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6));
        transform: translateY(-50%); z-index: 94; filter: blur(8px);
    }
    .jc-lightning {
        position: absolute; width: 20px; height: 100vh;
        background: linear-gradient(to bottom, rgba(255,255,255,0.9), #fff, rgba(255,255,255,0));
        z-index: 89; pointer-events: none; transform-origin: top center;
        box-shadow: 0 0 30px #ffd700, 0 0 60px #ff8c00;
        clip-path: polygon(45% 0%, 55% 0%, 55% 15%, 70% 15%, 40% 40%, 60% 40%, 40% 100%, 30% 100%, 30% 60%, 10% 60%, 45% 25%, 35% 25%);
        animation: lightningStrike 0.4s ease-out forwards;
    }
    @keyframes lightningStrike { 0% { opacity: 0; transform: scaleY(0); } 10% { opacity: 1; transform: scaleY(1); } 100% { opacity: 0; } }

    /* í•˜íœ˜: ì¸í”¼ë‹ˆí‹° ìŠ¤í†¤ */
    .infinity-stone {
        position: absolute; width: 20px; height: 20px; border-radius: 50%;
        box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
        z-index: 60; transition: left 0.1s, top 0.1s;
    }
    .sand-particle {
        position: absolute; width: 6px; height: 6px; background: #d2b48c;
        border-radius: 50%; opacity: 0.8; z-index: 88; pointer-events: none;
        animation: sandWind 1s linear infinite;
    }
    @keyframes sandWind { from { transform: translateX(0) translateY(0); } to { transform: translateX(-200px) translateY(50px); opacity: 0; } }
    .dust-effect {
        position: absolute; width: 100px; height: 100px;
        background: radial-gradient(circle, #d2b48c 30%, transparent 80%);
        opacity: 0.9; animation: dissolve 0.6s ease-out forwards; transform: translate(-50%, -50%); z-index: 85;
    }
    @keyframes dissolve { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; filter: blur(4px); } }

    /* ì§€í˜œ: ë°œí‚¤ë¦¬ */
    .jihye-transform-sphere {
        position: absolute; width: 120px; height: 120px; border-radius: 50%;
        background: radial-gradient(circle at center, #fff 20%, #ffd700 80%);
        box-shadow: 0 0 40px #ffd700, 0 0 80px #fff;
        z-index: 52; transform: translate(-50%, -50%);
        animation: sphereCharge 2s ease-in forwards; mix-blend-mode: screen;
    }
    @keyframes sphereCharge { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 20% { opacity: 0.8; } 80% { scale: 1.2; opacity: 1; } 100% { scale: 3; opacity: 0; } }
    .jihye-unit {
        position: absolute; width: 50px; height: 50px;
        background-size: contain; background-repeat: no-repeat;
        z-index: 55; transition: transform 0.2s; filter: drop-shadow(0 0 10px cyan);
    }
    .jihye-healer {
        position: absolute; width: 80px; height: 80px;
        background-image: url('Skill_JHA.png'); background-size: contain; background-repeat: no-repeat;
        z-index: 60; pointer-events: none;
        transition: left 1.5s ease-out, top 1.5s ease-out;
        filter: drop-shadow(0 0 20px gold);
    }
    .holy-light-pillar {
        position: absolute; width: 120px; height: 100vh;
        background: linear-gradient(to bottom, transparent, rgba(255, 215, 0, 0.6), transparent);
        bottom: 0; transform: translateX(-50%);
        z-index: 59; pointer-events: none;
        animation: lightPillar 2.0s ease-out forwards;
    }
    @keyframes lightPillar { 0% { opacity: 0; height: 0; } 20% { opacity: 1; height: 100vh; } 80% { opacity: 1; } 100% { opacity: 0; } }
    .jihye-missile {
        position: absolute; width: 24px; height: 24px;
        background: radial-gradient(circle, #fff, #00b0ff); border-radius: 50%;
        box-shadow: 0 0 10px #00b0ff; z-index: 66;
    }

    /* ì§€ì€: ë©œë¡œë”” ì›¨ì´ë¸Œ */
    .jieun-note {
        position: absolute; font-size: 40px; font-weight: bold;
        z-index: 65; animation: noteFloat 1s infinite alternate;
        text-shadow: 0 0 10px #fff;
    }
    @keyframes noteFloat { from { transform: translateY(0); } to { transform: translateY(-15px); } }
    .melody-wave-bg {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(45deg, rgba(255,0,0,0.1), rgba(0,255,0,0.1), rgba(0,0,255,0.1), rgba(255,0,255,0.1));
        background-size: 400% 400%; animation: rainbowWave 3s ease infinite; 
        z-index: 4; pointer-events: none; display: none; mix-blend-mode: overlay;
    }
    @keyframes rainbowWave { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .jieun-shield-unit {
        position: absolute; width: 50px; height: 50px;
        background-image: url('skin_noel.png'); background-size: contain; background-repeat: no-repeat;
        z-index: 55; filter: drop-shadow(0 0 5px white);
        animation: orbitShield 2s infinite linear;
    }
    @keyframes orbitShield { from { transform: rotate(0deg) translateX(50px) rotate(0deg); } to { transform: rotate(360deg) translateX(50px) rotate(-360deg); } }

    /* ë…¸ì—˜: ê±°ëŒ€í™” & ë¹” */
    .noel-aura {
        position: absolute; width: 140%; height: 140%; top: -20%; left: -20%;
        background: radial-gradient(circle, rgba(255,215,0,0.4) 20%, transparent 70%);
        border-radius: 50%; z-index: 49;
        box-shadow: 0 0 40px gold; animation: auraPulse 0.5s infinite alternate;
        display: none; pointer-events: none;
    }
    @keyframes auraPulse { from { transform: scale(1); opacity: 0.6; } to { transform: scale(1.1); opacity: 0.9; } }
    .player-giant { transform: scale(2) !important; transition: transform 0.5s; }
    .noel-beam {
        position: absolute; left: 170px; height: 120px; width: 0;
        background: radial-gradient(ellipse at left, rgba(255,255,255,1) 0%, rgba(0,255,255,0.8) 30%, rgba(0,100,255,0) 80%);
        z-index: 89; transform-origin: left center; pointer-events: none;
        animation: beamFire 0.4s ease-out forwards; mix-blend-mode: screen;
        box-shadow: 0 0 40px cyan, 0 0 20px white; border-radius: 60px 0 0 60px;
    }
    @keyframes beamFire { 0% { width: 0; opacity: 0.5; transform: scaleY(0.1); } 20% { width: 60vw; opacity: 1; transform: scaleY(1.2); } 100% { width: 150vw; opacity: 0.8; transform: scaleY(1); } }

    /* ê°•í¬: ê±´ë‹´ */
    .funnel-unit {
        position: absolute; width: 40px; height: 40px;
        background: url('Panel.png') no-repeat center/contain;
        z-index: 55; filter: drop-shadow(0 0 5px cyan);
    }
    .funnel-laser {
        position: absolute; height: 4px; background: #00ffff;
        box-shadow: 0 0 8px #00ffff; z-index: 56; transform-origin: left center; opacity: 0.8;
    }
    .gundam-mode-effect {
        position: absolute; top: 50%; left: 50%; width: 120%; height: 120%;
        transform: translate(-50%, -50%); border-radius: 50%;
        background: rgba(0, 191, 255, 0.3); border: 2px solid #00bfff;
        box-shadow: 0 0 20px #00bfff; z-index: 49; display: none;
    }

    /* ìŠ¤í…ŒíŒŒë‹ˆ: ì¼€ì´í¬ */
    .cake-bg-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: url('CakeBack.png') repeat-x center/cover;
        z-index: 10; opacity: 0; transition: opacity 1s; display: none; mix-blend-mode: overlay;
    }
    .falling-cake {
        position: absolute; width: 50px; height: 50px;
        background-size: contain; background-repeat: no-repeat;
        z-index: 60; animation: cakeFall 2s linear infinite;
    }
    @keyframes cakeFall { from { transform: translateY(-50px) rotate(0deg); } to { transform: translateY(110vh) rotate(360deg); } }
    .stephanie-heart {
        position: absolute; font-size: 24px; color: #ff69b4; font-weight: bold;
        animation: floatUpHeart 1.5s ease-out forwards; z-index: 95;
    }
    @keyframes floatUpHeart { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }

    /* ì˜ˆì¤€: ë„í”Œê°±ì–´ */
    .yejun-clone {
        position: absolute; width: 50px; height: 50px;
        background-image: url('skin_yejun.png'); opacity: 0.7;
        background-size: contain; background-repeat: no-repeat;
        z-index: 50; filter: grayscale(30%);
    }
    .yejun-wing {
        position: absolute; top: -30px; left: -40px; width: 140px; height: 120px;
        background: url('item_wings.png') no-repeat center/contain;
        z-index: 49; opacity: 0.8; filter: drop-shadow(0 0 10px white);
        animation: wingFlap 0.2s infinite alternate; display: none;
    }
    @keyframes wingFlap { from { transform: scaleX(1); } to { transform: scaleX(0.85); } }
    .smoke-poof {
        position: absolute; width: 100px; height: 100px;
        background: radial-gradient(circle, #ddd 20%, transparent 70%);
        animation: poofAnim 0.5s ease-out forwards; z-index: 80; transform: translate(-50%, -50%);
    }
    @keyframes poofAnim { 0% { transform: translate(-50%,-50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%,-50%) scale(2.5); opacity: 0; } }

    /* ê³µí†µ & ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
    .boba-unit {
        position: absolute; width: 20px; height: 20px;
        background: radial-gradient(circle at 30% 30%, #4e342e, #212121);
        border: 1px solid #000; border-radius: 50%;
        box-shadow: 2px 2px 3px rgba(0,0,0,0.4); z-index: 65; pointer-events: none;
    }
    .angel-wing-effect {
        position: absolute; width: 150px; height: 150px;
        left: 50%; top: 50%; transform: translate(-50%, -50%);
        display: flex; justify-content: center; align-items: center;
        font-size: 100px; z-index: 100; text-shadow: 0 0 20px gold, 0 0 40px white;
        animation: wingRise 2s ease-out forwards; pointer-events: none;
    }
    .angel-wing-effect::after { content: 'ğŸª½'; }
    @keyframes wingRise { 0% { opacity: 0; transform: translate(-50%, -20%) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -120%) scale(1.5); } }

    .haeun-shield {
        position: absolute; width: 80px; height: 80px;
        left: -10px; bottom: -10px; border-right: 6px solid rgba(255, 255, 255, 0.9);
        border-radius: 50%; box-shadow: 15px 0 20px rgba(255, 255, 255, 0.5);
        pointer-events: none; z-index: 55; animation: shieldBreath 2s infinite ease-in-out;
    }
    @keyframes shieldBreath { 0% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.6; transform: scale(1); } }
    
    .heal-effect-visual {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
        width: 100px; height: 100px;
        background: radial-gradient(circle, rgba(255,50,50,0) 20%, rgba(255,0,0,0.6) 60%, transparent 100%);
        border: 2px solid rgba(255, 100, 100, 0.8); border-radius: 50%;
        animation: healExpand 0.6s ease-out forwards; z-index: 95; pointer-events: none;
    }
    @keyframes healExpand { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; } }

    .bg-layer { position: absolute; left: 0; top: 0; width: 200%; height: 100%; background-repeat: repeat-x; image-rendering: pixelated; pointer-events: none; will-change: background-position; }
    #bgLayer1 { background-image: url("bg_sky.png"); z-index: 1; background-size: auto 100%; background-position: 0 bottom; }
    #bgLayer2 { background-image: url("bg_mountain.png"); z-index: 2; background-size: auto 100%; background-position: 0 bottom; }
    #bgLayer3 { background-image: url("bg_forest.png"); z-index: 3; background-size: auto 60%; background-position: 0 bottom; }
    #ground { display: none; }

    #player { 
        position: absolute; z-index: 50; left: 120px; bottom: 40px; 
        width: 60px; height: 60px; background-image: url("disciple.png"); 
        background-position: center; background-size: contain; background-repeat: no-repeat; 
        image-rendering: pixelated; transition: opacity 0.2s, transform 0.3s;
        filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.2)); 
    }
    #player.fever-active { transform: scale(1.3); filter: drop-shadow(0 0 20px gold); }

    .obstacle { position: absolute; z-index: 40; background-size: 8px 8px; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); }
    .obs-cap::after { content: ''; position: absolute; left: -10%; width: 120%; height: 24px; border-radius: 4px; }
    .obs-ground.obs-cap::after { top: -12px; } .obs-ceil.obs-cap::after { bottom: -12px; }
    .obs-log { width: 60px; background-color: #8D6E63; border-left: 4px solid #5D4037; border-right: 4px solid #5D4037; background-image: linear-gradient(90deg, rgba(0,0,0,0.05) 50%, transparent 50%); }
    .obs-log.obs-cap::after { background-color: #66BB6A; border: 4px solid #1B5E20; }
    .obs-rock { width: 60px; background-color: #9E9E9E; border-left: 4px solid #616161; border-right: 4px solid #616161; background-image: radial-gradient(circle, rgba(0,0,0,0.1) 20%, transparent 20%); }
    .obs-rock.obs-cap::after { background-color: #BDBDBD; border: 4px solid #424242; }
    .obs-long { width: 240px; height: 35px; background-color: #5D4037; background-image: linear-gradient(0deg, rgba(0,0,0,0.2) 50%, transparent 50%); border: 3px solid #3E2723; border-radius: 8px; box-shadow: 0 5px 5px rgba(0,0,0,0.3); }

    .obstacle-explosion {
        position: absolute; z-index: 85; width: 100px; height: 100px;
        background: radial-gradient(circle, #fff, orange, transparent);
        border-radius: 50%; animation: obsExplode 0.4s ease-out forwards; transform: translate(-50%, -50%); 
    }
    @keyframes obsExplode { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

    .faith-coin {
        position: absolute; z-index: 88; width: 24px; height: 24px;
        background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00);
        border: 2px solid #fff; border-radius: 50%;
        box-shadow: 0 0 10px gold;
        display: flex; justify-content: center; align-items: center;
        font-size: 14px; font-weight: bold; color: #fff;
    }
    .faith-coin::after { content: 'âœ'; }

    .enemy { position: absolute; z-index: 48; width: 60px; height: 60px; background-position: center; background-size: contain; background-repeat: no-repeat; }
    .item { position: absolute; z-index: 45; width: 48px; height: 48px; image-rendering: pixelated; background-position: center; background-repeat: no-repeat; background-size: contain; animation: itemFloat 1.5s ease-in-out infinite alternate; }
    @keyframes itemFloat { from { transform: translateY(0); } to { transform: translateY(-8px); } }

    .projectile { position: absolute; z-index: 60; width: 30px; height: 30px; border-radius: 50%; transition: opacity 0.2s; }
    .enemy-missile { background: radial-gradient(circle, #ff0000, #800000); box-shadow: 0 0 8px #ff0000; }
    .boss-missile { width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff5722); animation: spinMeteor 1s linear infinite; }
    .player-missile { 
        position: absolute; width: 50px; height: 24px; 
        background: linear-gradient(90deg, #00ffff, #0099ff); 
        border-radius: 12px; box-shadow: 0 0 15px cyan, 0 0 5px white; 
        z-index: 65; border: 2px solid #fff;
    }
    .explosion-area { position: absolute; border-radius: 50%; background: rgba(255, 69, 0, 0.5); border: 2px solid orange; animation: explode 0.5s forwards; z-index: 59; }
    @keyframes explode { 0% { transform: scale(0.1); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
    .enemy-laser-warning { position: absolute; height: 2px; background: rgba(255,0,0,0.5); z-index: 49; }
    .enemy-laser-beam { position: absolute; height: 30px; background: linear-gradient(to bottom, transparent, red, transparent); box-shadow: 0 0 15px red; z-index: 50; }
    .reflected-missile { background: #00ff00 !important; box-shadow: 0 0 15px #00ff00; }
    @keyframes spinMeteor { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .particle { position: absolute; z-index: 90; pointer-events: none; border-radius: 50%; animation: particleFade 0.8s ease-out forwards; }
    @keyframes particleFade { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }

    #hud { position: fixed; z-index: 900; top: 12px; left: 12px; color: #3a2513; font-size: 18px; font-weight: 700; background: var(--hud-bg); border-radius: 10px; padding: 8px 12px; border: 3px solid var(--hud-border); }
    #feverContainer { width: 150px; height: 12px; background: #333; border: 2px solid #3a2513; border-radius: 6px; margin-top: 5px; overflow: hidden; display: flex; }
    #feverFill { width: 0%; height: 100%; background: linear-gradient(90deg, #ffd700, #ff8c00); transition: width 0.2s; }
    
    #pauseBtn { 
        position: fixed; z-index: 900; top: 15px; right: 15px; width: 50px; height: 50px; 
        background: #fdfaf2; border: 4px solid #3a2513; border-radius: 12px; 
        box-shadow: 0 4px 0 #8b4f26; display: flex; justify-content: center; align-items: center; 
        font-size: 24px; cursor: pointer; color: #3a2513; transition: transform 0.1s, box-shadow 0.1s;
    }
    #pauseBtn:active { transform: translateY(4px); box-shadow: 0 0 0 #8b4f26; }
    
    #buffArea { position: fixed; z-index: 2147483647; bottom: 20px; right: 15px; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 8px; pointer-events: none; }
    .buff-tag { background: rgba(0, 0, 0, 0.85); color: #fff; padding: 8px 14px; border-radius: 8px; font-weight: 700; border-left: 5px solid; font-size: 14px; box-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    
    #abilityBtn { 
        position: fixed; bottom: 20px; right: 20px; width: 80px; height: 80px; 
        background: #ff5722; color: white; border-radius: 50%; border: 4px solid #fff; 
        font-weight: bold; font-size: 20px; display: none; justify-content: center; align-items: center; 
        cursor: pointer; z-index: 1000; box-shadow: 0 6px 12px rgba(0,0,0,0.6); 
    }
    #abilityBtn.cooldown { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; font-size: 24px; }

    /* SKILL ë²„íŠ¼ 2 (ë…¸ì—˜ ì „ìš© - ì´ˆê¸° ìˆ¨ê¹€) */
    #abilityBtn2 { 
        position: fixed; bottom: 110px; right: 20px; width: 80px; height: 80px; 
        background: #00bcd4; color: white; border-radius: 50%; border: 4px solid #fff; 
        font-weight: bold; font-size: 20px; display: none; justify-content: center; align-items: center; 
        cursor: pointer; z-index: 1000; box-shadow: 0 6px 12px rgba(0,0,0,0.6); 
        transition: transform 0.1s;
    }
    #abilityBtn2:active { transform: scale(0.9); }
    #abilityBtn2.cooldown { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; font-size: 24px; }

    #subActionBtn { 
        position: fixed; bottom: 150px; left: 20px; width: 100px; height: 100px; border-radius: 50%;
        border: 4px solid #fff; color: white; font-weight: 900; font-size: 20px; text-align: center;
        display: none; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; 
        box-shadow: 0 6px 12px rgba(0,0,0,0.6); transition: transform 0.1s, background-color 0.2s;
    }
    #subActionBtn:active { transform: scale(0.9); }
    #subActionBtn.cooldown { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
    .btn-attack { background-color: #D32F2F !important; }
    .btn-defence { background-color: #1976D2 !important; }

    #dailyMissionBox { position: fixed; bottom: 20px; left: 20px; background: rgba(0, 0, 0, 0.75); color: #fff; padding: 12px 16px; border-radius: 10px; font-size: 13px; z-index: 800; pointer-events: none; border: 2px solid #3a2513; }
    .mission-done { color: #4caf50; text-decoration: line-through; }
    
    #bossContainer { position: absolute; right: -200px; top: 50%; width: 120px; height: 120px; z-index: 55; display: none; transition: right 1s ease-out; }
    #bossBody { width: 100%; height: 100%; background: url('boss.png') no-repeat center/contain; image-rendering: pixelated; filter: drop-shadow(0 0 10px red); animation: bossFloat 2s ease-in-out infinite; }
    .boss-charging { filter: drop-shadow(0 0 20px yellow) !important; transform: scale(1.1); }
    .boss-dashing { filter: drop-shadow(0 0 20px #ff0000) !important; }
    @keyframes bossFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    #bossHpBar { position: absolute; top: -20px; left: 0; width: 100%; height: 100%; background: #333; border: 2px solid #000; border-radius: 5px; overflow: hidden; }
    #bossHpFill { width: 100%; height: 100%; background: #d32f2f; transition: width 0.2s; }
    #bossWarning { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; font-weight: 900; color: #d32f2f; text-shadow: 3px 3px 0 #000; display: none; z-index: 2000; animation: blink 0.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .boss-laser { position: absolute; right: 0; height: 40px; background: linear-gradient(to bottom, #ff0000, #fff, #ff0000); z-index: 58; opacity: 0.8; border-top: 2px solid #fff; border-bottom: 2px solid #fff; box-shadow: 0 0 20px #ff0000; pointer-events: none; display: none; }

    #speedLines { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 80; background: radial-gradient(circle, transparent 40%, rgba(255, 255, 255, 0.8) 90%); mix-blend-mode: overlay; pointer-events: none; animation: speedShake 0.1s infinite; }
    @keyframes speedShake { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }
    .float-text { position: absolute; color: #ffe24f; font-weight: 900; font-size: 20px; text-shadow: 2px 2px 0 #3a2513; z-index: 1000; pointer-events: none; animation: floatUp 1s ease-out forwards; }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }
    #comboEffect, #correctEffect { position: fixed; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; pointer-events: none; font-weight: 900; text-shadow: 3px 3px #000; }
    #comboEffect { top: 20%; font-size: 40px; color: #ffe24f; text-shadow: 3px 3px #8b4f26; }
    #correctEffect { top: 40%; font-size: 48px; color: #00ffcc; text-shadow: 3px 3px #006644; }

    .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.55); display: none; justify-content: center; align-items: center; padding: 16px; z-index: 20000; }
    .modal-box { width: 90%; max-width: 420px; background: var(--panel-bg); border-radius: 14px; border: 4px solid #3a2513; padding: 28px 24px; box-shadow: 0 0 0 4px #fff, 0 10px 0 #b79b76; text-align: center; }
    .start-btn, .choice-btn, .action-btn { width: 100%; padding: 14px; margin: 8px 0; background: var(--accent); border: 0; border-radius: 10px; color: #fff; font-size: 18px; font-weight: 700; box-shadow: 0 4px 0 var(--accent-dark); cursor: pointer; }
    .choice-btn:active, .action-btn:active, .start-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--accent-dark); }
    .action-btn:disabled { background: #999; cursor: not-allowed; box-shadow: none; }
    .modal-input { width: 85%; max-width: 320px; padding: 12px; font-size: 16px; border-radius: 8px; border: 2px solid #b8a792; margin: 8px auto 18px; display: block; }
    #loadingQuiz { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; color: #fff; font-size: 22px; font-weight: 700; z-index: 20001; }
  </style>
</head>

<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false">
<div id="gameArea">
  <div id="startGuide" class="modal-bg" style="display:flex;">
    <div class="modal-box">
      <div style="font-size:28px; font-weight:800; margin-bottom:18px;">ê²Œì„ ë°©ë²• (Remastered 3.0)</div>
      <div style="text-align:left; font-size:15px; line-height:1.6;">
        â€¢ <b>ì í”„:</b> í™”ë©´ í„°ì¹˜ / Space<br>
        â€¢ <b>ìŠ¤í‚¬:</b> Aí‚¤ / SKILL ë²„íŠ¼<br>
        â€¢ <b>ê³µê²©/ë°©ì–´:</b> Sí‚¤ / Attack ë²„íŠ¼ (200m+)<br><br>
        [ì—…ë°ì´íŠ¸]<br>
        ğŸ¦ <b>ë…¸ì—˜:</b> ê±°ëŒ€í™”(íŒ¨ì‹œë¸Œ) & ì—ë„ˆì§€íŒŒ<br>
        âš¡ <b>ì „ì°¬:</b> í•´ë¨¸ ì†Œí™˜ & ë¦¬ì–¼ ë²ˆê°œ<br>
        âš”ï¸ <b>í•˜íœ˜:</b> ì¸í”¼ë‹ˆí‹° ìŠ¤í†¤ & ëª¨ë˜í­í’<br>
        â³ <b>ì¤€:</b> ì‹œê³µê°„ ë¯¸ë‹ˆê²Œì„ & í¬íƒˆ<br>
        ğŸ›¡ï¸ <b>ì§€í˜œ:</b> ë°œí‚¤ë¦¬ & ì •í™” ì¹˜ìœ <br>
        ğŸ¤– <b>ê°•í¬:</b> ê±´ë‹´ ë³€ì‹  & íŒë„¬<br>
        ğŸ‚ <b>ìŠ¤í…ŒíŒŒë‹ˆ:</b> ì¼€ì´í¬ ì›”ë“œ & í<br>
        ğŸ‘» <b>ì˜ˆì¤€:</b> ë„í”Œê°±ì–´ & ë¹„í–‰<br>
        ğŸµ <b>ì§€ì€:</b> ë©œë¡œë”” ì›¨ì´ë¸Œ & ìˆ˜í˜¸
      </div>
      <button class="start-btn" onclick="startGameNow()">â–¶ ì‹œì‘í•˜ê¸° / Start</button>
    </div>
  </div>

  <div id="bgLayer1" class="bg-layer"></div>
  <div id="bgLayer2" class="bg-layer"></div>
  <div id="bgLayer3" class="bg-layer"></div>
  <div id="speedLines"></div> 
  <div id="cakeBgLayer" class="cake-bg-layer"></div>
  <div id="melodyWaveBg" class="melody-wave-bg"></div>

  <div id="timeTunnelBg" class="time-tunnel-bg">
     <div id="junMiniGameUI">
         <div id="junMiniGameMsg">TAP TO BOOST!</div>
         <div id="junDistanceDisplay">0m</div>
     </div>
  </div> 
  <div id="ground"></div> 
  
  <div id="player">
    <div id="noelAura" class="noel-aura"></div>
    <div id="gundamEffect" class="gundam-mode-effect"></div>
    <div id="yejunWing" class="yejun-wing"></div>
  </div>

  <div id="flashEffect"></div>

  <div id="bossContainer">
    <div id="bossHpBar"><div id="bossHpFill"></div></div>
    <div id="bossBody"></div>
  </div>
  <div id="bossLaser" class="boss-laser"></div>

  <div id="hud">
    â¤ï¸ <span id="lifeText"></span> 
    ğŸ“ <span id="distanceText">0m</span> 
    âœ <span id="faithText"></span>
    <div style="display:flex; align-items:center; margin-top:4px;">
        <span style="font-size:14px;">ğŸ”¥</span>
        <div id="feverContainer"><div id="feverFill"></div></div>
    </div>
  </div>
    
  <div id="pauseBtn" onclick="togglePause()">â¸ï¸</div>

  <div id="abilityBtn" ontouchstart="useAbility(event)" onclick="useAbility(event)">SKILL</div>
  <div id="abilityBtn2" ontouchstart="useAbility2(event)" onclick="useAbility2(event)">BEAM</div>
  <div id="dailyMissionBox"></div>
  
  <div id="subActionBtn" ontouchstart="handleSubAction(event)" onclick="handleSubAction(event)">
  </div>
</div>

<div id="buffArea"></div>
<div id="bossWarning">âš ï¸ BOSS WARNING!</div>
<div id="comboEffect">COMBO +1!</div>
<div id="correctEffect">+5 Faith!</div>

<div id="pauseModal" class="modal-bg">
  <div class="modal-box">
    <div style="font-size:28px; font-weight:800; margin-bottom:15px;">ì¼ì‹œì •ì§€</div>
    <button class="action-btn" onclick="resumeGame()">â–¶ ê³„ì†í•˜ê¸°</button>
    <button class="action-btn" style="background:#5d4037;" onclick="exitToMenu()">ğŸ  ë©”ë‰´ë¡œ ë‚˜ê°€ê¸°</button>
  </div>
</div>

<div id="quizModal" class="modal-bg">
  <div class="modal-box">
    <div style="font-size:28px; font-weight:800;">ì„±ê²½ í€´ì¦ˆ</div>
    <div id="quizQuestion" style="margin:20px 0; font-size:18px;"></div>
    <button class="choice-btn" onclick="answerQuiz('A')" id="btnA"></button>
    <button class="choice-btn" onclick="answerQuiz('B')" id="btnB"></button>
    <button class="choice-btn" onclick="answerQuiz('C')" id="btnC"></button>
  </div>
</div>

<div id="gameOverModal" class="modal-bg">
  <div class="modal-box">
    <div style="font-size:28px; font-weight:800;">GAME OVER</div>
    <div style="margin:20px 0;"><b><span id="finalDist"></span>m</b> ë‹¬ë ¸ìŠµë‹ˆë‹¤!</div>
    <input id="rankMsg" class="modal-input" type="text" placeholder="ì†Œê° ì…ë ¥(ì„ íƒ)" />
    <button class="action-btn" style="background:#5d4037;" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œí•˜ê¸°</button>
    <button class="action-btn" onclick="confirmRanking()">[ìˆœìœ„ë“±ë¡]</button>
  </div>
</div>

<div id="loadingQuiz">â³ ì„±ê²½ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
  // [ë³´ì•ˆ] F12 ì°¨ë‹¨
  document.addEventListener('keydown', function(e) {
    if (e.key === 'F12' || (e.ctrlKey && (e.shiftKey && (e.key === 'I' || e.key === 'J') || e.key === 'U'))) {
      e.preventDefault(); alert("ë³´ì•ˆì„ ìœ„í•´ ê°œë°œì ë„êµ¬ ì‚¬ìš©ì´ ì œí•œë©ë‹ˆë‹¤.");
    }
  });

  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  const sounds = {};
  ['bgm', 'jump', 'hit', 'item', 'parry', 'clear'].forEach(name => {
    sounds[name] = new Audio(`${name}.mp3`);
    if(name==='bgm') { sounds[name].loop = true; sounds[name].volume = 0.5; }
  });
  function playSound(name) { if(sounds[name]) { sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); } }

  let id = localStorage.getItem("run_id") || "test_user";
  let name = localStorage.getItem("run_name") || "Tester";
  let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");

  function hasFullCollection() {
    const hiddenSkins = ["Hidden_Skin1", "Hidden_Skin2", "Hidden_Skin3", "Hidden_Skin4", "Hidden_Skin5"];
    if(!saveData.ownedSkins) return false;
    return hiddenSkins.every(skin => saveData.ownedSkins.includes(skin));
  }
  const collectionBuff = hasFullCollection();

  let daily = JSON.parse(localStorage.getItem("dailyMission") || "{}");
  function initDailyMission() { return { date: new Date().toDateString(), run200: false, quiz3: 0, faith20: 0, completed: false, version: '3.0' }; }
  if (!daily.date || daily.date !== new Date().toDateString() || daily.version !== '3.0') {
    daily = initDailyMission(); localStorage.setItem("dailyMission", JSON.stringify(daily));
  }

  let life = 10 + (saveData.extraLife || 0);
  let maxLife = 10 + (saveData.extraLife || 0);
  let faith = saveData.faith || 0;
  let agility = saveData.agility || 0;
  let currentSkin = saveData.equippedSkin || "default";

  // ìŠ¤í‚¨ ë°ì´í„° (í•˜ì´ë¸Œë¦¬ë“œ/ì•¡í‹°ë¸Œ/íŒ¨ì‹œë¸Œ)
  const SKIN_DATA = {
    default: { type: "none" }, 
    noel: { type: "Hybrid", cd: 60 },      // 1:ì—ë„ˆì§€íŒŒ(60s), 2:ê±°ëŒ€í™”(Passive)
    jeonchan: { type: "Active", cd: 60 },  // 1:í•´ë¨¸, 2:ë²ˆê°œ(Passive)
    haeun: { type: "Passive", cd: 30 },    // ì‰´ë“œ/í
    jaeguk: { type: "Active", cd: 70 },    // 1:ë³´ë°”, 2:ë¶€í™œ(Passive)
    hahwi: { type: "Active", cd: 60 },     // 1:ëª¨ë˜í­í’, 2:ìŠ¤í†¤(Passive)
    jihye: { type: "Active", cd: 60 },     // 1:ë°œí‚¤ë¦¬, 2:í(Passive)
    jun: { type: "Active", cd: 90 },       // 1:í¬íƒˆê²Œì„, 2:ì–‘(Passive)
    stephanie: { type: "Active", cd: 70 }, // 1:ì¼€ì´í¬, 2:í•˜íŠ¸(Passive)
    yejun: { type: "Active", cd: 60 },     // 1:ë¹„í–‰, 2:ë„í”Œê°±ì–´(Passive)
    ganghui: { type: "Active", cd: 60 },   // 1:ê±´ë‹´, 2:íŒë„¬(Passive)
    jieun: { type: "Active", cd: 60 }      // 1:ìŒê³„, 2:ì‰´ë“œ(Passive)
  };

  const abilityBtn = document.getElementById('abilityBtn');
  if(SKIN_DATA[currentSkin] && (SKIN_DATA[currentSkin].type === "Active" || SKIN_DATA[currentSkin].type === "Hybrid")) {
      abilityBtn.style.display = 'flex';
  }

  document.getElementById("lifeText").innerText = life;
  document.getElementById("faithText").innerText = faith;

  const gameArea = document.getElementById("gameArea");
  const player = document.getElementById("player");
  const bg1 = document.getElementById("bgLayer1"); const bg2 = document.getElementById("bgLayer2"); const bg3 = document.getElementById("bgLayer3");

  if (currentSkin !== 'default') player.style.backgroundImage = `url('skin_${currentSkin}.png')`;
  else player.style.backgroundImage = `url('disciple.png')`;

  let buffArea = document.getElementById("buffArea");
  if(collectionBuff) buffArea.innerHTML += `<div class="buff-tag" style="border-color:#e040fb; order:999;">âœ¨ ì»¬ë ‰ì…˜ ë³´ë„ˆìŠ¤</div>`;

  let speedLines = document.getElementById("speedLines");
  let timeTunnelBg = document.getElementById("timeTunnelBg");

  let playerY = 40; let velocity = 0; 
  let gravity = -0.12; let jumpPower = Math.max(3, 4.2 - agility * 0.05);
  let targetY = 0; let distance = 0;
  let obstacles = []; let projectiles = []; let enemies = []; let playerMissiles = []; let faithCoins = [];
  let items = []; let combo = 0; let obstacleSurviveCount = 0; let rankingSaved = false;
  let running = false; let invincible = false;

  const BASE_SPEED = 170; let gameSpeed = BASE_SPEED;
  let lastTime = performance.now();
  let nextQuizDistance = 35; 
  let obstacleTimer = 0; let nextObstacleTime = 2.0;
  let enemySpawnTimer = 0;
  let itemTimer = 0; let nextItemTime = 8;
  let abilityCD = 0; 
  let abilityCD2 = 0; 
  let missionUpdateTimer = 0;

  // ìŠ¤í‚¨ë³„ ë³€ìˆ˜
  let jeonchanTimer = 0; let jeonchanLightningTimer = 0; 
  let haeunLifeTimer = 0; let haeunShieldTimer = 0; let haeunShieldActive = false;
  let jaegukRevivedOnce = false; let bobas = [];
  let hahwiStones = []; let hahwiOrbitAngle = 0; 
  let jihyeUnits = []; let jihyeMissiles = []; let jihyePassiveTimer = 0; let jihyeSphereTracker = null;
  let junLambTimer = 0; let isJunTimeTravel = false; let junMiniGameClicks = 0; let junMiniGameDist = 0;
  let ganghuiFunnels = []; let ganghuiLaserTimer = 0; let ganghuiPassiveTimer = 0;
  let stephanieCakes = []; let stephanieBgActive = false; let stephaniePassiveTimer = 0;
  let yejunClones = []; let yejunPassiveTimer = 0;
  let jieunNotes = []; let jieunPassiveTimer = 0; 
  let noelPassiveTimer = 0; 

  let bg1X = 0, bg2X = 0, bg3X = 0;
  const BG1_SPEED = 20; const BG2_SPEED = 40; const BG3_SPEED = 60;

  let activeEffects = { 
      turbo: 0, invincible: 0, slow: 0, fly: 0, revive: 0, 
      summon: 0, magnet: 0, noelLaser: 0, noelGiant: 0,
      bobaTime: 0, hahwiMode: 0, jihyeSquad: 0, 
      ganghuiMode: 0, stephanieWorld: 0, jieunWave: 0 
  };

  let feverGauge = 0; const MAX_FEVER = 100; let isFeverTime = false;
  let isBossBattle = false; let nextBossTrigger = 200; let bossLevel = 0;
  let boss = { hp: 6, maxHp: 6, x: 0, y: 50, vy: 0.5, state: 'idle', shootTimer: 0, actionTimer: 0 }; 
  let bossContainer = document.getElementById('bossContainer');
  let bossBody = document.getElementById('bossBody');
  let bossHpFill = document.getElementById('bossHpFill');
  let subActionBtn = document.getElementById('subActionBtn');
  let shieldCooldown = 0;

  function randBetween(min, max) { return Math.random() * (max - min) + min; }

  function spawnParticles(x, y, type) {
    const colors = type==='item' ? ['#ffd700','#fff'] : type==='spark' ? ['#ff4500','#ff8c00'] : ['#8b4513','#a0522d'];
    for(let i=0; i<8; i++) {
        const p = document.createElement('div');
        p.classList.add('particle');
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.width = (Math.random()*6+4)+'px'; p.style.height = p.style.width;
        p.style.left = x + 'px'; p.style.top = y + 'px';
        gameArea.appendChild(p);
        const tx = (Math.random()-0.5) * 100; const ty = (Math.random()-0.5) * 100;
        p.animate([ { transform: `translate(0,0)` }, { transform: `translate(${tx}px, ${ty}px)` } ], { duration: 600, fill: 'forwards' }).onfinish = () => p.remove();
    }
  }
  function spawnExplosionEffect(x, y) {
      const ex = document.createElement('div'); ex.classList.add('obstacle-explosion');
      ex.style.left = x + 'px'; ex.style.top = y + 'px';
      gameArea.appendChild(ex); setTimeout(() => ex.remove(), 400);
      playSound('hit');
  }
  // ì½”ì¸ ìƒì„± (autoCollect: trueë©´ ìë™, falseë©´ ìˆ˜ë™)
  function spawnFaithCoins(x, y, count, manualCollection = false, autoCollect = false) {
      for(let i=0; i<count; i++) {
          const coin = document.createElement('div');
          coin.classList.add('faith-coin');
          coin.isManual = manualCollection; coin.isAutoCollect = autoCollect; 
          const spreadMult = (!manualCollection && !autoCollect) ? 5 : 1;
          const spreadX = (Math.random() - 0.5) * 100 * spreadMult;
          const spreadY = (Math.random() - 0.5) * 100 * spreadMult;
          coin.style.left = x + 'px'; coin.style.top = y + 'px';
          coin.vx = spreadX; coin.vy = spreadY; coin.timer = 0;
          gameArea.appendChild(coin); faithCoins.push(coin);
      }
  }
  function showFloatText(text) { 
      const r=player.getBoundingClientRect(); const e=document.createElement("div"); 
      e.classList.add("float-text"); e.innerText=text; 
      e.style.left=(r.left+10)+"px"; e.style.top=(r.top-20)+"px"; 
      document.body.appendChild(e); setTimeout(()=>e.remove(),1000); 
  }
  function showHealEffect() {
      const heal = document.createElement('div'); heal.className = 'heal-effect-visual';
      heal.style.left = '50%'; heal.style.top = '50%'; player.appendChild(heal); 
      setTimeout(()=>heal.remove(), 600);
  }

  // 1. ì „ì°¬ (í•´ë¨¸, ë²ˆê°œ)
  function triggerJeonchanSkill() {
      showFloatText("ğŸ”¨ ì‹¬íŒì˜ ë§ì¹˜!");
      const hammer = document.createElement('div');
      hammer.className = 'hammer-unit';
      hammer.style.left = '-200px'; hammer.style.top = '20%';
      const trail = document.createElement('div'); trail.className = 'hammer-trail';
      hammer.appendChild(trail); gameArea.appendChild(hammer);
      
      hammer.animate([
          { left: '-200px', transform: 'rotate(0deg)' },
          { left: '120vw', transform: 'rotate(360deg)' }
      ], { duration: 20000, easing: 'linear' }).onfinish = () => { hammer.remove(); gameArea.classList.remove('shake-screen'); };
      
      gameArea.classList.add('shake-screen');
      hammer.id = 'activeHammer';
  }

  // 2. í•˜íœ˜ (ëª¨ë˜í­í’)
  function triggerHahwiSkill() {
      showFloatText("ğŸœï¸ ì‚¬ë§‰ì˜ í­í’!");
      activeEffects.hahwiMode = 15;
      activeEffects.invincible = 15; 
      gameArea.classList.add('sandstorm-mode');
      playSound('clear');
  }

  // 3. ì§€í˜œ (ë°œí‚¤ë¦¬)
  function triggerJihyeSkill() {
      showFloatText("âœ¨ ë°œí‚¤ë¦¬ ê°•ë¦¼!");
      const sphere = document.createElement('div'); sphere.className = 'jihye-transform-sphere';
      gameArea.appendChild(sphere);
      if(jihyeSphereTracker) clearInterval(jihyeSphereTracker);
      jihyeSphereTracker = setInterval(() => {
           const pRect = player.getBoundingClientRect();
           sphere.style.left = (pRect.left + 30) + 'px'; sphere.style.top = (pRect.top + 30) + 'px';
      }, 16);
      activeEffects.invincible = 2.5; 
      setTimeout(() => {
          clearInterval(jihyeSphereTracker); sphere.remove();
          player.style.backgroundImage = `url('Skill_JH.png')`;
          activeEffects.jihyeSquad = 20; 
          for(let i=1; i<=5; i++) {
              const unit = document.createElement('div'); unit.className = 'jihye-unit';
              unit.style.backgroundImage = `url('Skill_JH${i}.png')`; 
              unit.style.left = '-100px'; unit.style.top = randBetween(50, window.innerHeight/2) + 'px';
              unit.tx = (window.innerWidth/2) + randBetween(-100, 100);
              unit.ty = (window.innerHeight/2) + randBetween(-200, 0);
              unit.moveTimer = 0; unit.fireTimer = 0;
              gameArea.appendChild(unit); jihyeUnits.push(unit);
          }
      }, 2000);
  }
  function triggerJihyeHeal() {
      const healer = document.createElement('div'); healer.className = 'jihye-healer';
      const pRect = player.getBoundingClientRect();
      healer.style.left = pRect.left + 'px'; healer.style.top = '-100px';
      gameArea.appendChild(healer);
      const pillar = document.createElement('div'); pillar.className = 'holy-light-pillar';
      pillar.style.left = (pRect.left + 30) + 'px'; 
      gameArea.appendChild(pillar);
      requestAnimationFrame(() => { healer.style.top = (pRect.top - 80) + 'px'; });
      setTimeout(() => {
          if(life < maxLife + 5) { life = Math.min(life + 2, maxLife + 5); document.getElementById("lifeText").innerText = life; showHealEffect(); showFloatText("ğŸ’– ì„±ë…€ì˜ ì¹˜ìœ "); }
          healer.style.top = '-200px';
          setTimeout(() => { healer.remove(); pillar.remove(); }, 1500);
      }, 2000); 
  }

  // 4. ì¤€ (í¬íƒˆ ë¯¸ë‹ˆê²Œì„)
  function triggerJunSkill() {
      if(isJunTimeTravel) return;
      isJunTimeTravel = true; junMiniGameClicks = 0; junMiniGameDist = 0;
      showFloatText("â³ íƒ€ì„ ì›Œí”„ ê°œì‹œ!");
      const portal = document.createElement('div'); portal.className = 'time-portal';
      const pRect = player.getBoundingClientRect();
      portal.style.left = (pRect.left + 30) + 'px'; portal.style.top = (pRect.top + 30) + 'px';
      gameArea.appendChild(portal);
      requestAnimationFrame(() => portal.classList.add('active'));
      setTimeout(() => {
          timeTunnelBg.style.display = 'flex';
          document.getElementById('junMiniGameUI').style.display = 'block';
          setTimeout(() => { timeTunnelBg.style.opacity = '1'; }, 50);
          player.style.opacity = '0';
          let timeLeft = 10;
          let timerInterval = setInterval(() => {
              timeLeft -= 0.1;
              document.querySelectorAll('.tunnel-star').forEach(s => s.style.animationDuration = Math.max(0.1, 0.5 - (junMiniGameClicks * 0.01)) + 's');
              if(timeLeft <= 0) { clearInterval(timerInterval); finishJunMiniGame(portal); }
          }, 100);
      }, 1000);
  }
  function finishJunMiniGame(portal) {
      let finalBonus = Math.floor(Math.min(junMiniGameDist, 50)); 
      distance += finalBonus; showFloatText(`â© +${finalBonus}m ì›Œí”„ ì„±ê³µ!`);
      timeTunnelBg.style.opacity = '0';
      setTimeout(() => {
          timeTunnelBg.style.display = 'none'; player.style.opacity = '1';
          isJunTimeTravel = false; portal.classList.remove('active');
          setTimeout(()=>portal.remove(), 500);
      }, 500);
  }
  timeTunnelBg.addEventListener('touchstart', handleJunTap);
  timeTunnelBg.addEventListener('mousedown', handleJunTap);
  document.addEventListener('keydown', (e) => { if(isJunTimeTravel && e.code === 'Space') handleJunTap(e); });
  function handleJunTap(e) {
      if(!isJunTimeTravel) return;
      if(e.type !== 'keydown') { e.preventDefault(); e.stopPropagation(); }
      junMiniGameClicks++;
      let boost = 1; 
      junMiniGameDist += boost;
      document.getElementById('junDistanceDisplay').innerText = Math.floor(junMiniGameDist) + "m";
      playSound('jump');
      const msg = document.getElementById('junMiniGameMsg');
      msg.style.transform = "scale(1.2)"; setTimeout(()=>msg.style.transform="scale(1)", 100);
  }

  // 5. ê°•í¬ (ê±´ë‹´)
  function triggerGanghuiSkill() {
      showFloatText("ğŸ¤– ëª¨ë¹ŒìŠˆíŠ¸ ì „ê°œ!");
      activeEffects.ganghuiMode = 15; activeEffects.invincible = 15;
      document.getElementById('gundamEffect').style.display = 'block';
      for(let i=0; i<6; i++) {
          const f = document.createElement('div'); f.className = 'funnel-unit';
          f.angle = i * (Math.PI/3);
          gameArea.appendChild(f); ganghuiFunnels.push(f);
      }
      playSound('clear');
  }

  // 6. ìŠ¤í…ŒíŒŒë‹ˆ (ì¼€ì´í¬)
  function triggerStephanieSkill() {
      showFloatText("ğŸ‚ ë‹¬ì½¤í•œ ì´ˆëŒ€!");
      activeEffects.stephanieWorld = 20;
      stephanieBgActive = true;
      document.getElementById('cakeBgLayer').style.display = 'block';
      setTimeout(() => document.getElementById('cakeBgLayer').style.opacity = '1', 100);
  }

  // 7. ì˜ˆì¤€ (ë¹„í–‰)
  function triggerYejunSkill() {
      showFloatText("ğŸ‘» íŒ¬í…€ í”Œë¼ì´íŠ¸!");
      activeEffects.fly = 20;
      document.getElementById('yejunWing').style.display = 'block';
  }

  // 8. ì§€ì€ (ë©œë¡œë”” ì›¨ì´ë¸Œ)
  function triggerJieunSkill() {
      showFloatText("ğŸµ íë§ ë©œë¡œë””!");
      activeEffects.jieunWave = 10;
      document.getElementById('melodyWaveBg').style.display = 'block';
      let waveInt = setInterval(() => {
          if(activeEffects.jieunWave <= 0) { clearInterval(waveInt); return; }
          spawnJieunNote();
      }, 300);
  }
  function spawnJieunNote() {
      const note = document.createElement('div'); note.className = 'jieun-note';
      note.innerText = ['â™ª', 'â™¬', 'â™©'][Math.floor(Math.random()*3)];
      const pRect = player.getBoundingClientRect();
      note.style.left = (pRect.left + 30) + 'px'; note.style.top = (pRect.top) + 'px';
      note.style.color = `hsl(${Math.random()*360}, 100%, 70%)`;
      note.vx = 400; note.vy = randBetween(-100, 100);
      gameArea.appendChild(note); jieunNotes.push(note);
  }

  // 9. ì¬êµ­ (ë³´ë°”)
  function triggerJaegukBobas() {
      showFloatText("ğŸ§‹ ë²„ë¸”í‹° íŒŒì›Œ!");
      activeEffects.bobaTime = 20; 
      for(let i=0; i<5; i++) {
          const b = document.createElement('div'); b.className = 'boba-unit';
          b.angle = (i / 5) * Math.PI * 2; b.radius = 60; 
          gameArea.appendChild(b); bobas.push(b);
      }
      playSound('item');
  }

  // === ë²„íŠ¼ ì…ë ¥ ì²˜ë¦¬ ===
  function useAbility(e) { 
    if(e) e.stopPropagation();
    if(!running || abilityCD > 0) return;
    const s = SKIN_DATA[currentSkin];

    if(currentSkin === 'noel') {
        showFloatText("ğŸŒŠ ì—ë„ˆì§€ íŒŒ!");
        activeEffects.noelLaser = 10; 
        const beam = document.createElement('div'); beam.id = 'noelBeam'; beam.className = 'noel-beam';
        let offset = activeEffects.noelGiant > 0 ? 50 : 20;
        const pRect = player.getBoundingClientRect();
        beam.style.bottom = (window.innerHeight - pRect.bottom + offset) + "px";
        gameArea.appendChild(beam);
        playSound('jump'); 
        abilityCD = 60; 
    } 
    else {
        if(currentSkin === 'jaeguk') triggerJaegukBobas();
        else if(currentSkin === 'hahwi') triggerHahwiSkill();
        else if(currentSkin === 'jihye') triggerJihyeSkill();
        else if(currentSkin === 'jun') triggerJunSkill();
        else if(currentSkin === 'yejun') triggerYejunSkill();
        else if(currentSkin === 'stephanie') triggerStephanieSkill();
        else if(currentSkin === 'ganghui') triggerGanghuiSkill();
        else if(currentSkin === 'jieun') triggerJieunSkill();
        else if(currentSkin === 'jeonchan') triggerJeonchanSkill();
        abilityCD = s.cd;
    }
  }

  // ë²„íŠ¼ 2 (ì‚¬ìš© ì•ˆí•¨)
  function useAbility2(e) {}

  // === ë©”ì¸ ë£¨í”„ ===
  function gameLoop(now) {
    if (!running) return;
    const delta = (now - lastTime) / 1000; lastTime = now;
    const safeDelta = Math.min(delta, 0.05);

    try {
        updateBuffUI(safeDelta); checkMissions();
        missionUpdateTimer += safeDelta;
        if(missionUpdateTimer > 1.0) { updateDailyMissionUI(); missionUpdateTimer = 0; }

        // --- íŒ¨ì‹œë¸Œ ìŠ¤í‚¬ ë¡œì§ ---
        if(running && !isBossBattle) {
            // ì „ì°¬ (ë¦¬ì–¼ ë²ˆê°œ)
            if(currentSkin === 'jeonchan') {
                jeonchanLightningTimer += safeDelta;
                if(jeonchanLightningTimer > 15.0) {
                    jeonchanLightningTimer = 0;
                    const flash = document.createElement('div'); flash.className = 'jc-lightning';
                    flash.style.left = randBetween(50, window.innerWidth-50) + 'px';
                    gameArea.appendChild(flash); setTimeout(()=>flash.remove(), 300);
                }
            }
            // í•˜ì€ (ì‰´ë“œ/í)
            if(currentSkin === 'haeun') {
                if(!haeunShieldActive) {
                    haeunShieldTimer += safeDelta;
                    if(haeunShieldTimer >= 10.0) {
                        haeunShieldActive = true; haeunShieldTimer = 0;
                        createHaeunShield(); showFloatText("ğŸ›¡ï¸ ë³´í˜¸ë§‰ ìƒì„±");
                    }
                }
                haeunLifeTimer += safeDelta;
                if(haeunLifeTimer >= 25.0) {
                    haeunLifeTimer = 0;
                    if(life < maxLife) { life++; document.getElementById("lifeText").innerText = life; showHealEffect(); }
                }
            }
            // ì§€í˜œ (í)
            if(currentSkin === 'jihye') {
                jihyePassiveTimer += safeDelta;
                if(jihyePassiveTimer >= 25.0) { triggerJihyeHeal(); jihyePassiveTimer = 0; }
            }
            // ì¤€ (ì–‘)
            if(currentSkin === 'jun' && !isJunTimeTravel) {
                junLambTimer += safeDelta;
                if(junLambTimer >= 30.0) {
                    const lamb = document.createElement('div'); lamb.className = 'lamb-unit';
                    lamb.style.left = (window.innerWidth + 50) + 'px'; lamb.style.top = '50px'; 
                    gameArea.appendChild(lamb);
                    let lTimer = setInterval(()=>{
                        let lx = parseFloat(lamb.style.left); lx -= 2; lamb.style.left = lx+'px';
                        if(lx < 150) { 
                            clearInterval(lTimer); lamb.remove();
                            if(life<maxLife) { life++; document.getElementById("lifeText").innerText=life; showHealEffect(); }
                        }
                    }, 20);
                    junLambTimer = 0;
                }
            }
            // í•˜íœ˜ (ì¸í”¼ë‹ˆí‹° ìŠ¤í†¤)
            if(currentSkin === 'hahwi') {
                if(activeEffects.hahwiMode <= 0 && hahwiStones.length === 0) { 
                    // íŒ¨ì‹œë¸Œ ìƒì„± ë¡œì§ì´ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€. 
                    // í˜„ì¬ëŠ” ì•¡í‹°ë¸Œ ë°œë™ ì‹œì—ë§Œ ìƒì„±ë˜ëŠ” êµ¬ì¡°ë‚˜, 30ì´ˆë§ˆë‹¤ ìƒì„± ìš”ì²­ì´ ìˆì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€.
                    // (ì½”ë“œê°€ ê¸¸ì–´ì§€ë¯€ë¡œ ìƒëµë˜ì—ˆë˜ ë¶€ë¶„ ë³µêµ¬)
                    if(!this.hahwiPassiveWait) this.hahwiPassiveWait = 0;
                    this.hahwiPassiveWait += safeDelta;
                    if(this.hahwiPassiveWait > 30.0) {
                        this.hahwiPassiveWait = 0;
                        for(let i=0; i<6; i++) {
                             const s = document.createElement('div'); s.className = 'infinity-stone';
                             s.style.background = ['#f00','#0f0','#00f','#ff0','#0ff','#f0f'][i];
                             s.angleOffset = i * (Math.PI / 3);
                             gameArea.appendChild(s); hahwiStones.push(s);
                        }
                    }
                }
                if(hahwiStones.length > 0) {
                    hahwiOrbitAngle += 3 * safeDelta;
                    const pRect = player.getBoundingClientRect();
                    const cx = pRect.left + pRect.width/2; const cy = pRect.top + pRect.height/2;
                    hahwiStones.forEach(s => {
                        const r = 70;
                        s.style.left = (cx + Math.cos(hahwiOrbitAngle + s.angleOffset) * r - 12) + 'px';
                        s.style.top = (cy + Math.sin(hahwiOrbitAngle + s.angleOffset) * r - 12) + 'px';
                    });
                    // ìŠ¤í†¤ ê°œë³„ ì¶©ëŒ ë¡œì§ (ë³µêµ¬)
                    for(let i=hahwiStones.length-1; i>=0; i--) {
                        const s = hahwiStones[i]; const sRect = s.getBoundingClientRect();
                        for(let j=obstacles.length-1; j>=0; j--) {
                            const o = obstacles[j];
                            if(!o.destroyed) {
                                const oRect = o.getBoundingClientRect();
                                if (sRect.right > oRect.left && sRect.left < oRect.right && sRect.bottom > oRect.top && sRect.top < oRect.bottom) {
                                    o.destroyed = true; spawnExplosionEffect(oRect.left, oRect.top);
                                    spawnFaithCoins(oRect.left, oRect.top, 2, false, false); // ìˆ˜ë™
                                    o.remove(); obstacles.splice(j,1); 
                                }
                            }
                        }
                        for(let k=enemies.length-1; k>=0; k--) {
                            const en = enemies[k];
                            if(!en.isDead) {
                                const enRect = en.getBoundingClientRect();
                                if (sRect.right > enRect.left && sRect.left < enRect.right && sRect.bottom > enRect.top && sRect.top < enRect.bottom) {
                                    en.isDead = true; spawnExplosionEffect(en.x, en.y);
                                    spawnFaithCoins(en.x, en.y, 5, true, false);
                                    en.remove(); enemies.splice(k,1);
                                }
                            }
                        }
                    }
                }
            }
            // ê°•í¬ (íŒë„¬ ì¦ì‹)
            if(currentSkin === 'ganghui') {
                ganghuiPassiveTimer += safeDelta;
                if(ganghuiPassiveTimer >= 15.0 && ganghuiFunnels.length < 8) {
                    ganghuiPassiveTimer = 0;
                    const f = document.createElement('div'); f.className = 'funnel-unit';
                    f.angle = 0; gameArea.appendChild(f); ganghuiFunnels.push(f);
                }
                const pRect = player.getBoundingClientRect();
                const cx = pRect.left + pRect.width/2; const cy = pRect.top + pRect.height/2;
                ganghuiFunnels.forEach((f, idx) => {
                    f.angle = (Date.now()/1000) + (idx * (Math.PI*2/ganghuiFunnels.length));
                    f.style.left = (cx + Math.cos(f.angle)*90 - 20) + 'px';
                    f.style.top = (cy + Math.sin(f.angle)*90 - 20) + 'px';
                });
                ganghuiLaserTimer += safeDelta;
                if(ganghuiLaserTimer > 4.0 && ganghuiFunnels.length > 0) {
                    ganghuiLaserTimer = 0;
                    let target = obstacles[0] || enemies[0];
                    if(target && !target.destroyed && !target.isDead) {
                        const f = ganghuiFunnels[Math.floor(Math.random()*ganghuiFunnels.length)];
                        const laser = document.createElement('div'); laser.className = 'funnel-laser';
                        const fRect = f.getBoundingClientRect(); const tRect = target.getBoundingClientRect();
                        const dx = (tRect.left+30)-(fRect.left+20); const dy = (tRect.top+30)-(fRect.top+20);
                        const dist = Math.hypot(dx,dy); const angle = Math.atan2(dy,dx);
                        laser.style.width = dist+'px'; laser.style.left=(fRect.left+20)+'px'; laser.style.top=(fRect.top+20)+'px';
                        laser.style.transform = `rotate(${angle}rad)`;
                        gameArea.appendChild(laser); setTimeout(()=>laser.remove(), 100);
                        
                        if(target.classList.contains('obstacle')) {
                            target.destroyed = true; spawnExplosionEffect(tRect.left, tRect.top);
                            spawnFaithCoins(tRect.left, tRect.top, 2, false, false);
                            target.remove(); obstacles.shift();
                        } else {
                            target.isDead = true; spawnExplosionEffect(target.x, target.y);
                            spawnFaithCoins(target.x, target.y, 3, false, false);
                            target.remove(); enemies.shift();
                        }
                    }
                }
            }
            // ì˜ˆì¤€ (ë„í”Œê°±ì–´)
            if(currentSkin === 'yejun') {
                yejunPassiveTimer += safeDelta;
                if(yejunPassiveTimer >= 60.0) {
                    yejunPassiveTimer = 0;
                    const poof = document.createElement('div'); poof.className = 'smoke-poof';
                    const pRect = player.getBoundingClientRect();
                    poof.style.left = pRect.left+'px'; poof.style.top = pRect.top+'px';
                    gameArea.appendChild(poof); setTimeout(()=>poof.remove(), 500);
                    for(let i=0; i<5; i++) {
                        const m = document.createElement("div"); m.classList.add("player-missile");
                        m.style.left = (pRect.right) + "px"; m.style.top = (pRect.top + randBetween(-50,50)) + "px"; 
                        gameArea.appendChild(m); playerMissiles.push(m);
                    }
                }
            }
            // ìŠ¤í…ŒíŒŒë‹ˆ (í•˜íŠ¸ í)
            if(currentSkin === 'stephanie') {
                stephaniePassiveTimer += safeDelta;
                if(stephaniePassiveTimer >= 30.0) {
                    stephaniePassiveTimer = 0;
                    if(life < maxLife) { life++; document.getElementById("lifeText").innerText = life; showHealEffect(); }
                }
            }
            // ì§€ì€ (ë…¸ì—˜ ìˆ˜í˜¸)
            if(currentSkin === 'jieun') {
                jieunPassiveTimer += safeDelta;
                if(jieunPassiveTimer >= 45.0) {
                    jieunPassiveTimer = 0;
                    const shield = document.createElement('div'); shield.className = 'jieun-shield-unit';
                    player.appendChild(shield); setTimeout(()=>shield.remove(), 5000); 
                    activeEffects.summon = 5; 
                }
            }
            // ë…¸ì—˜ (ê±°ëŒ€í™”)
            if(currentSkin === 'noel') {
                noelPassiveTimer += safeDelta;
                if(noelPassiveTimer >= 30.0) {
                    noelPassiveTimer = 0;
                    activeEffects.noelGiant = 10; activeEffects.invincible = 10;
                    player.classList.add('player-giant'); document.getElementById('noelAura').style.display='block';
                    showFloatText("ğŸ¦ ê±°ëŒ€í™” ë°œë™!");
                }
            }
        } 

        // --- ì•¡í‹°ë¸Œ ìŠ¤í‚¬ ë¡œì§ ---
        const hammer = document.getElementById('activeHammer');
        if(hammer) {
            const hRect = hammer.getBoundingClientRect();
            obstacles.forEach(o => {
                if(!o.destroyed && o.getBoundingClientRect().left < hRect.right) {
                    o.destroyed = true; spawnExplosionEffect(parseFloat(o.style.left), window.innerHeight-100);
                    spawnFaithCoins(parseFloat(o.style.left), window.innerHeight-150, 3, false, false);
                    o.remove();
                }
            });
            enemies.forEach(e => {
                if(!e.isDead && e.getBoundingClientRect().left < hRect.right) {
                    e.isDead = true; spawnExplosionEffect(e.x, e.y);
                    spawnFaithCoins(e.x, e.y, 5, true, false); e.remove();
                }
            });
        }

        // ì§€ì€ ìŒí‘œ ì¶©ëŒ
        for(let i=jieunNotes.length-1; i>=0; i--) {
            const n = jieunNotes[i]; const nRect = n.getBoundingClientRect();
            if(nRect.left > window.innerWidth) { n.remove(); jieunNotes.splice(i,1); continue; }
            // ì êµ°ë§Œ ì²˜ë¦¬ (ì¥ì• ë¬¼ ì¶”ê°€ ê°€ëŠ¥)
            for(let k=enemies.length-1; k>=0; k--) {
                 const e = enemies[k];
                 if(!e.isDead) {
                     const eRect = e.getBoundingClientRect();
                     if(nRect.right > eRect.left && nRect.left < eRect.right && nRect.bottom > eRect.top && nRect.top < eRect.bottom) {
                         e.isDead = true; spawnExplosionEffect(e.x, e.y);
                         spawnFaithCoins(e.x, e.y, 3, true, false);
                         e.remove(); enemies.splice(k,1);
                     }
                 }
            }
        }

        // ìŠ¤í…ŒíŒŒë‹ˆ ì¼€ì´í¬ ì¶©ëŒ
        if(activeEffects.stephanieWorld > 0) {
            if(Math.random() < 0.08) { 
                const cake = document.createElement('div'); cake.className = 'falling-cake';
                cake.style.backgroundImage = `url('item_cake${Math.floor(Math.random()*3)+1}.png')`;
                cake.style.left = randBetween(50, window.innerWidth-50) + 'px'; cake.style.top = '-50px';
                gameArea.appendChild(cake); stephanieCakes.push(cake);
            }
            for(let i=stephanieCakes.length-1; i>=0; i--) {
                const c = stephanieCakes[i]; const cRect = c.getBoundingClientRect();
                if(cRect.top > window.innerHeight) { c.remove(); stephanieCakes.splice(i,1); continue; }
                // í”Œë ˆì´ì–´ í
                const pRect = player.getBoundingClientRect();
                if(pRect.right > cRect.left && pRect.left < cRect.right && pRect.bottom > cRect.top && pRect.top < cRect.bottom) {
                    c.remove(); stephanieCakes.splice(i,1);
                    if(life < maxLife) life++; 
                    faith += 5; document.getElementById("faithText").innerText = faith;
                    playSound('item');
                }
            }
        }

        // ë…¸ì—˜ ë¹” ìœ„ì¹˜
        if(activeEffects.noelLaser > 0) {
            const beam = document.getElementById('noelBeam');
            if(beam) {
                let offset = activeEffects.noelGiant > 0 ? 50 : 20;
                beam.style.bottom = (playerY + offset) + "px";
            }
        }

        // ê²Œì„ ì§„í–‰
        if (!isBossBattle && !isJunTimeTravel) { 
            let distMultiplier = (activeEffects.turbo > 0) ? 4 : 1;
            distance += safeDelta * 1 * distMultiplier;
            document.getElementById("distanceText").innerText = Math.floor(distance) + "m";
            let progress = Math.min(distance / 3000, 1);
            gameSpeed = BASE_SPEED * (1 + progress * 14);
            if (activeEffects.slow > 0) gameSpeed *= 0.5;
            if (activeEffects.turbo > 0) gameSpeed *= 2.0; 
        } else if (isJunTimeTravel) { gameSpeed = 0; } 
        else { gameSpeed = BASE_SPEED * 0.5; }

        if (!isBossBattle && distance >= nextBossTrigger) { startBossBattle(); }
        if (!isBossBattle && distance >= nextQuizDistance) { nextQuizDistance += 35; pauseForQuiz(); return; }

        if (isBossBattle) { updateBoss(safeDelta); }
        else if (!isJunTimeTravel) { 
            obstacleTimer += safeDelta;
            if (obstacleTimer >= nextObstacleTime && (nextQuizDistance - distance > 2)) {
                spawnObstacle(); obstacleTimer = 0; 
                let sm = gameSpeed / BASE_SPEED;
                nextObstacleTime = randBetween(1.8, 2.6) / (1 + (sm - 1) * 0.6); 
                if (nextObstacleTime < 0.2) nextObstacleTime = 0.2;
            }
            enemySpawnTimer += safeDelta;
            if(enemySpawnTimer > 2.5 && !isBossBattle) { spawnEnemyLogic(); enemySpawnTimer = 0; }
        }

        updateEnemies(safeDelta); updatePhysics(safeDelta); updateFaithCoinsLogic(safeDelta);
        itemTimer += safeDelta;
        if (itemTimer >= nextItemTime && !isJunTimeTravel) { spawnItem(); itemTimer = 0; nextItemTime = 8 + Math.random() * 4; }

        // ì•„ì´í…œ ë¡œì§
        for (let i = items.length - 1; i >= 0; i--) {
            let it = items[i];
            if (activeEffects.magnet > 0) {
                const pRect = player.getBoundingClientRect(); const iRect = it.getBoundingClientRect();
                const dx = (pRect.left+30) - (iRect.left+24); const dy = (pRect.top+30) - (iRect.top+24);
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 400) { it.style.left = (parseFloat(it.style.left) + (dx/dist)*12) + "px"; it.style.top = (parseFloat(it.style.top) + (dy/dist)*12) + "px"; }
            }
            let left = parseFloat(it.style.left) || window.innerWidth;
            left -= gameSpeed * safeDelta;
            it.style.left = left + "px";
            if (left < -60) { it.remove(); items.splice(i, 1); continue; }
            const rP = player.getBoundingClientRect(); const rI = it.getBoundingClientRect();
            if (rP.left < rI.right && rP.right > rI.left && rP.top < rI.bottom && rP.bottom > rI.top) {
                activateItem(it.dataset.type); it.remove(); items.splice(i, 1);
                spawnParticles(rI.left, rI.top, 'item'); playSound('item');
                if(!isFeverTime) feverGauge = Math.min(feverGauge + 10, MAX_FEVER);
                saveProgress();
            }
        }
        
        let speedMult = (gameSpeed / BASE_SPEED); 
        bg1X -= BG1_SPEED * speedMult * safeDelta; bg2X -= BG2_SPEED * speedMult * safeDelta; bg3X -= BG3_SPEED * speedMult * safeDelta;
        bg1.style.backgroundPosition = `${bg1X}px 0`; bg2.style.backgroundPosition = `${bg2X}px bottom`; bg3.style.backgroundPosition = `${bg3X}px bottom`;
    } catch(e) { console.error(e); }
    requestAnimationFrame(gameLoop);
  }

  // === ì¶©ëŒ ì²´í¬ í—¬í¼ ì œê±° í›„ ì›ë³¸ ë°©ì‹ ë³µê·€ ì™„ë£Œ ===

  function updateFaithCoinsLogic(dt) {
      for(let i = faithCoins.length - 1; i >= 0; i--) {
          const coin = faithCoins[i]; coin.timer += dt;
          let cx = parseFloat(coin.style.left); let cy = parseFloat(coin.style.top);
          if (coin.timer < 0.3) { cx += coin.vx * dt * 2; cy += coin.vy * dt * 2; } 
          else {
              const pRect = player.getBoundingClientRect();
              const dx = (pRect.left+30) - cx; const dy = (pRect.top+30) - cy;
              if (coin.isAutoCollect) { cx += dx * 8 * dt; cy += dy * 8 * dt; } 
              else { cx -= gameSpeed * dt; } 
              if (Math.abs(dx) < 40 && Math.abs(dy) < 40) { 
                  let gain = 1; if(collectionBuff && Math.random() < 0.1) gain = 2;
                  faith += gain; daily.faith20 += gain; 
                  document.getElementById("faithText").innerText = faith; playSound('item'); 
                  if(coin.isManual) showFloatText("+1 ì‹ ì•™ì‹¬");
                  coin.remove(); faithCoins.splice(i, 1); continue;
              }
          }
          if(cx < -50) { coin.remove(); faithCoins.splice(i, 1); continue; }
          coin.style.left = cx + "px"; coin.style.top = cy + "px";
      }
  }

  // === ì êµ° ë° ë¬¼ë¦¬ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ===
  function spawnEnemyLogic() {
      let type = 0;
      if (distance >= 500) type = 5; else if (distance >= 450) type = 4;
      else if (distance >= 400) type = 3; else if (distance >= 300) type = 2; else if (distance >= 200) type = 1;
      if (type > 0 && Math.random() < 0.6) spawnEnemy(type);
  }
  function spawnEnemy(type) {
      const e = document.createElement("div"); e.classList.add("enemy");
      e.style.backgroundImage = `url('enemy${type}.png')`; e.style.backgroundColor = 'transparent'; 
      e.type = type; e.hp = 1; e.timer = 0; e.state = 'enter'; 
      e.x = window.innerWidth + 50; e.y = randBetween(50, window.innerHeight - 150);
      e.style.left = e.x + "px"; e.style.top = e.y + "px";
      gameArea.appendChild(e); enemies.push(e);
  }
  function updateEnemies(dt) {
    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i]; e.timer += dt;
        if(e.laserWarning) { e.laserWarning.style.width = e.x + "px"; e.laserWarning.style.top = (e.y + 30) + "px"; }
        if(e.laserBeam) { e.laserBeam.style.width = e.x + "px"; e.laserBeam.style.top = (e.y + 15) + "px"; }

        if (activeEffects.noelGiant > 0 && e.x < window.innerWidth) {
             const pRect = player.getBoundingClientRect(); const eRect = e.getBoundingClientRect();
             if(pRect.right > eRect.left && pRect.left < eRect.right && pRect.bottom > eRect.top && pRect.top < eRect.bottom) {
                 e.isDead = true; 
                 spawnExplosionEffect(e.x, e.y); spawnFaithCoins(e.x, e.y, 5, true, false); 
                 showFloatText("ğŸ¦ ì••ë„ì  í˜!");
                 e.remove(); enemies.splice(i,1); continue;
             }
        }
        if (activeEffects.noelLaser > 0 && e.x < window.innerWidth) {
            const beam = document.getElementById('noelBeam');
            if(beam) {
                const bRect = beam.getBoundingClientRect(); const eRect = e.getBoundingClientRect();
                if(bRect.right > eRect.left && bRect.top < eRect.bottom && bRect.bottom > eRect.top) {
                    spawnExplosionEffect(e.x + 30, e.y + 30); spawnFaithCoins(e.x + 30, e.y + 30, 4 + e.type, true, false); 
                    showFloatText("ğŸ’¥ ë ˆì´ì € ë¶„ì‡„!");
                    e.isDead = true; e.remove(); enemies.splice(i, 1); continue;
                }
            }
        }
        if (isFeverTime && e.x < window.innerWidth) {
           if (!e.feverTimer) e.feverTimer = 0; e.feverTimer += dt;
           if (e.feverTimer > 1.0) {
               spawnExplosionEffect(e.x + 30, e.y + 30); spawnFaithCoins(e.x + 30, e.y + 30, 4 + e.type, true, false);
               showFloatText("ğŸ’¥ ì êµ° ì„¬ë©¸!");
               e.isDead = true; e.remove(); enemies.splice(i, 1); continue;
           }
        }
        if(e.state === 'enter') { e.x -= 100 * dt; if (e.x < window.innerWidth - 150) { e.state = 'attack'; e.timer = 1.1; } } 
        else if (e.state === 'attack') {
            if (e.type === 1) { if (e.timer < 2.0) e.y += Math.sin(e.timer * 5) * 2; else e.x -= 300 * dt; }
            else if (e.type >= 2 && e.type <= 5) { e.y += Math.sin(Date.now() / 400) * 1.5; }
            if (e.type === 2 && e.timer > 1.0) { spawnEnemyProjectile(e.x, e.y + 30, 'single', e); e.timer = 0; }
            else if (e.type === 3 && e.timer > 1.0) { spawnEnemyProjectile(e.x, e.y + 30, 'fan', e); e.timer = 0; }
            else if (e.type === 4 && e.timer > 1.0) { spawnEnemyProjectile(e.x, e.y + 30, 'explode', e); e.timer = 0; }
            else if (e.type === 5 && e.timer > 1.0 && !e.isFiring) { fireEnemyLaser(e); } 
        }
        e.style.left = e.x + "px"; e.style.top = e.y + "px";
        if (e.x < -100) { e.isDead = true; e.remove(); enemies.splice(i, 1); }
    }
  }
  function spawnEnemyProjectile(x, y, pattern, ownerEnemy) {
      if(pattern === 'single') createProj(x, y, -200, 0, ownerEnemy); 
      else if (pattern === 'fan') { createProj(x, y, -300, 0, ownerEnemy); createProj(x, y, -280, 100, ownerEnemy); createProj(x, y, -280, -100, ownerEnemy); }
      else if (pattern === 'explode') { let p = createProj(x, y, -250, 0, ownerEnemy); p.isExplosive = true; }
  }
  function createProj(x, y, vx, vy, owner) {
      const p = document.createElement("div"); p.classList.add("projectile", "enemy-missile");
      p.style.left = x + "px"; p.style.top = y + "px"; p.x = x; p.y = y; p.vx = vx; p.vy = vy;
      if(owner) p.owner = owner; 
      gameArea.appendChild(p); projectiles.push(p); return p;
  }
  function fireEnemyLaser(e) {
      e.isFiring = true; 
      const warning = document.createElement("div"); warning.className = "enemy-laser-warning";
      warning.style.left = "0px"; warning.style.width = e.x + "px"; warning.style.top = (e.y + 30) + "px";
      gameArea.appendChild(warning); e.laserWarning = warning; 
      setTimeout(() => {
          if(e.isDead) { warning.remove(); return; } warning.remove(); e.laserWarning = null;
          const laser = document.createElement("div"); laser.className = "enemy-laser-beam";
          laser.style.left = "0px"; laser.style.width = e.x + "px"; laser.style.top = (e.y + 15) + "px";
          gameArea.appendChild(laser); e.laserBeam = laser; 
          let duration = 0;
          let check = setInterval(() => {
              if(e.isDead) { clearInterval(check); laser.remove(); return; }
              duration += 0.1; let laserY = parseFloat(laser.style.top);
              if(Math.abs(playerY - (window.innerHeight - laserY)) < 30 && !invincible) damageLife();
              if(duration > 5.0) { clearInterval(check); laser.remove(); e.laserBeam = null; setTimeout(() => { e.isFiring = false; e.timer = 0; }, 2000); }
          }, 100);
      }, 1000); 
  }
  function spawnItem() {
    const types = ['invincible', 'turbo', 'slow', 'faith'];
    const images = { 'invincible': 'url("item_cross.png")', 'turbo': 'url("item_wings.png")', 'slow': 'url("item_wind.png")', 'faith': 'url("item_bible.png")' };
    const item = document.createElement("div"); const type = types[Math.floor(Math.random() * types.length)];
    item.classList.add("item"); item.dataset.type = type; item.style.backgroundImage = images[type]; 
    item.x = window.innerWidth + 50; item.style.left = item.x + "px"; item.style.top = randBetween(100, window.innerHeight - 150) + "px";
    document.getElementById("gameArea").appendChild(item); items.push(item);
  }
  function activateItem(type) {
    if(type === 'invincible') { activeEffects.invincible = 10; showFloatText("ğŸ›¡ï¸ ë¬´ì !"); }
    else if(type === 'turbo') { activeEffects.turbo = 5; showFloatText("ğŸš€ í„°ë³´!"); }
    else if(type === 'slow') { activeEffects.slow = 10; showFloatText("ğŸƒ ê°ì†"); }
    else if(type === 'faith') { 
        let gain = 10; if(collectionBuff) gain = 11;
        faith += gain; daily.faith20 += gain; updateDailyMissionUI(); showFloatText(`ğŸ“˜ Faith +${gain}`); 
    }
    document.getElementById("faithText").innerText = faith;
  }
  function startBossBattle() {
    isBossBattle = true; bossLevel++; boss.maxHp = 6 + (bossLevel-1)*4; boss.hp = boss.maxHp; 
    invincible = false; if(isFeverTime) endFeverTime();
    player.style.left = "50px"; 
    showFloatText(`âš ï¸ BOSS LV.${bossLevel} WARNING!`);
    const warning = document.getElementById('bossWarning'); warning.innerText = `âš ï¸ BOSS LV.${bossLevel}!!`;
    warning.style.display = 'block'; setTimeout(() => warning.style.display = 'none', 3000);
    obstacles.forEach(o => o.remove()); obstacles = []; enemies.forEach(e => e.remove()); enemies = []; 
    bossContainer.style.display = 'block'; setTimeout(() => { bossContainer.style.right = '20px'; }, 100);
    document.getElementById('dailyMissionBox').style.display = 'none'; saveProgress();
  }
  function updateBoss(delta) {
    if (boss.hp <= 0) return;
    boss.actionTimer += delta;
    if (boss.state === 'idle') { boss.y += boss.vy; if (boss.y > 80 || boss.y < 20) boss.vy *= -1; bossContainer.style.top = boss.y + "%"; }
    if (bossLevel >= 2 && boss.state === 'idle' && boss.actionTimer > 5.0 && Math.random() < 0.01) startBossDash();
    if (bossLevel >= 3 && boss.state === 'idle' && boss.actionTimer > 7.0 && Math.random() < 0.01) startBossLaser();
    boss.shootTimer += delta;
    if (boss.state === 'idle' && boss.shootTimer > 2.0) { bossShoot(bossLevel, (1.0 + (bossLevel*0.2)) * 0.4); boss.shootTimer = 0; }
  }
  function startBossDash() {
    boss.state = 'dash'; bossBody.classList.add('boss-charging'); showFloatText("ğŸ’¢ ëŒì§„ ì¤€ë¹„!");
    setTimeout(() => {
        bossBody.classList.remove('boss-charging'); bossBody.classList.add('boss-dashing');
        bossContainer.style.transition = "right 0.4s ease-in"; bossContainer.style.right = (window.innerWidth - 100) + "px"; 
        setTimeout(() => { if(playerY > (100-boss.y)/100 * window.innerHeight - 100 && playerY < (100-boss.y)/100 * window.innerHeight + 50) damageLife(); }, 200);
        setTimeout(() => { bossContainer.style.transition = "right 0.8s ease-out"; bossContainer.style.right = "20px"; bossBody.classList.remove('boss-dashing'); boss.state = 'idle'; boss.actionTimer = 0; }, 800);
    }, 1000);
  }
  function startBossLaser() {
    boss.state = 'laser'; showFloatText("âš¡ ë ˆì´ì € ì¶©ì „!");
    setTimeout(() => {
        const laser = document.createElement('div'); laser.className = 'boss-laser'; laser.style.top = (boss.y + 5) + "%"; laser.style.display = 'block'; gameArea.appendChild(laser);
        let checkLaser = setInterval(() => { let laserH = (100 - boss.y) / 100 * window.innerHeight; if (Math.abs(playerY - laserH + 50) < 40 && !invincible) damageLife(); }, 50);
        setTimeout(() => { clearInterval(checkLaser); laser.remove(); boss.state = 'idle'; boss.actionTimer = 0; }, 1000);
    }, 1500);
  }
  function bossShoot(count, speedMult) {
    for(let i=0; i<count; i++) {
        setTimeout(() => {
            const m = document.createElement("div"); m.classList.add("projectile", "boss-missile");
            const rect = bossContainer.getBoundingClientRect();
            const startX = rect.left; const startY = rect.top + 30; 
            const pX = 120; const pY = window.innerHeight - playerY - 30;
            const dx = pX - startX; const dy = pY - startY; const dist = Math.sqrt(dx*dx + dy*dy);
            const speed = 300 * speedMult;
            const vx = (dx / dist) * speed; const vy = (dy / dist) * speed;
            m.style.left = startX + "px"; m.style.top = startY + "px";
            m.x = startX; m.y = startY; m.vx = vx; m.vy = vy; m.isBossMissile = true; 
            gameArea.appendChild(m); projectiles.push(m);
        }, i * 300); 
    }
  }
  function damageBoss() {
    boss.hp--; bossHpFill.style.width = (boss.hp / boss.maxHp * 100) + "%"; showFloatText("ğŸ’¥ ë³´ìŠ¤ íƒ€ê²©!");
    if (boss.hp <= 0) {
        bossContainer.style.transition = "top 1s ease-in"; bossContainer.style.top = "120%"; 
        spawnParticles(window.innerWidth-100, window.innerHeight-100, 'dust');
        setTimeout(() => { 
            bossContainer.style.display = 'none'; isBossBattle = false; invincible = false; activeEffects.invincible = 0; activeEffects.turbo = 0;
            if(!daily.completed) document.getElementById('dailyMissionBox').style.display = 'block';
            faith += 100 * bossLevel; daily.faith20 += 100; updateDailyMissionUI();
            showFloatText(`ğŸ‰ ë³´ìŠ¤ ì²˜ì¹˜! (+${100*bossLevel} Faith)`); playSound('clear');
            nextBossTrigger = distance + 200; saveProgress(); 
        }, 1000);
    }
  }
  function updatePhysics(delta) {
    if(isJunTimeTravel) return;
    if (activeEffects.fly > 0) { playerY += (targetY - playerY) * 0.1; velocity = 0; speedLines.style.display = "none"; } 
    else if (activeEffects.turbo > 0) { velocity = 0; speedLines.style.display = "block"; } 
    else { velocity += gravity; playerY += velocity; speedLines.style.display = "none"; }
    if (playerY < 0) playerY = 0;
    if (playerY > window.innerHeight - 110) playerY = window.innerHeight - 110;
    player.style.bottom = playerY + "px";
    const safeActive = (val) => (val && val > 0);

    for (let i = playerMissiles.length - 1; i >= 0; i--) {
        let m = playerMissiles[i];
        let mx = parseFloat(m.style.left); mx += 600 * delta; m.style.left = mx + "px";
        if (mx > window.innerWidth) { m.remove(); playerMissiles.splice(i, 1); continue; }
        for (let j = enemies.length - 1; j >= 0; j--) {
            let e = enemies[j];
            let rM = m.getBoundingClientRect(); let rE = e.getBoundingClientRect();
            if (rM.right > rE.left && rM.left < rE.right && rM.bottom > rE.top && rM.top < rE.bottom) {
                e.hp--; m.remove(); playerMissiles.splice(i, 1);
                const ex = document.createElement('div'); ex.className = 'explosion-area';
                ex.style.left = rE.left + 'px'; ex.style.top = rE.top + 'px'; ex.style.width='60px'; ex.style.height='60px';
                gameArea.appendChild(ex); setTimeout(()=>ex.remove(), 500);
                if (e.hp <= 0) { 
                    e.isDead = true; if(e.laserWarning) e.laserWarning.remove(); if(e.laserBeam) e.laserBeam.remove();
                    e.remove(); enemies.splice(j, 1); 
                    spawnFaithCoins(e.x + 30, e.y + 30, 4 + e.type, true, false); // ìˆ˜ë™
                    showFloatText("ğŸ’¥ ì êµ° ê²©íŒŒ! (+5)"); if(!isFeverTime) feverGauge = Math.min(feverGauge + 5, MAX_FEVER); 
                }
                break; 
            }
        }
    }
    for (let i = projectiles.length - 1; i >= 0; i--) {
        let p = projectiles[i];
        if (p.owner && p.owner.isDead) {
            p.style.opacity = (parseFloat(p.style.opacity) || 1) - 0.05; p.isFading = true; 
            if (p.style.opacity <= 0) { p.remove(); projectiles.splice(i, 1); continue; }
        }
        let cx = parseFloat(p.style.left) || p.x; let cy = parseFloat(p.style.top) || p.y;
        cx += p.vx * delta; cy += p.vy * delta;
        p.style.left = cx + "px"; p.style.top = cy + "px";
        if (cx < -100 || cx > window.innerWidth + 100 || cy < -100 || cy > window.innerHeight + 100) { p.remove(); projectiles.splice(i, 1); continue; }
        if (p.isExplosive && !p.exploded && cx <= 120) { 
             p.exploded = true;
             const boom = document.createElement("div"); boom.className = "explosion-area";
             boom.style.width = "260px"; boom.style.height = "260px"; boom.style.left = (cx - 100) + "px"; boom.style.top = (cy - 100) + "px";
             gameArea.appendChild(boom); setTimeout(() => boom.remove(), 500);
             const pRect = player.getBoundingClientRect(); const bRect = boom.getBoundingClientRect();
             if (pRect.right > bRect.left && pRect.left < bRect.right && pRect.bottom > bRect.top && pRect.top < bRect.bottom) {
                 if(!invincible && !safeActive(activeEffects.invincible)) damageLife();
             }
             p.remove(); projectiles.splice(i, 1); continue;
        }
        if (!p.isReflected && !p.isFading) {
            const rP = player.getBoundingClientRect(); const rM = p.getBoundingClientRect();
            if (rP.right > rM.left && rP.left < rM.right && rP.bottom > rM.top && rP.top < rM.bottom) {
                if (isFeverTime) { p.remove(); projectiles.splice(i, 1); faith += 5; showFloatText("ğŸ’¥ ëŒíŒŒ!"); continue; } 
                else if (!invincible && !safeActive(activeEffects.invincible) && !safeActive(activeEffects.summon)) { damageLife(); p.remove(); projectiles.splice(i, 1); continue; }
            }
        }
        if (isBossBattle && p.isReflected) {
            const bRect = bossContainer.getBoundingClientRect(); const pRect = p.getBoundingClientRect();
            if (pRect.right > bRect.left && pRect.left < bRect.right && pRect.bottom > bRect.top && pRect.top < bRect.bottom) { damageBoss(); p.remove(); projectiles.splice(i, 1); continue; }
        }
    }
    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        if (!safeActive(activeEffects.invincible) && !invincible) {
            const rP = player.getBoundingClientRect(); const rE = e.getBoundingClientRect();
            if (rP.right > rE.left && rP.left < rE.right && rP.bottom > rE.top && rP.top < rE.bottom) {
                if (isFeverTime) { 
                    e.isDead = true; if(e.laserWarning) e.laserWarning.remove(); if(e.laserBeam) e.laserBeam.remove();
                    e.remove(); enemies.splice(i, 1); 
                    spawnFaithCoins(e.x + 30, e.y + 30, 4 + e.type, true, false); 
                    showFloatText("ğŸ’¥ ì êµ° ë¶„ì‡„! (+5)"); spawnExplosionEffect(rE.left, rE.top); continue; 
                } 
                else { damageLife(); e.remove(); enemies.splice(i, 1); continue; }
            }
        }
    }
    for (let i = obstacles.length - 1; i >= 0; i--) {
        let o = obstacles[i];
        let left = parseFloat(o.style.left) || window.innerWidth;
        left -= gameSpeed * delta;
        o.style.left = left + "px";
        let rw = 60; if(o.classList.contains('obs-long')) rw = 240;

        // ë…¸ì—˜ ë¹” ì¶©ëŒ (ì¥ì• ë¬¼)
        if (activeEffects.noelLaser > 0 && !o.destroyed) {
            const beam = document.getElementById('noelBeam');
            if (beam) {
                const rB = beam.getBoundingClientRect(); const rO = o.getBoundingClientRect();
                if (rB.right > rO.left && rB.bottom > rO.top && rB.top < rO.bottom) {
                    o.destroyed = true; spawnExplosionEffect(left + 30, parseFloat(o.style.top || (window.innerHeight - 50)));
                    spawnFaithCoins(left, window.innerHeight - 150, randBetween(2,5), false, false); // ìˆ˜ë™
                    o.remove(); obstacles.splice(i, 1); showFloatText("ğŸ’¥ íŒŒê´´!"); continue;
                }
            }
        }
        // ë…¸ì—˜ ê±°ëŒ€í™” (ì¥ì• ë¬¼)
        if (activeEffects.noelGiant > 0 && !o.destroyed) {
             const rP = player.getBoundingClientRect(); const rO = o.getBoundingClientRect();
             if(rP.right > rO.left && rP.left < rO.right && rP.bottom > rO.top && rP.top < rO.bottom) {
                 o.destroyed = true; spawnExplosionEffect(left + 30, parseFloat(o.style.top || (window.innerHeight - 50)));
                 spawnFaithCoins(left, window.innerHeight - 150, 3, false, false); // ìˆ˜ë™
                 o.remove(); obstacles.splice(i, 1); showFloatText("ğŸ¦ íŒŒê´´!"); continue;
             }
        }

        if (isFeverTime && left < 180 && !o.destroyed) {
            o.destroyed = true; spawnExplosionEffect(left + 30, parseFloat(o.style.top || (window.innerHeight - 50)));
            spawnFaithCoins(left, window.innerHeight - 150, Math.floor(randBetween(2, 6)));
            o.remove(); obstacles.splice(i, 1); showFloatText("ğŸ’° ê²©íŒŒ!"); continue;
        }
        if (left + rw < 0) {
            o.remove(); obstacles.splice(i, 1); obstacleSurviveCount++;
            if(!isFeverTime) feverGauge = Math.min(feverGauge + 5, MAX_FEVER);
            if (obstacleSurviveCount >= 5) {
                combo++; faith++; daily.faith20++; saveData.faith = faith; document.getElementById("faithText").innerText = faith;
                const ce = document.getElementById("comboEffect"); ce.style.display = "block"; ce.innerText = `COMBO +${combo}!`; setTimeout(() => ce.style.display = "none", 1000);
                obstacleSurviveCount = 0; saveProgress(); updateDailyMissionUI();
            }
            continue;
        }
        if (activeEffects.summon > 0 && !o.destroyed) {
             const rP = player.getBoundingClientRect(); const rO = o.getBoundingClientRect();
             if (rP.right + 20 > rO.left && rP.left - 20 < rO.right && rP.bottom + 20 > rO.top && rP.top - 20 < rO.bottom) {
                o.destroyed = true; spawnExplosionEffect(left + 30, parseFloat(o.style.top || (window.innerHeight - 50)));
                spawnFaithCoins(left, window.innerHeight - 150, 3, false, true); // ì†Œí™˜ì€ ìë™
                o.remove(); obstacles.splice(i, 1); showFloatText("ğŸ’¥ íŒŒê´´!"); continue;
            }
        }
        if (currentSkin === 'haeun' && haeunShieldActive && !o.destroyed) {
            const rP = player.getBoundingClientRect(); const rO = o.getBoundingClientRect();
            if (rP.right + 20 > rO.left && rP.left - 10 < rO.right && rP.bottom + 10 > rO.top && rP.top - 10 < rO.bottom) {
                o.destroyed = true; haeunShieldActive = false; removeHaeunShield();
                spawnExplosionEffect(left + 30, parseFloat(o.style.top || (window.innerHeight - 50)));
                spawnFaithCoins(left, window.innerHeight - 150, randBetween(5, 11), false, true); // ìë™
                o.remove(); obstacles.splice(i, 1); showFloatText("ğŸ›¡ï¸ ë°©ì–´ & íŒŒê´´!"); playSound('clear'); continue;
            }
        }
        if (!isFeverTime && !safeActive(activeEffects.invincible) && !invincible && !safeActive(activeEffects.summon) && !safeActive(activeEffects.turbo) && !(currentSkin === 'haeun' && haeunShieldActive)) {
            const rP = player.getBoundingClientRect(); const rO = o.getBoundingClientRect();
            if (rP.right > rO.left && rP.left < rO.right && rP.bottom > rO.top && rP.top < rO.bottom) { damageLife(); break; }
        }
    }
  }
  function spawnObstacle() { 
    if(!running) return;
    if(activeEffects.turbo > 0 && !isFeverTime) return;
    const randi = (min,max)=>Math.floor(Math.random()*(max-min))+min;
    if (distance < 50) {
        const type = (Math.random() < 0.5) ? 'obs-log' : 'obs-rock'; const sx = window.innerWidth + 80;
        const b = document.createElement("div"); b.classList.add("obstacle", "obs-cap", "obs-ground", type);
        b.style.height = randi(130, 360) + "px"; b.x = sx; b.style.left = sx + "px"; b.style.bottom = "0";
        gameArea.appendChild(b); obstacles.push(b); return; 
    }
    if(distance > 50 && Math.random() < 0.65) {
        let cnt = (Math.random()<0.3)?2:1;
        for(let k=0; k<cnt; k++) {
            const b = document.createElement("div"); b.classList.add("obstacle", "obs-long");
            b.x = window.innerWidth+80; b.style.left = b.x+"px"; let sh = window.innerHeight;
            if(cnt===2) { if(k===0) b.style.bottom=randBetween(30, sh*0.35)+"px"; else b.style.bottom=randBetween(sh*0.55, sh*0.85)+"px"; }
            else { let r=Math.random(); if(r<0.2) b.style.bottom="0px"; else if(r<0.4) b.style.top="0px"; else b.style.bottom=randBetween(50, sh-120)+"px"; }
            gameArea.appendChild(b); obstacles.push(b);
        } return;
    }
    const type = (Math.random()<0.5)?'obs-log':'obs-rock'; const sx = window.innerWidth+80;
    if(Math.random()<0.5) {
        const b = document.createElement("div"); b.classList.add("obstacle", "obs-cap", "obs-ground", type);
        b.style.height=randi(90,220)+"px"; b.x=sx; b.style.left=sx+"px"; b.style.bottom="0";
        gameArea.appendChild(b); obstacles.push(b);
    } else {
        let th=randi(120,260); let gap=randi(160,220); let bh=Math.max(80, window.innerHeight-th-gap);
        const t = document.createElement("div"); t.classList.add("obstacle", "obs-cap", "obs-ceil", type);
        t.style.height=th+"px"; t.x=sx; t.style.left=sx+"px"; t.style.top="0";
        const b = document.createElement("div"); b.classList.add("obstacle", "obs-cap", "obs-ground", type);
        b.style.height=bh+"px"; b.x=sx; b.style.left=sx+"px"; b.style.bottom="0";
        gameArea.appendChild(t); obstacles.push(b); gameArea.appendChild(b); obstacles.push(b);
    }
  }
  function damageLife() {
    if(life <= 1 && currentSkin === 'jaeguk' && !jaegukRevivedOnce) {
        jaegukRevivedOnce = true; life = maxLife; document.getElementById("lifeText").innerText = life;
        const wing = document.createElement('div'); wing.className = 'angel-wing-effect';
        gameArea.appendChild(wing); setTimeout(() => wing.remove(), 2000);
        showFloatText("ğŸª½ ë¶€í™œ!"); playSound('item'); activeEffects.invincible = 3; return;
    }
    if(activeEffects.revive > 0) { life=3; document.getElementById("lifeText").innerText=life; activeEffects.revive=0; activeEffects.invincible=3; showFloatText("ğŸ‘¼ ë¶€í™œ!"); return; }
    if(activeEffects.turbo>0 && !isFeverTime) return; 
    if(activeEffects.invincible>0 || invincible || !running) return;
    if(currentSkin === 'haeun' && haeunShieldActive) {
        haeunShieldActive = false; removeHaeunShield(); showFloatText("ğŸ›¡ï¸ ë°©ì–´ ì„±ê³µ!"); playSound('parry'); return;
    }
    life--; document.getElementById("lifeText").innerText=life;
    invincible=true; player.style.opacity="0.4"; setTimeout(()=>{invincible=false; player.style.opacity="1";},800);
    playSound('hit'); if(life<=0) gameOver();
  }
  function startGameNow() { 
      document.getElementById("startGuide").style.display="none"; 
      document.getElementById('abilityBtn2').style.display = 'none'; 
      // ê²Œì„ ì‹œì‘ ì‹œ ëª¨ë“  ë°°ì—´ ì´ˆê¸°í™” (í”„ë¦¬ì§• ë°©ì§€)
      obstacles.forEach(o=>o.remove()); obstacles=[];
      enemies.forEach(e=>e.remove()); enemies=[];
      projectiles.forEach(p=>p.remove()); projectiles=[];
      playerMissiles.forEach(p=>p.remove()); playerMissiles=[];
      faithCoins.forEach(c=>c.remove()); faithCoins=[];
      items.forEach(i=>i.remove()); items=[];
      // ìŠ¤í‚¬ ì˜¤ë¸Œì íŠ¸ ì´ˆê¸°í™”
      bobas.forEach(b=>b.remove()); bobas=[];
      hahwiStones.forEach(s=>s.remove()); hahwiStones=[];
      jihyeUnits.forEach(u=>u.remove()); jihyeUnits=[];
      jihyeMissiles.forEach(m=>m.remove()); jihyeMissiles=[];
      ganghuiFunnels.forEach(f=>f.remove()); ganghuiFunnels=[];
      stephanieCakes.forEach(c=>c.remove()); stephanieCakes=[];
      yejunClones.forEach(c=>c.el.remove()); yejunClones=[];
      jieunNotes.forEach(n=>n.remove()); jieunNotes=[];
      
      running=true; lastTime=performance.now(); 
      if(sounds['bgm']) sounds['bgm'].play().catch(e=>console.log("BGM Error:", e));
      requestAnimationFrame(gameLoop); updateDailyMissionUI(); 
  }
  async function saveProgress() { 
    saveData.faith = faith; try{ await fetch(API_URL,{ method:"POST", headers: { "Content-Type": "text/plain" }, redirect: 'follow', body:JSON.stringify({type:"save",id,saveData}) }); }catch(e){} 
    localStorage.setItem("run_save",JSON.stringify(saveData)); 
  }
  async function gameOver() { 
      if(rankingSaved)return; running=false; invincible=true; player.style.opacity="0.4"; 
      document.getElementById("finalDist").innerText=Math.floor(distance); document.getElementById("gameOverModal").style.display="flex"; 
      try{ await fetch(API_URL,{ method:"POST", headers: { "Content-Type": "text/plain" }, redirect: 'follow', body:JSON.stringify({type:"updateRanking",id,name,distance:Math.floor(distance),message:""}) }); }catch(e){} 
      rankingSaved=true; 
  }
  async function confirmRanking() { 
      const msg=document.getElementById("rankMsg").value.trim(); 
      try{ await fetch(API_URL,{ method:"POST", headers: { "Content-Type": "text/plain" }, redirect: 'follow', body:JSON.stringify({type:"updateComment",id,message:msg}) }); alert("ë“±ë¡ì™„ë£Œ"); window.location.href="/TrapGame/menu.html"; }catch(e){ alert("ì˜¤ë¥˜"); window.location.href="/TrapGame/menu.html"; } 
  }
  async function pauseForQuiz() {
    if (!running) return; running = false; document.getElementById("loadingQuiz").style.display = "flex";
    try {
      const res = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, redirect: 'follow', body: JSON.stringify({ type: "getQuiz" }) });
      const txt = await res.text(); document.getElementById("loadingQuiz").style.display = "none";
      if (txt === "noquiz") { running = true; lastTime = performance.now(); requestAnimationFrame(gameLoop); return; }
      const quiz = JSON.parse(txt);
      document.getElementById("quizQuestion").innerText = quiz.question;
      document.getElementById("btnA").innerText = "A) " + quiz.A; document.getElementById("btnB").innerText = "B) " + quiz.B; document.getElementById("btnC").innerText = "C) " + quiz.C;
      window.correctAnswer = quiz.answer; document.getElementById("quizModal").style.display = "flex";
    } catch (err) { alert("í€´ì¦ˆ ë¡œë”© ì‹¤íŒ¨."); running=true; requestAnimationFrame(gameLoop); }
  }
  function answerQuiz(sel) {
    document.getElementById("quizModal").style.display = "none";
    if (sel === window.correctAnswer) {
      const ef = document.getElementById("correctEffect"); ef.style.display = "block"; setTimeout(() => (ef.style.display = "none"), 800);
      faith += 5; saveData.faith = faith; document.getElementById("faithText").innerText = faith;
      daily.quiz3++; localStorage.setItem("dailyMission", JSON.stringify(daily)); saveProgress();
    } else { damageLife(); }
    if (life > 0) { running = true; lastTime = performance.now(); requestAnimationFrame(gameLoop); }
  }
  let lastT=0; document.addEventListener("touchend",e=>{const n=Date.now();if(n-lastT<300)e.preventDefault();lastT=n;},{passive:false});
</script>
</body>
</html>
