<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Disciple Run ‚Äì Final Perfect Version</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    :root { --hud-bg: rgba(255, 248, 235, 0.9); --hud-border: #3a2513; --accent: #c47a3f; --panel-bg: #fdfaf2; }
    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; font-family: "Pretendard", sans-serif; }
    
    #gameArea { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: linear-gradient(#88c6ff 0%, #b7e3ff 45%, #f7f0d9 45%, #f0e0b0 100%); }
    
    /* Î∞∞Í≤Ω */
    .bg-layer { position: absolute; left: 0; top: 0; width: 200%; height: 100%; background-repeat: repeat-x; image-rendering: pixelated; pointer-events: none; will-change: background-position; }
    #bgLayer1 { background-image: url("bg_sky.png"); z-index: 1; background-size: auto 100%; background-position: 0 bottom; }
    #bgLayer2 { background-image: url("bg_mountain.png"); z-index: 2; background-size: auto 100%; background-position: 0 bottom; }
    #bgLayer3 { background-image: url("bg_forest.png"); z-index: 3; background-size: auto 60%; background-position: 0 bottom; }

    #ground { display: none; }

    #player { position: absolute; z-index: 50; left: 120px; bottom: 40px; width: 60px; height: 60px; background-image: url("disciple.png"); background-position: center; background-size: contain; background-repeat: no-repeat; image-rendering: pixelated; transition: opacity 0.2s; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.2)); }

    /* Ïû•Ïï†Î¨º */
    .obstacle { position: absolute; z-index: 40; background-size: 8px 8px; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); }
    .obs-cap::after { content: ''; position: absolute; left: -10%; width: 120%; height: 24px; border-radius: 4px; }
    .obs-ground.obs-cap::after { top: -12px; } .obs-ceil.obs-cap::after { bottom: -12px; }
    .obs-log { width: 60px; background-color: #8D6E63; border-left: 4px solid #5D4037; border-right: 4px solid #5D4037; background-image: linear-gradient(90deg, rgba(0,0,0,0.05) 50%, transparent 50%); }
    .obs-log.obs-cap::after { background-color: #66BB6A; border: 4px solid #1B5E20; }
    .obs-rock { width: 60px; background-color: #9E9E9E; border-left: 4px solid #616161; border-right: 4px solid #616161; background-image: radial-gradient(circle, rgba(0,0,0,0.1) 20%, transparent 20%); }
    .obs-rock.obs-cap::after { background-color: #BDBDBD; border: 4px solid #424242; }
    .obs-long { width: 240px; height: 35px; background-color: #5D4037; background-image: linear-gradient(0deg, rgba(0,0,0,0.2) 50%, transparent 50%); border: 3px solid #3E2723; border-radius: 8px; box-shadow: 0 5px 5px rgba(0,0,0,0.3); }

    /* Ï†ÅÍµ∞ (Enemy) Ïä§ÌÉÄÏùº */
    .enemy { position: absolute; z-index: 48; width: 60px; height: 60px; background-position: center; background-size: contain; background-repeat: no-repeat; }
    
    /* [ÏàòÏ†ï] ÏïÑÏù¥ÌÖú Ïä§ÌÉÄÏùº: ÏõêÌòï Î∞∞Í≤Ω Ï†úÍ±∞, Í∑∏Î¶ºÏûê Ï†úÍ±∞ -> ÏàúÏàò Ïù¥ÎØ∏ÏßÄÎßå ÌëúÏãú */
    .item { position: absolute; z-index: 45; width: 48px; height: 48px; image-rendering: pixelated; background-position: center; background-repeat: no-repeat; background-size: contain; animation: itemFloat 1.5s ease-in-out infinite alternate; }
    @keyframes itemFloat { from { transform: translateY(0); } to { transform: translateY(-8px); } }

    /* Ìà¨ÏÇ¨Ï≤¥ Í≥µÌÜµ */
    .projectile { position: absolute; z-index: 60; width: 30px; height: 30px; border-radius: 50%; }
    
    /* Î≥¥Ïä§/Ï†ÅÍµ∞ ÎØ∏ÏÇ¨Ïùº */
    .enemy-missile { background: radial-gradient(circle, #ff0000, #800000); box-shadow: 0 0 8px #ff0000; }
    .boss-missile { width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff5722); animation: spinMeteor 1s linear infinite; }
    
    /* Ïú†Ï†Ä ÎØ∏ÏÇ¨Ïùº */
    .player-missile { width: 40px; height: 20px; background: cyan; border-radius: 10px; box-shadow: 0 0 10px cyan; z-index: 65; }

    /* Ìè≠Î∞ú Ïù¥ÌéôÌä∏ (Î≤îÏúÑÌòï ÎØ∏ÏÇ¨Ïùº) */
    .explosion-area { position: absolute; border-radius: 50%; background: rgba(255, 69, 0, 0.5); border: 2px solid orange; animation: explode 0.5s forwards; z-index: 59; }
    @keyframes explode { 0% { transform: scale(0.1); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }

    /* Ï†ÅÍµ∞ Î†àÏù¥Ï†Ä */
    .enemy-laser-warning { position: absolute; height: 2px; background: rgba(255,0,0,0.5); z-index: 49; }
    .enemy-laser-beam { position: absolute; height: 30px; background: linear-gradient(to bottom, transparent, red, transparent); box-shadow: 0 0 15px red; z-index: 50; }

    .reflected-missile { background: #00ff00 !important; box-shadow: 0 0 15px #00ff00; }
    @keyframes spinMeteor { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .particle { position: absolute; z-index: 90; pointer-events: none; border-radius: 50%; animation: particleFade 0.8s ease-out forwards; }
    @keyframes particleFade { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }

    #hud { position: fixed; z-index: 900; top: 12px; left: 12px; color: #3a2513; font-size: 18px; font-weight: 700; background: var(--hud-bg); border-radius: 10px; padding: 8px 12px; border: 3px solid var(--hud-border); }
    
    #buffArea { position: fixed; z-index: 2147483647; bottom: 20px; right: 15px; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 8px; pointer-events: none; }
    .buff-tag { background: rgba(0, 0, 0, 0.85); color: #fff; padding: 8px 14px; border-radius: 8px; font-weight: 700; border-left: 5px solid; font-size: 14px; box-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

    /* [ÏàòÏ†ï] Ïä§ÌÇ¨ Î≤ÑÌäº ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω ÎåÄÏùë Ïä§ÌÉÄÏùº */
    #abilityBtn { position: fixed; bottom: 20px; right: 20px; width: 80px; height: 80px; background: #ff5722; color: white; border-radius: 50%; border: 4px solid #fff; font-weight: bold; font-size: 20px; display: none; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; box-shadow: 0 6px 12px rgba(0,0,0,0.6); }
    #abilityBtn.cooldown { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; font-size: 24px; }

    /* [ÏàòÏ†ï] ÏÑúÎ∏å Ïï°ÏÖò Î≤ÑÌäº (Î∞©Ìå®/Í≥µÍ≤©) - Í∑∏Î¶ºÎßå ÌÅ¨Í≤å ÎÇòÏò§ÎèÑÎ°ù Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω */
    #subActionBtn { 
        position: fixed; bottom: 150px; left: 20px; 
        width: 100px; height: 100px; /* ÌÅ¨Í∏∞ ÏïΩÍ∞Ñ ÌÇ§ÏõÄ */
        background: transparent; /* Î∞∞Í≤Ω Ìà¨Î™Ö */
        border: none; /* ÌÖåÎëêÎ¶¨ Ï†úÍ±∞ */
        display: none; 
        justify-content: center; align-items: center; 
        cursor: pointer; z-index: 1000; 
        transition: transform 0.1s;
    }
    #subActionBtn:active { transform: scale(0.9); }
    #subActionBtn.cooldown { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
    
    /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ ÌÇ§Ïö∞Í∏∞ */
    #subActionIcon { font-size: 80px; line-height: 1; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }

    #dailyMissionBox { position: fixed; bottom: 20px; left: 20px; background: rgba(0, 0, 0, 0.75); color: #fff; padding: 12px 16px; border-radius: 10px; font-size: 13px; z-index: 800; pointer-events: none; border: 2px solid #3a2513; }
    .mission-done { color: #4caf50; text-decoration: line-through; }

    #bossContainer { position: absolute; right: -200px; top: 50%; width: 120px; height: 120px; z-index: 55; display: none; transition: right 1s ease-out; }
    #bossBody { width: 100%; height: 100%; background: url('boss.png') no-repeat center/contain; image-rendering: pixelated; filter: drop-shadow(0 0 10px red); animation: bossFloat 2s ease-in-out infinite; }
    .boss-charging { filter: drop-shadow(0 0 20px yellow) !important; transform: scale(1.1); }
    .boss-dashing { filter: drop-shadow(0 0 20px #ff0000) !important; }
    @keyframes bossFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    #bossHpBar { position: absolute; top: -20px; left: 0; width: 100%; height: 10px; background: #333; border: 2px solid #000; border-radius: 5px; overflow: hidden; }
    #bossHpFill { width: 100%; height: 100%; background: #d32f2f; transition: width 0.2s; }
    #bossWarning { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; font-weight: 900; color: #d32f2f; text-shadow: 3px 3px 0 #000; display: none; z-index: 2000; animation: blink 0.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .boss-laser { position: absolute; right: 0; height: 40px; background: linear-gradient(to bottom, #ff0000, #fff, #ff0000); z-index: 58; opacity: 0.8; border-top: 2px solid #fff; border-bottom: 2px solid #fff; box-shadow: 0 0 20px #ff0000; pointer-events: none; display: none; }

    #speedLines { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 80; background: radial-gradient(circle, transparent 40%, rgba(255, 255, 255, 0.8) 90%); mix-blend-mode: overlay; pointer-events: none; animation: speedShake 0.1s infinite; }
    @keyframes speedShake { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }
    .float-text { position: absolute; color: #ffe24f; font-weight: 900; font-size: 20px; text-shadow: 2px 2px 0 #3a2513; z-index: 1000; pointer-events: none; animation: floatUp 1s ease-out forwards; }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }
    #comboEffect, #correctEffect { position: fixed; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; pointer-events: none; font-weight: 900; text-shadow: 3px 3px #000; }
    #comboEffect { top: 20%; font-size: 40px; color: #ffe24f; text-shadow: 3px 3px #8b4f26; }
    #correctEffect { top: 40%; font-size: 48px; color: #00ffcc; text-shadow: 3px 3px #006644; }

    .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.55); display: none; justify-content: center; align-items: center; padding: 16px; z-index: 20000; }
    .modal-box { width: 90%; max-width: 420px; background: var(--panel-bg); border-radius: 14px; border: 4px solid #3a2513; padding: 28px 24px; box-shadow: 0 0 0 4px #fff, 0 10px 0 #b79b76; text-align: center; }
    .modal-title { font-size: 28px; font-weight: 800; margin-bottom: 18px; }
    .modal-desc { font-size: 17px; margin-bottom: 22px; line-height: 1.45; white-space: pre-line; }
    .choice-btn, .action-btn, .start-btn { width: 100%; padding: 14px; margin: 8px 0; background: var(--accent); border: 0; border-radius: 10px; color: #fff; font-size: 18px; font-weight: 700; box-shadow: 0 4px 0 var(--accent-dark); cursor: pointer; }
    .choice-btn:active, .action-btn:active, .start-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--accent-dark); }
    .action-btn:disabled { background: #999; cursor: not-allowed; box-shadow: none; }
    .modal-input { width: 85%; max-width: 320px; padding: 12px; font-size: 16px; border-radius: 8px; border: 2px solid #b8a792; margin: 8px auto 18px; display: block; }
    #loadingQuiz { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; color: #fff; font-size: 22px; font-weight: 700; z-index: 20001; }
  </style>
</head>

<body>
<div id="gameArea">
  <div id="startGuide" class="modal-bg" style="display:flex;">
    <div class="modal-box">
      <div style="font-size:28px; font-weight:800; margin-bottom:18px;">Í≤åÏûÑ Î∞©Î≤ï / How to Play</div>
      <div style="text-align:left; font-size:15px; line-height:1.6;">
        ‚Ä¢ <b>Space / ÌÑ∞Ïπò</b>: Ï†êÌîÑ<br>
        ‚Ä¢ <b>AÌÇ§</b>: ÌäπÏàòÎä•Î†• (SKILL)<br>
        ‚Ä¢ <b>SÌÇ§ / Î∞©Ìå®Î≤ÑÌäº</b>: 200m Ïù¥ÌõÑ Í≥µÍ≤© / Î≥¥Ïä§Ï†Ñ Î∞©Ïñ¥<br><br>
        [ÏïÑÏù¥ÌÖú Ìö®Í≥º]<br>
        ‚úùÔ∏è <b>Ïã≠ÏûêÍ∞Ä:</b> Î¨¥Ï†Å / üïäÔ∏è <b>Wings:</b> ÌÑ∞Î≥¥<br>
        üçÉ <b>Î∞îÎûå:</b> Í∞êÏÜç / üìò <b>ÏÑ±Í≤Ω:</b> Faith +10
      </div>
      <button class="start-btn" onclick="startGameNow()">‚ñ∂ ÏãúÏûëÌïòÍ∏∞ / Start</button>
    </div>
  </div>

  <div id="bgLayer1" class="bg-layer"></div>
  <div id="bgLayer2" class="bg-layer"></div>
  <div id="bgLayer3" class="bg-layer"></div>
  <div id="speedLines"></div> <div id="ground"></div> <div id="player"></div>

  <div id="bossContainer">
    <div id="bossHpBar"><div id="bossHpFill"></div></div>
    <div id="bossBody"></div>
  </div>
  <div id="bossLaser" class="boss-laser"></div>

  <div id="hud">‚ù§Ô∏è <span id="lifeText"></span> üìè <span id="distanceText">0m</span> ‚úù <span id="faithText"></span></div>
   
  <div id="abilityBtn" ontouchstart="useAbility(event)" onclick="useAbility(event)">SKILL</div>
  <div id="dailyMissionBox"></div>
  
  <div id="subActionBtn" ontouchstart="handleSubAction(event)" onclick="handleSubAction(event)">
      <span id="subActionIcon">üõ°Ô∏è</span>
  </div>
</div>

<div id="buffArea"></div>
<div id="bossWarning">‚ö†Ô∏è BOSS WARNING!</div>
<div id="comboEffect">COMBO +1!</div>
<div id="correctEffect">+5 Faith!</div>

<div id="quizModal" class="modal-bg">
  <div class="modal-box">
    <div style="font-size:28px; font-weight:800;">ÏÑ±Í≤Ω ÌÄ¥Ï¶à</div>
    <div id="quizQuestion" style="margin:20px 0; font-size:18px;"></div>
    <button class="choice-btn" onclick="answerQuiz('A')" id="btnA"></button>
    <button class="choice-btn" onclick="answerQuiz('B')" id="btnB"></button>
    <button class="choice-btn" onclick="answerQuiz('C')" id="btnC"></button>
  </div>
</div>

<div id="gameOverModal" class="modal-bg">
  <div class="modal-box">
    <div style="font-size:28px; font-weight:800;">GAME OVER</div>
    <div style="margin:20px 0;"><b><span id="finalDist"></span>m</b> Îã¨Î†∏ÏäµÎãàÎã§!</div>
    <input id="rankMsg" class="modal-input" type="text" placeholder="ÏÜåÍ∞ê ÏûÖÎ†•(ÏÑ†ÌÉù)" />
    <button class="action-btn" style="background:#5d4037;" onclick="location.reload()">üîÑ Îã§ÏãúÌïòÍ∏∞</button>
    <button class="action-btn" onclick="confirmRanking()">[ÏàúÏúÑÎì±Î°ù]</button>
  </div>
</div>

<div id="loadingQuiz">‚è≥ ÏÑ±Í≤Ω Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  const sounds = {};
  ['bgm', 'jump', 'hit', 'item', 'parry', 'clear'].forEach(name => {
    sounds[name] = new Audio(`${name}.mp3`);
    if(name==='bgm') {
        sounds[name].loop = true;
        sounds[name].volume = 0.5; 
    }
  });

  function playSound(name) {
    if(sounds[name]) {
        sounds[name].currentTime = 0;
        sounds[name].play().catch(()=>{});
    }
  }

  let id = localStorage.getItem("run_id");
  let name = localStorage.getItem("run_name");
  let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");

  if (!id) { alert("Î°úÍ∑∏Ïù∏ ÌïÑÏöî"); window.location.href = "/TrapGame/index.html"; }

  let daily = JSON.parse(localStorage.getItem("dailyMission") || "{}");
  function initDailyMission() { return { date: new Date().toDateString(), run200: false, quiz3: 0, faith20: 0, completed: false, version: '3.0' }; }
  if (!daily.date || daily.date !== new Date().toDateString() || daily.version !== '3.0') {
    daily = initDailyMission(); localStorage.setItem("dailyMission", JSON.stringify(daily));
  }

  let life = 3 + (saveData.extraLife || 0);
  let faith = saveData.faith || 0;
  let agility = saveData.agility || 0;
  let currentSkin = saveData.equippedSkin || "default";

  const SKIN_DATA = {
    default: { type: "none" }, noel: { type: "Active", cd: 60 }, jeonchan: { type: "Passive", cd: 40 },
    haeun: { type: "Passive", cd: 30 }, jaeguk: { type: "Active", cd: 120 }, hahwi: { type: "Passive", cd: 20 },
    jihye: { type: "Passive" }, jun: { type: "Passive" }, stephanie: { type: "Passive" },
    yejun: { type: "Active", cd: 180 }, ganghui: { type: "Passive", cd: 20 }, jieun: { type: "Active", cd: 120 }
  };

  const abilityBtn = document.getElementById('abilityBtn');
  if(SKIN_DATA[currentSkin].type === "Active") abilityBtn.style.display = 'flex';

  document.getElementById("lifeText").innerText = life;
  document.getElementById("faithText").innerText = faith;

  const gameArea = document.getElementById("gameArea");
  const player = document.getElementById("player");
  const bg1 = document.getElementById("bgLayer1"); const bg2 = document.getElementById("bgLayer2"); const bg3 = document.getElementById("bgLayer3");

  if (currentSkin !== 'default') player.style.backgroundImage = `url('skin_${currentSkin}.png')`;
  else player.style.backgroundImage = `url('disciple.png')`;

  let buffArea = document.getElementById("buffArea");
  let speedLines = document.getElementById("speedLines") || createEl("div", "speedLines", gameArea, player);

  function createEl(tag, id, parent, before) {
    let el = document.createElement(tag); el.id = id;
    if(before) parent.insertBefore(el, before); else parent.appendChild(el);
    return el;
  }

  let playerY = 40; let velocity = 0; 
  let gravity = -0.16; let jumpPower = Math.max(3, 5.5 - agility * 0.05);
   
  let targetY = 0;
  let distance = 0;
  let obstacles = []; let projectiles = []; 
  let enemies = []; let playerMissiles = []; 
  let running = false; let invincible = false;

  const BASE_SPEED = 170; let gameSpeed = BASE_SPEED;
  let lastTime = performance.now();
  let nextQuizDistance = 35; 
   
  let obstacleTimer = 0; let nextObstacleTime = 2.0;
  let enemySpawnTimer = 0;
  // [ÏàòÏ†ï] Ïö¥ÏÑù ÌÉÄÏù¥Î®∏ ÏÇ≠Ï†ú (140-150m Îç∞ÎØ∏ÏßÄ ÏõêÏù∏ Ï†úÍ±∞)
  
  let itemTimer = 0; let nextItemTime = 8;
  let abilityCD = 0;
  let missionUpdateTimer = 0;

  let bg1X = 0, bg2X = 0, bg3X = 0;
  const BG1_SPEED = 20; const BG2_SPEED = 40; const BG3_SPEED = 60;

  let items = []; let combo = 0; let obstacleSurviveCount = 0; let rankingSaved = false;
  let activeEffects = { turbo: 0, invincible: 0, slow: 0, fly: 0, revive: 0, summon: 0 };

  let isBossBattle = false;
  let nextBossTrigger = 200; 
  let bossLevel = 0;
  let boss = { hp: 6, maxHp: 6, x: 0, y: 50, vy: 1, state: 'idle', shootTimer: 0, actionTimer: 0 }; 
  let bossContainer = document.getElementById('bossContainer');
  let bossBody = document.getElementById('bossBody');
  let bossHpFill = document.getElementById('bossHpFill');
  
  let subActionBtn = document.getElementById('subActionBtn');
  let shieldCooldown = 0;

  function randBetween(min, max) { return Math.random() * (max - min) + min; }

  function spawnParticles(x, y, type) {
    const colors = type==='item' ? ['#ffd700','#fff'] : type==='spark' ? ['#ff4500','#ff8c00'] : ['#8b4513','#a0522d'];
    for(let i=0; i<8; i++) {
        const p = document.createElement('div');
        p.classList.add('particle');
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.width = (Math.random()*6+4)+'px'; p.style.height = p.style.width;
        p.style.left = x + 'px'; p.style.top = y + 'px';
        gameArea.appendChild(p);
        const tx = (Math.random()-0.5) * 100;
        const ty = (Math.random()-0.5) * 100;
        p.animate([ { transform: `translate(0,0)` }, { transform: `translate(${tx}px, ${ty}px)` } ], { duration: 600, fill: 'forwards' }).onfinish = () => p.remove();
    }
  }

  function jump() {
    if (!running) return;
    if (activeEffects.turbo > 0 || activeEffects.fly > 0) return;
    velocity = jumpPower;
    playSound('jump');
  }
   
  document.body.addEventListener("keydown", e => {
    if (e.code === "Space" || e.code === "ArrowUp") { e.preventDefault(); jump(); }
    if (e.code === "KeyA") useAbility();
    if (e.code === "KeyS") handleSubAction(); 
  });
   
  document.body.addEventListener("touchstart", (e) => {
      if(e.target.closest('button') || e.target.closest('.choice-btn') || e.target.closest('#abilityBtn') || e.target.closest('#subActionBtn')) return;
      jump();
  });
   
  window.addEventListener('mousemove', e => targetY = window.innerHeight - e.clientY);
  window.addEventListener('touchmove', e => targetY = window.innerHeight - e.touches[0].clientY);

  function handleSubAction(e) {
      if(e) e.stopPropagation();
      if (!running) return;

      if (isBossBattle) {
          useShield();
      } else if (distance >= 200) {
          playerShoot();
      }
  }

  function useShield() {
    if (shieldCooldown > 0) return;
    shieldCooldown = 0.5;
    subActionBtn.classList.add('cooldown');
    let reflected = false;
    projectiles.forEach(p => {
        if (p.isBossMissile && !p.isReflected) {
            const pRect = p.getBoundingClientRect();
            const plRect = player.getBoundingClientRect();
            const dist = Math.hypot((pRect.left) - (plRect.left), (pRect.top) - (plRect.top));
            
            // [ÏàòÏ†ï] Î∞©Ïñ¥ ÌåêÏ†ï Î≤îÏúÑ ÌôïÎåÄ (70 -> 150)
            if (dist < 150) {
                p.isReflected = true;
                p.classList.remove('boss-missile');
                p.classList.add('reflected-missile');
                p.vx = Math.abs(p.vx) * 1.5; p.vy = -p.vy * 0.5; 
                reflected = true;
                spawnParticles(pRect.left, pRect.top, 'spark');
            }
        }
    });
    if (reflected) { showFloatText("‚öîÔ∏è Î∞òÏÇ¨ ÏÑ±Í≥µ!"); playSound('parry'); }
    else showFloatText("üõ°Ô∏è Î∞©Ïñ¥!");
  }

  function playerShoot() {
      const m = document.createElement("div");
      m.classList.add("player-missile");
      const pRect = player.getBoundingClientRect();
      m.style.left = (pRect.right) + "px";
      m.style.top = (pRect.top + 20) + "px";
      gameArea.appendChild(m);
      playerMissiles.push(m);
      playSound('jump');
  }

  function useAbility(e) {
    if(e) e.stopPropagation();
    if(!running || abilityCD > 0) return;
    const s = SKIN_DATA[currentSkin];
    if(currentSkin === 'noel') {
      showFloatText("üåä Í∏∏ Ïó¥Î¶º!");
      document.querySelectorAll('.obstacle').forEach(el => { el.style.bottom = '-150px'; });
    } else if(currentSkin === 'jaeguk') { activeEffects.revive = 30; showFloatText("üëº ÏûêÎèô Î∂ÄÌôú On"); } 
    else if(currentSkin === 'yejun') { activeEffects.fly = 30; showFloatText("‚úàÔ∏è ÏûêÏú† ÎπÑÌñâ"); } 
    else if(currentSkin === 'jieun') { activeEffects.summon = 20; showFloatText("üõ°Ô∏è ÎÖ∏Ïóò ÏÜåÌôò!"); }
    abilityCD = s.cd;
  }

  function updateBuffUI(delta) {
    const buffContainer = document.getElementById("buffArea");
    buffContainer.innerHTML = ""; 

    for(let k in activeEffects) {
        if(activeEffects[k] > 0) {
            activeEffects[k] -= delta;
            if(activeEffects[k] > 0) {
                let color = "#fff";
                let icon = "";
                let label = k;
                if(k === 'invincible') { color = "#ffd700"; icon = "üõ°Ô∏è"; label = "Î¨¥Ï†Å"; }
                else if(k === 'turbo') { color = "#00e5ff"; icon = "üöÄ"; label = "ÌÑ∞Î≥¥"; }
                else if(k === 'slow') { color = "#90ee90"; icon = "üçÉ"; label = "Í∞êÏÜç"; }
                else if(k === 'fly') { color = "#87ceeb"; icon = "‚úàÔ∏è"; label = "ÎπÑÌñâ"; }
                else if(k === 'revive') { color = "#ff69b4"; icon = "üëº"; label = "Î∂ÄÌôú"; }
                
                buffContainer.innerHTML += `<div class="buff-tag" style="border-color:${color}">${icon} ${label} ${Math.ceil(activeEffects[k])}s</div>`;
            }
        } else {
            activeEffects[k] = 0; 
        }
    }

    if(shieldCooldown > 0) {
        shieldCooldown -= delta;
        if(shieldCooldown <= 0) subActionBtn.classList.remove('cooldown');
    }
    updateAbilityBtn(delta);
    
    updateSubActionButtonUI();
  }

  // [ÏàòÏ†ï] Î∞©Ìå®/Í≥µÍ≤© Î™®ÎìúÏóê Îî∞Îùº ÏïÑÏù¥ÏΩòÎßå ÌëúÏãú
  function updateSubActionButtonUI() {
      const icon = document.getElementById("subActionIcon");
      if (isBossBattle) {
          subActionBtn.style.display = 'flex';
          icon.innerText = "üõ°Ô∏è"; 
      } else if (distance >= 200) {
          subActionBtn.style.display = 'flex';
          icon.innerText = "üöÄ";
      } else {
          subActionBtn.style.display = 'none';
      }
  }

  // [ÏàòÏ†ï] SKILL ÌÖçÏä§Ìä∏ Î∞òÏòÅ
  function updateAbilityBtn(dt) {
    if(abilityCD > 0) {
      abilityCD -= dt;
      abilityBtn.classList.add('cooldown');
      abilityBtn.innerHTML = Math.ceil(abilityCD);
    } else {
      abilityBtn.classList.remove('cooldown');
      abilityBtn.innerHTML = "SKILL";
    }
  }

  let lastMissionHTML = "";
  function updateDailyMissionUI() {
    const box = document.getElementById('dailyMissionBox');
    if (daily.completed || isBossBattle) { box.style.display = 'none'; return; }
    box.style.display = 'block';
    const m1 = daily.run200 ? 'mission-done' : '';
    const m2 = daily.quiz3 >= 3 ? 'mission-done' : '';
    const m3 = daily.faith20 >= 20 ? 'mission-done' : '';
    const newHTML = `
      <div style="margin-bottom:5px; font-weight:bold; border-bottom:1px solid #555; padding-bottom:3px;">üìÖ ÏùºÏùº ÎØ∏ÏÖò</div>
      <div class="mission-item ${m1}">üèÉ 200m Îã¨Î¶¨Í∏∞</div>
      <div class="mission-item ${m2}">üß† ÌÄ¥Ï¶à 3Ìöå (${daily.quiz3}/3)</div>
      <div class="mission-item ${m3}">‚úù Faith 20 (${Math.min(daily.faith20, 20)}/20)</div>
    `;
    if(newHTML !== lastMissionHTML) { box.innerHTML = newHTML; lastMissionHTML = newHTML; }
  }

  function checkMissions() {
    if (daily.completed) return;
    if(distance < 5) return; 
    let changed = false;
    if (!daily.run200 && distance >= 200) { daily.run200 = true; changed = true; }
    if (daily.run200 && daily.quiz3 >= 3 && daily.faith20 >= 20) {
        daily.completed = true; faith += 200;
        saveData.faith = faith; document.getElementById("faithText").innerText = faith;
        showFloatText("üéâ ÏùºÏùº ÎØ∏ÏÖò ÏôÑÎ£å! (+200 Faith)");
        playSound('clear');
        saveProgress(); changed = true; updateDailyMissionUI();
    }
    if(changed) { localStorage.setItem("dailyMission", JSON.stringify(daily)); updateDailyMissionUI(); }
  }

  function gameLoop(now) {
    if (!running) return;
    const delta = (now - lastTime) / 1000;
    lastTime = now;
    const safeDelta = Math.min(delta, 0.05);

    try {
        updateBuffUI(safeDelta);
        checkMissions();
        
        missionUpdateTimer += safeDelta;
        if(missionUpdateTimer > 1.0) { updateDailyMissionUI(); missionUpdateTimer = 0; }
        if(lastMissionHTML === "") updateDailyMissionUI();

        if (!isBossBattle) { 
            let distMultiplier = (activeEffects.turbo > 0) ? 4 : 1;
            distance += safeDelta * 1 * distMultiplier;
            document.getElementById("distanceText").innerText = Math.floor(distance) + "m";
            
            let progress = Math.min(distance / 3000, 1);
            let speedMultiplier = 1 + (progress * 14);
            let currentSpeed = BASE_SPEED * speedMultiplier;
            if (activeEffects.slow > 0) currentSpeed *= 0.5;
            if (activeEffects.turbo > 0) currentSpeed *= 2.0; 
            gameSpeed = currentSpeed;
        } else {
            gameSpeed = BASE_SPEED * 0.5; 
        }

        if (!isBossBattle && distance >= nextBossTrigger) { startBossBattle(); }

        if (!isBossBattle && distance >= nextQuizDistance) {
            nextQuizDistance += 35; 
            pauseForQuiz(); return; 
        }

        if (isBossBattle) {
            updateBoss(safeDelta);
        } else {
            obstacleTimer += safeDelta;
            if (obstacleTimer >= nextObstacleTime && (nextQuizDistance - distance > 2)) {
                spawnObstacle(); obstacleTimer = 0; 
                let sm = gameSpeed / BASE_SPEED;
                let baseTime = randBetween(1.8, 2.6);
                nextObstacleTime = baseTime / (1 + (sm - 1) * 0.6); 
                if (nextObstacleTime < 0.2) nextObstacleTime = 0.2;
            }
            
            // [ÏàòÏ†ï] 140m Îç∞ÎØ∏ÏßÄ ÏõêÏù∏Ïù∏ Ïö¥ÏÑù ÏΩîÎìú ÏÇ≠Ï†úÎê®
            // Ï†ÅÍµ∞ Ïä§Ìè∞ Î°úÏßÅ
            enemySpawnTimer += safeDelta;
            if(enemySpawnTimer > 2.5 && !isBossBattle) { 
                spawnEnemyLogic();
                enemySpawnTimer = 0;
            }
        }

        updateEnemies(safeDelta); 
        updatePhysics(safeDelta);
        
        itemTimer += safeDelta;
        if (itemTimer >= nextItemTime) {
            spawnItem(); 
            itemTimer = 0; 
            nextItemTime = 8 + Math.random() * 4; 
        }

        for (let i = items.length - 1; i >= 0; i--) {
            let it = items[i];
            let left = parseFloat(it.style.left) || window.innerWidth;
            left -= gameSpeed * safeDelta;
            it.style.left = left + "px";
            if (left < -60) { it.remove(); items.splice(i, 1); continue; }
            
            const rP = player.getBoundingClientRect();
            const rI = it.getBoundingClientRect();
            if (rP.left < rI.right && rP.right > rI.left && rP.top < rI.bottom && rP.bottom > rI.top) {
                activateItem(it.dataset.type); it.remove(); items.splice(i, 1);
                spawnParticles(rI.left, rI.top, 'item');
                playSound('item');
                saveProgress();
            }
        }
        
        let speedMult = (gameSpeed / BASE_SPEED); 
        bg1X -= BG1_SPEED * speedMult * safeDelta;
        bg2X -= BG2_SPEED * speedMult * safeDelta;
        bg3X -= BG3_SPEED * speedMult * safeDelta;
        bg1.style.backgroundPosition = `${bg1X}px 0`;
        bg2.style.backgroundPosition = `${bg2X}px bottom`;
        bg3.style.backgroundPosition = `${bg3X}px bottom`;

    } catch(e) { console.error(e); }

    requestAnimationFrame(gameLoop);
  }

  function spawnEnemyLogic() {
      let type = 0;
      if (distance >= 500) type = 5;
      else if (distance >= 450) type = 4;
      else if (distance >= 400) type = 3;
      else if (distance >= 300) type = 2;
      else if (distance >= 200) type = 1;

      if (type > 0 && Math.random() < 0.6) { 
          spawnEnemy(type);
      }
  }

  function spawnEnemy(type) {
      const e = document.createElement("div");
      e.classList.add("enemy");
      e.style.backgroundImage = `url('enemy${type}.png')`;
      e.style.backgroundColor = 'red'; 
      
      e.type = type;
      e.hp = 1;
      e.timer = 0;
      e.state = 'enter'; 
      
      e.x = window.innerWidth + 50;
      e.y = randBetween(50, window.innerHeight - 150);
      e.style.left = e.x + "px";
      e.style.top = e.y + "px";
      
      gameArea.appendChild(e);
      enemies.push(e);
  }

  function updateEnemies(dt) {
      for (let i = enemies.length - 1; i >= 0; i--) {
          let e = enemies[i];
          e.timer += dt;

          if(e.state === 'enter') {
              e.x -= 100 * dt;
              if (e.x < window.innerWidth - 150) {
                  e.state = 'attack';
                  e.timer = 0;
              }
          } else if (e.state === 'attack') {
              if (e.type === 1) { 
                  if (e.timer < 2.0) { 
                      e.y += Math.sin(e.timer * 5) * 2;
                  } else { 
                      e.x -= 300 * dt; 
                  }
              } else if (e.type === 2) { 
                  if (e.timer > 3.0) {
                      spawnEnemyProjectile(e.x, e.y + 30, 'single');
                      e.timer = 0;
                  }
              } else if (e.type === 3) { 
                  if (e.timer > 4.0) {
                      spawnEnemyProjectile(e.x, e.y + 30, 'fan');
                      e.timer = 0;
                  }
              } else if (e.type === 4) { 
                  if (e.timer > 3.0) {
                      spawnEnemyProjectile(e.x, e.y + 30, 'explode');
                      e.timer = 0;
                  }
              } else if (e.type === 5) { 
                  if (e.timer > 3.5) {
                      fireEnemyLaser(e);
                      e.timer = 0;
                  }
              }
              
              if(e.type !== 1) e.x -= 50 * dt; 
          }

          e.style.left = e.x + "px";
          e.style.top = e.y + "px";

          if (e.x < -100) { e.remove(); enemies.splice(i, 1); }
      }
  }

  function spawnEnemyProjectile(x, y, pattern) {
      if(pattern === 'single') {
          createProj(x, y, -200, 0); 
      } else if (pattern === 'fan') {
          createProj(x, y, -300, 0);
          createProj(x, y, -280, 100);
          createProj(x, y, -280, -100);
      } else if (pattern === 'explode') {
          let p = createProj(x, y, -250, 0);
          p.isExplosive = true;
      }
  }

  function createProj(x, y, vx, vy) {
      const p = document.createElement("div");
      p.classList.add("projectile", "enemy-missile");
      p.style.left = x + "px"; p.style.top = y + "px";
      p.x = x; p.y = y; p.vx = vx; p.vy = vy;
      gameArea.appendChild(p);
      projectiles.push(p);
      return p;
  }

  function fireEnemyLaser(e) {
      const warning = document.createElement("div");
      warning.className = "enemy-laser-warning";
      warning.style.left = "0px"; warning.style.width = e.x + "px";
      warning.style.top = (e.y + 30) + "px";
      gameArea.appendChild(warning);

      setTimeout(() => {
          warning.remove();
          const laser = document.createElement("div");
          laser.className = "enemy-laser-beam";
          laser.style.left = "0px"; laser.style.width = e.x + "px";
          laser.style.top = (e.y + 15) + "px";
          gameArea.appendChild(laser);
          
          let duration = 0;
          let check = setInterval(() => {
              duration += 0.1;
              let laserY = parseFloat(laser.style.top);
              if(Math.abs(playerY - (window.innerHeight - laserY)) < 30 && !invincible) {
                  damageLife();
              }
              if(duration > 4.0) { 
                  clearInterval(check);
                  laser.remove();
              }
          }, 100);
      }, 1000); 
  }

  // [ÏàòÏ†ï] ÏïÑÏù¥ÌÖú ÏÉùÏÑ±: Î∞∞Í≤ΩÏÉâ Ìï†Îãπ ÏΩîÎìú Ï†úÍ±∞
  function spawnItem() {
    const types = ['invincible', 'turbo', 'slow', 'faith'];
    const images = { 
        'invincible': 'url("item_cross.png")', 
        'turbo': 'url("item_wings.png")', 
        'slow': 'url("item_wind.png")', 
        'faith': 'url("item_bible.png")' 
    };
    // const colors = ... (Ï†úÍ±∞Îê®)
    
    const item = document.createElement("div");
    const type = types[Math.floor(Math.random() * types.length)];
    
    item.classList.add("item");
    item.dataset.type = type;
    item.style.backgroundImage = images[type]; 
    // item.style.backgroundColor = colors[type]; // [ÏàòÏ†ï] Î∞∞Í≤ΩÏÉâ Ï†úÍ±∞
    
    item.x = window.innerWidth + 50;
    item.style.left = item.x + "px";
    item.style.top = randBetween(100, window.innerHeight - 150) + "px";
    
    document.getElementById("gameArea").appendChild(item);
    items.push(item);
  }

  function activateItem(type) {
    if(type === 'invincible') { activeEffects.invincible = 10; showFloatText("üõ°Ô∏è Î¨¥Ï†Å!"); }
    else if(type === 'turbo') { activeEffects.turbo = 5; showFloatText("üöÄ ÌÑ∞Î≥¥!"); }
    else if(type === 'slow') { activeEffects.slow = 10; showFloatText("üçÉ Í∞êÏÜç"); }
    else if(type === 'faith') { faith += 10; daily.faith20 += 10; updateDailyMissionUI(); showFloatText("üìò Faith +10"); }
    document.getElementById("faithText").innerText = faith;
  }

  function startBossBattle() {
    isBossBattle = true;
    bossLevel++;
    boss.maxHp = 6 + (bossLevel-1)*4;
    boss.hp = boss.maxHp;
    invincible = false;
    
    showFloatText(`‚ö†Ô∏è BOSS LV.${bossLevel} WARNING!`);
    const warning = document.getElementById('bossWarning');
    warning.innerText = `‚ö†Ô∏è BOSS LV.${bossLevel}!!`;
    warning.style.display = 'block';
    setTimeout(() => warning.style.display = 'none', 3000);
     
    obstacles.forEach(o => o.remove()); obstacles = [];
    enemies.forEach(e => e.remove()); enemies = []; 
    
    bossContainer.style.display = 'block';
    setTimeout(() => { bossContainer.style.right = '20px'; }, 100);
    document.getElementById('dailyMissionBox').style.display = 'none';
    saveProgress();
  }

  function updateBoss(delta) {
    if (boss.hp <= 0) return;
    boss.actionTimer += delta;
    if (boss.state === 'idle') {
        boss.y += boss.vy;
        if (boss.y > 80 || boss.y < 20) boss.vy *= -1; 
        bossContainer.style.top = boss.y + "%";
    }
    if (bossLevel >= 2 && boss.state === 'idle' && boss.actionTimer > 5.0 && Math.random() < 0.01) { startBossDash(); }
    if (bossLevel >= 3 && boss.state === 'idle' && boss.actionTimer > 7.0 && Math.random() < 0.01) { startBossLaser(); }

    boss.shootTimer += delta;
    if (boss.state === 'idle' && boss.shootTimer > 2.0) {
        bossShoot(bossLevel, (1.0 + (bossLevel*0.2)) * 0.4); 
        boss.shootTimer = 0;
    }
  }

  function startBossDash() {
    boss.state = 'dash';
    bossBody.classList.add('boss-charging');
    showFloatText("üí¢ ÎèåÏßÑ Ï§ÄÎπÑ!");
    setTimeout(() => {
        bossBody.classList.remove('boss-charging');
        bossBody.classList.add('boss-dashing');
        bossContainer.style.transition = "right 0.5s ease-in";
        bossContainer.style.right = "80%"; 
        setTimeout(() => {
             if(playerY > (100-boss.y)/100 * window.innerHeight - 100 && playerY < (100-boss.y)/100 * window.innerHeight + 50) {
                 damageLife();
             }
        }, 250);
        setTimeout(() => {
            bossContainer.style.right = "20px";
            bossBody.classList.remove('boss-dashing');
            boss.state = 'idle';
            boss.actionTimer = 0;
        }, 800);
    }, 1000);
  }

  function startBossLaser() {
    boss.state = 'laser';
    showFloatText("‚ö° Î†àÏù¥Ï†Ä Ï∂©Ï†Ñ!");
    setTimeout(() => {
        const laser = document.createElement('div');
        laser.className = 'boss-laser';
        laser.style.top = (boss.y + 5) + "%";
        laser.style.display = 'block';
        gameArea.appendChild(laser);
        let checkLaser = setInterval(() => {
            let laserH = (100 - boss.y) / 100 * window.innerHeight;
            if (Math.abs(playerY - laserH + 50) < 40 && !invincible) { 
                 damageLife();
            }
        }, 50);
        setTimeout(() => {
            clearInterval(checkLaser);
            laser.remove();
            boss.state = 'idle';
            boss.actionTimer = 0;
        }, 1000);
    }, 1500);
  }

  function bossShoot(count, speedMult) {
    for(let i=0; i<count; i++) {
        setTimeout(() => {
            const m = document.createElement("div");
            m.classList.add("projectile", "boss-missile");
            const rect = bossContainer.getBoundingClientRect();
            const startX = rect.left; const startY = rect.top + 30; 
            const pX = 120; const pY = window.innerHeight - playerY - 30;
            const dx = pX - startX; const dy = pY - startY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const speed = 300 * speedMult;
            const vx = (dx / dist) * speed; const vy = (dy / dist) * speed;
            m.style.left = startX + "px"; m.style.top = startY + "px";
            m.x = startX; m.y = startY; m.vx = vx; m.vy = vy; 
            m.isBossMissile = true; 
            gameArea.appendChild(m); projectiles.push(m);
        }, i * 300); 
    }
  }

  function damageBoss() {
    boss.hp--;
    bossHpFill.style.width = (boss.hp / boss.maxHp * 100) + "%";
    showFloatText("üí• Î≥¥Ïä§ ÌÉÄÍ≤©!");
    if (boss.hp <= 0) {
        bossContainer.style.transition = "top 1s ease-in";
        bossContainer.style.top = "120%"; 
        spawnParticles(window.innerWidth-100, window.innerHeight-100, 'dust');
        setTimeout(() => { 
            bossContainer.style.display = 'none'; 
            isBossBattle = false;
            
            invincible = false;
            activeEffects.invincible = 0;
            activeEffects.turbo = 0;
            
            if(!daily.completed) document.getElementById('dailyMissionBox').style.display = 'block';
            faith += 100 * bossLevel; daily.faith20 += 100; updateDailyMissionUI();
            showFloatText(`üéâ Î≥¥Ïä§ Ï≤òÏπò! (+${100*bossLevel} Faith)`);
            playSound('clear');
            nextBossTrigger = distance + 200; 
            saveProgress(); 
        }, 1000);
    }
  }

  function updatePhysics(delta) {
    if (activeEffects.fly > 0) { playerY += (targetY - playerY) * 0.1; velocity = 0; if(speedLines) speedLines.style.display = "none"; } 
    else if (activeEffects.turbo > 0) { let tY = 200; playerY += (tY - playerY) * 0.1; velocity = 0; if(speedLines) speedLines.style.display = "block"; } 
    else { velocity += gravity; playerY += velocity; if(speedLines) speedLines.style.display = "none"; }

    if (playerY < 0) playerY = 0;
    if (playerY > window.innerHeight - 110) playerY = window.innerHeight - 110;
    player.style.bottom = playerY + "px";

    const safeActive = (val) => (val && val > 0);

    for (let i = playerMissiles.length - 1; i >= 0; i--) {
        let m = playerMissiles[i];
        let mx = parseFloat(m.style.left);
        mx += 500 * delta; 
        m.style.left = mx + "px";
        
        if (mx > window.innerWidth) { m.remove(); playerMissiles.splice(i, 1); continue; }

        for (let j = enemies.length - 1; j >= 0; j--) {
            let e = enemies[j];
            let rM = m.getBoundingClientRect();
            let rE = e.getBoundingClientRect();
            
            if (rM.right > rE.left && rM.left < rE.right && rM.bottom > rE.top && rM.top < rE.bottom) {
                e.hp--;
                m.remove(); playerMissiles.splice(i, 1);
                spawnParticles(rE.left, rE.top, 'spark');
                if (e.hp <= 0) {
                    e.remove(); enemies.splice(j, 1);
                    showFloatText("üí• Í≤©Ìåå!");
                }
                break; 
            }
        }
    }

    for (let i = projectiles.length - 1; i >= 0; i--) {
        let p = projectiles[i];
        let cx = parseFloat(p.style.left) || p.x;
        let cy = parseFloat(p.style.top) || p.y;
        cx += p.vx * delta; cy += p.vy * delta;
        p.style.left = cx + "px"; p.style.top = cy + "px";

        if (cx < -100 || cx > window.innerWidth + 100 || cy < -100 || cy > window.innerHeight + 100) {
            p.remove(); projectiles.splice(i, 1); continue;
        }

        if (p.isExplosive && !p.exploded && Math.abs(cx - 120) < 100) { 
             p.exploded = true;
             const boom = document.createElement("div");
             boom.className = "explosion-area";
             boom.style.width = "150px"; boom.style.height = "150px";
             boom.style.left = (cx - 50) + "px"; boom.style.top = (cy - 50) + "px";
             gameArea.appendChild(boom);
             setTimeout(() => boom.remove(), 500);
             
             const pRect = player.getBoundingClientRect();
             const bRect = boom.getBoundingClientRect();
             if (pRect.right > bRect.left && pRect.left < bRect.right && pRect.bottom > bRect.top && pRect.top < bRect.bottom) {
                 if(!invincible && !safeActive(activeEffects.invincible)) damageLife();
             }
             p.remove(); projectiles.splice(i, 1); continue;
        }

        if (!p.isReflected && !safeActive(activeEffects.invincible) && !invincible && !safeActive(activeEffects.summon) && !safeActive(activeEffects.turbo)) {
            const rP = player.getBoundingClientRect();
            const rM = p.getBoundingClientRect();
            if (rP.right > rM.left && rP.left < rM.right && rP.bottom > rM.top && rP.top < rM.bottom) {
                damageLife(); p.remove(); projectiles.splice(i, 1); continue;
            }
        }

        if (isBossBattle && p.isReflected) {
            const bRect = bossContainer.getBoundingClientRect();
            const pRect = p.getBoundingClientRect();
            if (pRect.right > bRect.left && pRect.left < bRect.right && pRect.bottom > bRect.top && pRect.top < bRect.bottom) {
                damageBoss(); p.remove(); projectiles.splice(i, 1); continue;
            }
        }
    }

    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        if (!safeActive(activeEffects.invincible) && !invincible) {
            const rP = player.getBoundingClientRect();
            const rE = e.getBoundingClientRect();
            if (rP.right > rE.left && rP.left < rE.right && rP.bottom > rE.top && rP.top < rE.bottom) {
                damageLife();
                e.remove(); enemies.splice(i, 1); 
                continue;
            }
        }
    }

    for (let i = obstacles.length - 1; i >= 0; i--) {
        let o = obstacles[i];
        let left = parseFloat(o.style.left) || window.innerWidth;
        left -= gameSpeed * delta;
        o.style.left = left + "px";
        let rw = 60; if(o.classList.contains('obs-long')) rw = 240;

        if (left + rw < 0) {
            o.remove(); obstacles.splice(i, 1);
            obstacleSurviveCount++;
            if (obstacleSurviveCount >= 5) {
                combo++; faith++; daily.faith20++; 
                saveData.faith = faith; document.getElementById("faithText").innerText = faith;
                const ce = document.getElementById("comboEffect");
                ce.style.display = "block"; ce.innerText = `COMBO +${combo}!`;
                setTimeout(() => ce.style.display = "none", 1000);
                obstacleSurviveCount = 0; saveProgress(); updateDailyMissionUI();
            }
            continue;
        }
        
        if (!safeActive(activeEffects.invincible) && !invincible && !safeActive(activeEffects.summon) && !safeActive(activeEffects.turbo)) {
            const rP = player.getBoundingClientRect();
            const rO = o.getBoundingClientRect();
            if (rP.right > rO.left && rP.left < rO.right && rP.bottom > rO.top && rP.top < rO.bottom) {
                damageLife(); break;
            }
        }
        if(currentSkin === 'stephanie' && left < 50 && !o.passed) {
            faith++; daily.faith20++; document.getElementById("faithText").innerText = faith; o.passed = true;
        }
    }
  }

  function spawnMeteor(mult) { 
    const m = document.createElement("div"); m.classList.add("projectile");
    const sx = window.innerWidth + Math.random()*200; const sy = -100;
    let s = 150 + (mult * 200);
    m.style.left=sx+"px"; m.style.top=sy+"px";
    m.x = sx; m.y = sy; m.vx=-s*0.8; m.vy=s; 
    gameArea.appendChild(m); projectiles.push(m);
  }

  function spawnObstacle() { 
    if(!running || activeEffects.turbo>0) return;
    const randi = (min,max)=>Math.floor(Math.random()*(max-min))+min;
    if(distance > 50 && Math.random() < 0.65) {
        let cnt = (Math.random()<0.3)?2:1;
        for(let k=0; k<cnt; k++) {
            const b = document.createElement("div"); b.classList.add("obstacle", "obs-long");
            b.x = window.innerWidth+80; b.style.left = b.x+"px";
            let sh = window.innerHeight;
            if(cnt===2) { if(k===0) b.style.bottom=randBetween(30, sh*0.35)+"px"; else b.style.bottom=randBetween(sh*0.55, sh*0.85)+"px"; }
            else { let r=Math.random(); if(r<0.2) b.style.bottom="0px"; else if(r<0.4) b.style.top="0px"; else b.style.bottom=randBetween(50, sh-120)+"px"; }
            gameArea.appendChild(b); obstacles.push(b);
        }
        return;
    }
    const type = (Math.random()<0.5)?'obs-log':'obs-rock';
    const sx = window.innerWidth+80;
    if(Math.random()<0.5) {
        const b = document.createElement("div"); b.classList.add("obstacle", "obs-cap", "obs-ground", type);
        b.style.height=randi(90,220)+"px"; b.x=sx; b.style.left=sx+"px"; b.style.bottom="0";
        gameArea.appendChild(b); obstacles.push(b);
    } else {
        let th=randi(120,260); let gap=randi(160,220); let bh=Math.max(80, window.innerHeight-th-gap);
        const t = document.createElement("div"); t.classList.add("obstacle", "obs-cap", "obs-ceil", type);
        t.style.height=th+"px"; t.x=sx; t.style.left=sx+"px"; t.style.top="0";
        const b = document.createElement("div"); b.classList.add("obstacle", "obs-cap", "obs-ground", type);
        b.style.height=bh+"px"; b.x=sx; b.style.left=sx+"px"; b.style.bottom="0";
        gameArea.appendChild(t); obstacles.push(t); gameArea.appendChild(b); obstacles.push(b);
    }
  }

  function damageLife() {
    if(activeEffects.revive > 0) { life=3; document.getElementById("lifeText").innerText=life; activeEffects.revive=0; activeEffects.invincible=3; showFloatText("üëº Î∂ÄÌôú!"); return; }
    if(activeEffects.turbo>0 || activeEffects.invincible>0 || invincible || !running) return;
    life--; document.getElementById("lifeText").innerText=life;
    invincible=true; player.style.opacity="0.4"; setTimeout(()=>{invincible=false; player.style.opacity="1";},800);
    playSound('hit');
    if(life<=0) gameOver();
  }

  function showFloatText(text) { const r=player.getBoundingClientRect(); const e=document.createElement("div"); e.classList.add("float-text"); e.innerText=text; e.style.left=(r.left+10)+"px"; e.style.top=(r.top-20)+"px"; document.body.appendChild(e); setTimeout(()=>e.remove(),1000); }
  function startGameNow() { 
      document.getElementById("startGuide").style.display="none"; 
      running=true; 
      lastTime=performance.now(); 
      if(sounds['bgm']) sounds['bgm'].play().catch(e=>console.log("BGM Error:", e));
      requestAnimationFrame(gameLoop); 
      updateDailyMissionUI(); 
  }
   
  async function saveProgress() { 
    saveData.faith = faith; 
    try{await fetch(API_URL,{method:"POST",body:JSON.stringify({type:"save",id,saveData})});}catch(e){} localStorage.setItem("run_save",JSON.stringify(saveData)); 
  }
  async function gameOver() { if(rankingSaved)return; running=false; invincible=true; player.style.opacity="0.4"; document.getElementById("finalDist").innerText=Math.floor(distance); document.getElementById("gameOverModal").style.display="flex"; try{await fetch(API_URL,{method:"POST",body:JSON.stringify({type:"updateRanking",id,name,distance:Math.floor(distance),message:""})});}catch(e){} rankingSaved=true; }
  async function confirmRanking() { const msg=document.getElementById("rankMsg").value.trim(); try{await fetch(API_URL,{method:"POST",body:JSON.stringify({type:"updateComment",id,message:msg})}); alert("Îì±Î°ùÏôÑÎ£å"); window.location.href="/TrapGame/menu.html";}catch(e){alert("Ïò§Î•ò"); window.location.href="/TrapGame/menu.html";} }
   
  async function pauseForQuiz() {
    if (!running) return;
    running = false; document.getElementById("loadingQuiz").style.display = "flex";
    try {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ type: "getQuiz" }) });
      const txt = await res.text();
      document.getElementById("loadingQuiz").style.display = "none";
      if (txt === "noquiz") { running = true; lastTime = performance.now(); requestAnimationFrame(gameLoop); return; }
      const quiz = JSON.parse(txt);
      document.getElementById("quizQuestion").innerText = quiz.question;
      document.getElementById("btnA").innerText = "A) " + quiz.A;
      document.getElementById("btnB").innerText = "B) " + quiz.B;
      document.getElementById("btnC").innerText = "C) " + quiz.C;
      window.correctAnswer = quiz.answer;
      document.getElementById("quizModal").style.display = "flex";
    } catch (err) {
      alert("ÌÄ¥Ï¶à Î°úÎî© Ïã§Ìå®. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
    }
  }

  function answerQuiz(sel) {
    document.getElementById("quizModal").style.display = "none";
    if (sel === window.correctAnswer) {
      const ef = document.getElementById("correctEffect");
      ef.style.display = "block"; setTimeout(() => (ef.style.display = "none"), 800);
      faith += 5; saveData.faith = faith; document.getElementById("faithText").innerText = faith;
      daily.quiz3++; localStorage.setItem("dailyMission", JSON.stringify(daily)); saveProgress();
    } else { damageLife(); }
    if (life > 0) { running = true; lastTime = performance.now(); requestAnimationFrame(gameLoop); }
  }
   
  let lastT=0; document.addEventListener("touchend",e=>{const n=Date.now();if(n-lastT<300)e.preventDefault();lastT=n;},{passive:false});
</script>
</body>
</html>
