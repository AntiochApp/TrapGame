<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Disciple Run - World Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff">

<style>
  @font-face {
    font-family: 'DungGeunMo';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
    font-weight: normal;
    font-style: normal;
  }

  body {
    margin: 0; padding: 0;
    width: 100vw; height: 100vh;
    background-color: #2c2c2c;
    font-family: 'DungGeunMo', sans-serif;
    overflow: hidden; /* ë°”ë”” ìŠ¤í¬ë¡¤ ë§‰ê³  ë‚´ë¶€ ë·°í¬íŠ¸ì—ì„œ ìŠ¤í¬ë¡¤ */
  }

  /* 1. ë·°í¬íŠ¸: í™”ë©´ ì „ì²´ë¥¼ ì°¨ì§€í•˜ë©° ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­ */
  #viewport {
    width: 100%; height: 100%;
    overflow: auto; /* ìŠ¤í¬ë¡¤ í—ˆìš© */
    cursor: grab; /* ë§ˆìš°ìŠ¤ ì»¤ì„œ ëª¨ì–‘ */
    /* ëª¨ë°”ì¼ í„°ì¹˜ ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ */
    -webkit-overflow-scrolling: touch; 
    position: relative;
  }
  #viewport:active { cursor: grabbing; }

  /* 2. ë§µ ì»¨í…Œì´ë„ˆ: ê³ ì •ëœ í° ì‚¬ì´ì¦ˆ (í°ì—ì„œ ë“œë˜ê·¸í•´ì„œ ë³¼ ìˆ˜ ìˆê²Œ) */
  #mapContainer {
    position: relative;
    /* ëª¨ë°”ì¼ì—ì„œë„ ì˜ ë³´ì´ë„ë¡ ê°•ì œë¡œ í¬ê²Œ ì¡ìŒ */
    width: 1000px; 
    /* ì›ë³¸ ë¹„ìœ¨ 5:6 ìœ ì§€ (1000px : 1200px) */
    height: 1200px; 
    background-image: url('WorldMap.png'); 
    background-size: cover;
    background-position: center;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    margin: 0 auto; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ ì‹œë„ */
  }

  /* ìƒë‹¨ UI (ìŠ¤í¬ë¡¤ê³¼ ë¬´ê´€í•˜ê²Œ í™”ë©´ì— ê³ ì •) */
  .top-ui {
    position: fixed; top: 10px; left: 10px; right: 10px;
    display: flex; justify-content: space-between;
    z-index: 1000;
    pointer-events: none; /* UI ë°°ê²½ í„°ì¹˜ ë¬´ì‹œ */
  }
  .ui-btn {
    background: #5d4037; color: #fff;
    border: 3px solid #3e2723;
    padding: 8px 16px;
    font-family: 'DungGeunMo', sans-serif;
    font-size: 16px; cursor: pointer;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
    pointer-events: auto; /* ë²„íŠ¼ë§Œ í„°ì¹˜ ê°€ëŠ¥ */
  }
  .ui-btn:active { transform: translate(2px, 2px); box-shadow: none; }

  /* ì„± ìœ„ì¹˜ ì¡ëŠ” ì»¨í…Œì´ë„ˆ (í´ë¦­ ì˜ì—­ ì•„ë‹˜, ìœ„ì¹˜ë§Œ ì¡ìŒ) */
  .castle-spot {
    position: absolute;
    width: 0; height: 0;
    /* ì¢Œí‘œ ê¸°ì¤€ì  */
  }

  /* 3. [ìˆ˜ì •] ì„± ì •ë³´ ë°•ìŠ¤ ìì²´ê°€ ë²„íŠ¼ì´ ë¨ */
  .castle-card {
    position: absolute;
    /* ìœ„ì¹˜ëŠ” spot ê¸°ì¤€ ì¤‘ì•™ ì •ë ¬ */
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9); /* ë°°ê²½ ë” ì§„í•˜ê²Œ */
    color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    border: 3px solid #bcaaa4; /* í…Œë‘ë¦¬ ê°•ì¡° */
    text-align: center;
    cursor: pointer;
    z-index: 100;
    box-shadow: 0 6px 10px rgba(0,0,0,0.6);
    transition: transform 0.1s, border-color 0.2s;
    
    /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 100px;
  }

  /* ëˆŒë €ì„ ë•Œ íš¨ê³¼ (ì„íŒ©íŠ¸) */
  .castle-card:active {
    transform: translate(-50%, -45%) scale(0.95);
    border-color: #ff9800;
    background: rgba(50, 30, 20, 0.95);
  }

  /* ë³´ìŠ¤ ì•„ì´ì½˜ */
  .lord-icon {
    width: 50px; height: 50px; 
    margin-bottom: 6px;
    background-size: contain; background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
    border: 2px solid #5d4037;
    border-radius: 4px;
    background-color: #3e2723;
  }

  .castle-name { 
    color: #ffd700; 
    font-weight: bold; 
    font-size: 15px; 
    margin-bottom: 2px; 
    text-shadow: 2px 2px 0 #000;
  }
  .lord-name { 
    color: #00e5ff; 
    font-size: 13px; 
    text-shadow: 1px 1px 0 #000;
  }

  /* ë¡œë”© í™”ë©´ */
  #loading {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    color: white; 
    display: flex; 
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    font-size: 20px; 
    z-index: 2000;
    backdrop-filter: blur(5px);
  }
  .loading-spinner {
    width: 40px; height: 40px; border: 4px solid #fff; 
    border-top: 4px solid #ff9800; border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 15px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body oncontextmenu="return false" onselectstart="return false">

  <div class="top-ui">
    <button class="ui-btn" onclick="location.href='menu.html'">â† ë©”ë‰´</button>
    <div class="ui-btn" style="background:#333;">ğŸ° ì›”ë“œë§µ</div>
  </div>

  <div id="loading">
    <div class="loading-spinner"></div>
    <div>ì„±ì£¼ ì •ë³´ë¥¼ ìˆ˜ì‹  ì¤‘...</div>
  </div>

  <div id="viewport">
    <div id="mapContainer">
      <div id="castlesLayer"></div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  // ì„± ìœ„ì¹˜ ë°ì´í„° (ì¢Œí‘œëŠ” ê¸°ì¡´ ìœ ì§€í•˜ë˜, í° ë§µ ë¹„ìœ¨ì— ë§ê²Œ ë°°ì¹˜ë¨)
  const CASTLES = [
    { id: 1, name: "ë² ë“œë¡œ ì„±", top: 18, left: 18 },
    { id: 2, name: "ì•ˆë“œë ˆ ì„±", top: 15, left: 51 },
    { id: 3, name: "ì•¼ê³ ë³´ ì„±", top: 20, left: 82 },
    { id: 4, name: "ìš”í•œ ì„±",   top: 38, left: 23 },
    { id: 5, name: "ë¹Œë¦½ ì„±",   top: 40, left: 56 },
    { id: 6, name: "ë°”ëŒë¡œë§¤ ì„±", top: 45, left: 85 },
    { id: 7, name: "ë„ë§ˆ ì„±",   top: 70, left: 16 },
    { id: 8, name: "ë§ˆíƒœ ì„±",   top: 58, left: 38 },
    { id: 9, name: "ì•ŒíŒ¨ì˜¤ ì„±", top: 60, left: 63 },
    { id: 10, name: "ë‹¤ëŒ€ì˜¤ ì„±", top: 82, left: 38 },
    { id: 11, name: "ì‹œëª¬ ì„±",   top: 80, left: 65 },
    { id: 12, name: "ë§›ë””ì•„ ì„±", top: 75, left: 85 }
  ];

  async function loadMapData() {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        redirect: "follow",
        body: JSON.stringify({ type: "getAllCastles" })
      });
      const castleData = await res.json();
      renderCastles(castleData);
    } catch (e) {
      console.error(e);
      alert("ì„± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      renderCastles([]);
    } finally {
      const loadingEl = document.getElementById("loading");
      loadingEl.style.transition = "opacity 0.5s";
      loadingEl.style.opacity = "0";
      setTimeout(() => loadingEl.style.display = "none", 500);
      
      // [ì¤‘ìš”] ë¡œë”©ì´ ëë‚˜ë©´ ë§µì˜ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
      centerMap();
    }
  }

  function renderCastles(serverData) {
    const layer = document.getElementById("castlesLayer");
    layer.innerHTML = "";

    CASTLES.forEach(c => {
      const info = serverData ? serverData.find(d => d.id == c.id) : null;
      
      let ownerName = "NPC ìˆ˜í˜¸ì";
      let ownerSkin = "C_boss" + c.id; 
      
      if (info && info.ownerName) {
        ownerName = `ğŸ‘‘ ${info.ownerName}`;
        ownerSkin = `skin_${info.skin}`;
      }

      // ìœ„ì¹˜ ì¡ëŠ” ìŠ¤íŒŸ
      const spot = document.createElement("div");
      spot.className = "castle-spot";
      spot.style.top = c.top + "%";
      spot.style.left = c.left + "%";

      // [ìˆ˜ì •] ì‹¤ì œ í´ë¦­ ê°€ëŠ¥í•œ ì¹´ë“œ ë²„íŠ¼
      const card = document.createElement("div");
      card.className = "castle-card";
      card.onclick = () => enterCastle(c.id); // ì¹´ë“œ ìì²´ë¥¼ ëˆŒëŸ¬ì•¼ ì…ì¥

      const skinUrl = `${ownerSkin}.png`;
      const fallbackUrl = "disciple.png";

      card.innerHTML = `
        <div class="lord-icon" style="background-image:url('${skinUrl}'), url('${fallbackUrl}')"></div>
        <div class="castle-name">${c.name}</div>
        <div class="lord-name">${ownerName}</div>
      `;
      
      spot.appendChild(card);
      layer.appendChild(spot);
    });
  }

  function enterCastle(id) {
    window.location.href = `Siege.html?castle=${id}`;
  }

  // ë§µ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™ì‹œí‚¤ëŠ” í•¨ìˆ˜
  function centerMap() {
    const viewport = document.getElementById('viewport');
    const map = document.getElementById('mapContainer');
    
    // (ë§µ ë„ˆë¹„ - í™”ë©´ ë„ˆë¹„) / 2
    const scrollLeft = (map.offsetWidth - viewport.offsetWidth) / 2;
    const scrollTop = (map.offsetHeight - viewport.offsetHeight) / 2;

    viewport.scrollTo({ top: scrollTop, left: scrollLeft, behavior: 'smooth' });
  }

  // [PCìš©] ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ ì¶”ê°€ (ëª¨ë°”ì¼ì€ ê¸°ë³¸ í„°ì¹˜ ìŠ¤í¬ë¡¤ ë¨)
  const viewport = document.getElementById('viewport');
  let isDown = false;
  let startX;
  let startY;
  let scrollLeft;
  let scrollTop;

  viewport.addEventListener('mousedown', (e) => {
    isDown = true;
    viewport.style.cursor = 'grabbing';
    startX = e.pageX - viewport.offsetLeft;
    startY = e.pageY - viewport.offsetTop;
    scrollLeft = viewport.scrollLeft;
    scrollTop = viewport.scrollTop;
  });

  viewport.addEventListener('mouseleave', () => {
    isDown = false;
    viewport.style.cursor = 'grab';
  });

  viewport.addEventListener('mouseup', () => {
    isDown = false;
    viewport.style.cursor = 'grab';
  });

  viewport.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - viewport.offsetLeft;
    const y = e.pageY - viewport.offsetTop;
    const walkX = (x - startX) * 1.5; // ë“œë˜ê·¸ ì†ë„ ì¡°ì ˆ
    const walkY = (y - startY) * 1.5;
    viewport.scrollLeft = scrollLeft - walkX;
    viewport.scrollTop = scrollTop - walkY;
  });

  loadMapData();
</script>

</body>
</html>
