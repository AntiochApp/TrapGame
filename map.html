<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Disciple Run - World Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff">

<style>
  @font-face {
    font-family: 'DungGeunMo';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
    font-weight: normal;
    font-style: normal;
  }

  body {
    margin: 0; padding: 0;
    width: 100vw; height: 100vh;
    background-color: #2c2c2c;
    font-family: 'DungGeunMo', sans-serif;
    overflow: hidden; /* ë°”ë”” ìŠ¤í¬ë¡¤ ë§‰ê³  ë‚´ë¶€ ë·°í¬íŠ¸ì—ì„œ ìŠ¤í¬ë¡¤ */
  }

  /* 1. ë·°í¬íŠ¸: í™”ë©´ ì „ì²´ë¥¼ ì°¨ì§€í•˜ë©° ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­ */
  #viewport {
    width: 100%; height: 100%;
    overflow: auto; /* ìŠ¤í¬ë¡¤ í—ˆìš© */
    cursor: grab; /* ë§ˆìš°ìŠ¤ ì»¤ì„œ ëª¨ì–‘ */
    /* ëª¨ë°”ì¼ í„°ì¹˜ ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ */
    -webkit-overflow-scrolling: touch; 
    position: relative;
  }
  #viewport:active { cursor: grabbing; }

  /* 2. ë§µ ì»¨í…Œì´ë„ˆ: ê³ ì •ëœ í° ì‚¬ì´ì¦ˆ (í°ì—ì„œ ë“œë˜ê·¸í•´ì„œ ë³¼ ìˆ˜ ìˆê²Œ) */
  #mapContainer {
    position: relative;
    /* ëª¨ë°”ì¼ì—ì„œë„ ì˜ ë³´ì´ë„ë¡ ê°•ì œë¡œ í¬ê²Œ ì¡ìŒ */
    width: 1000px; 
    /* ì›ë³¸ ë¹„ìœ¨ 5:6 ìœ ì§€ (1000px : 1200px) */
    height: 1200px; 
    background-image: url('WorldMap.png'); 
    background-size: cover;
    background-position: center;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    margin: 0 auto; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ ì‹œë„ */
  }

  /* ìƒë‹¨ UI (ìŠ¤í¬ë¡¤ê³¼ ë¬´ê´€í•˜ê²Œ í™”ë©´ì— ê³ ì •) */
  .top-ui {
    position: fixed; top: 10px; left: 10px; right: 10px;
    display: flex; justify-content: space-between;
    z-index: 1000;
    pointer-events: none; /* UI ë°°ê²½ í„°ì¹˜ ë¬´ì‹œ */
  }

  /* [ìˆ˜ì •] í”½ì…€ ìŠ¤íƒ€ì¼ ë²„íŠ¼ (menu.html ìŠ¤íƒ€ì¼ ì ìš©) */
  .map-pixel-btn {
    pointer-events: auto; /* ë²„íŠ¼ë§Œ í„°ì¹˜ ê°€ëŠ¥ */
    position: relative;
    border: 3px solid #000; border-radius: 8px; 
    color: #fff; cursor: pointer;
    font-family: 'DungGeunMo', monospace;
    font-size: 16px;
    padding: 8px 16px;
    transition: all 0.1s;
    box-shadow: 
      inset 3px 3px 0 rgba(255,255,255,0.4),
      4px 4px 0 rgba(0,0,0,0.2),
      4px 4px 0 2px #000;
    top: 0; left: 0;
  }
  .map-pixel-btn:active {
    top: 4px; left: 4px;
    box-shadow: inset 4px 4px 0 rgba(0,0,0,0.2); 
  }
  .map-pixel-btn:hover { filter: brightness(1.1); }

  /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ìƒ‰ìƒ */
  .btn-back {
    background: #8d6e63;
    box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), 4px 4px 0 #5d4037, 4px 4px 0 2px #000;
  }
  
  /* ì„±ì£¼ í˜„í™©íŒ ë²„íŠ¼ ìƒ‰ìƒ (ëˆˆì— ë„ëŠ” ê¸ˆìƒ‰/ì£¼í™© ê³„ì—´) */
  .btn-owner-board {
    background: #ffb74d; 
    color: #3e2723;
    font-weight: bold;
    box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), 4px 4px 0 #e65100, 4px 4px 0 2px #000;
    text-shadow: 1px 1px 0 rgba(255,255,255,0.3);
  }

  /* ì„± ìœ„ì¹˜ ì¡ëŠ” ì»¨í…Œì´ë„ˆ (í´ë¦­ ì˜ì—­ ì•„ë‹˜, ìœ„ì¹˜ë§Œ ì¡ìŒ) */
  .castle-spot {
    position: absolute;
    width: 0; height: 0;
    /* ì¢Œí‘œ ê¸°ì¤€ì  */
  }

  /* ì„± ì •ë³´ ë°•ìŠ¤ ìì²´ê°€ ë²„íŠ¼ì´ ë¨ */
  .castle-card {
    position: absolute;
    /* ìœ„ì¹˜ëŠ” spot ê¸°ì¤€ ì¤‘ì•™ ì •ë ¬ */
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9); /* ë°°ê²½ ë” ì§„í•˜ê²Œ */
    color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    border: 3px solid #bcaaa4; /* í…Œë‘ë¦¬ ê°•ì¡° */
    text-align: center;
    cursor: pointer;
    z-index: 100;
    box-shadow: 0 6px 10px rgba(0,0,0,0.6);
    transition: transform 0.1s, border-color 0.2s;
    
    /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 100px;
  }

  /* ëˆŒë €ì„ ë•Œ íš¨ê³¼ (ì„íŒ©íŠ¸) */
  .castle-card:active {
    transform: translate(-50%, -45%) scale(0.95);
    border-color: #ff9800;
    background: rgba(50, 30, 20, 0.95);
  }

  /* ë³´ìŠ¤ ì•„ì´ì½˜ */
  .lord-icon {
    width: 50px; height: 50px; 
    margin-bottom: 6px;
    background-size: contain; background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
    border: 2px solid #5d4037;
    border-radius: 4px;
    background-color: #3e2723; /* íˆ¬ëª… ë°°ê²½ì¼ ë•Œ ë’¤ì— ê¹”ë¦¬ëŠ” ìƒ‰ */
  }

  .castle-name { 
    color: #ffd700; 
    font-weight: bold; 
    font-size: 15px; 
    margin-bottom: 2px; 
    text-shadow: 2px 2px 0 #000;
  }
  .lord-name { 
    color: #00e5ff; 
    font-size: 13px; 
    text-shadow: 1px 1px 0 #000;
  }

  /* ë¡œë”© í™”ë©´ */
  #loading {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    color: white; 
    display: flex; 
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    font-size: 20px; 
    z-index: 2000;
    backdrop-filter: blur(5px);
  }
  .loading-spinner {
    width: 40px; height: 40px; border: 4px solid #fff; 
    border-top: 4px solid #ff9800; border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 15px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  /* [ì¶”ê°€] ì„±ì£¼ í˜„í™©íŒ ëª¨ë‹¬ */
  #ownerBoardModal {
    display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.8);
    z-index: 3000; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
  }
  .board-box {
    width: 90%; max-width: 400px; background: #fdf6e3;
    border: 4px solid #5d4037; border-radius: 8px;
    padding: 20px; text-align: center;
    box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
    max-height: 80vh; overflow-y: auto;
  }
  .board-title {
    font-size: 24px; font-weight: bold; color: #3e2723;
    margin-bottom: 15px; border-bottom: 3px dashed #8d6e63;
    padding-bottom: 10px;
  }
  .owner-list-item {
    display: flex; align-items: center;
    background: #fff; margin-bottom: 8px;
    padding: 8px; border: 2px solid #d7ccc8;
    border-radius: 4px; box-shadow: 2px 2px 0 #eee;
  }
  .owner-list-icon {
    width: 40px; height: 40px; border-radius: 4px;
    background-size: contain; background-repeat: no-repeat; background-position: center;
    border: 1px solid #000; margin-right: 10px; background-color: #333;
  }
  .owner-list-info { flex: 1; text-align: left; }
  .owner-castle-title { font-size: 14px; font-weight: bold; color: #ff9800; }
  .owner-player-name { font-size: 16px; color: #333; font-weight: bold; }
  .btn-close-board {
    margin-top: 15px; padding: 10px 20px; background: #ef5350;
    color: white; border: 2px solid #b71c1c; font-family: 'DungGeunMo';
    cursor: pointer; font-size: 16px; box-shadow: 3px 3px 0 #b71c1c;
  }
  .btn-close-board:active { transform: translate(3px, 3px); box-shadow: none; }
</style>
</head>
<body oncontextmenu="return false" onselectstart="return false">

  <div class="top-ui">
    <button class="map-pixel-btn btn-back" onclick="goBackToMenu()">â† ë©”ë‰´</button>
    <button class="map-pixel-btn btn-owner-board" onclick="openOwnerBoard()">ğŸ‘‘ ì„±ì£¼ í˜„í™©</button>
  </div>

  <div id="loading">
    <div class="loading-spinner"></div>
    <div>ì„±ì£¼ ì •ë³´ë¥¼ ìˆ˜ì‹  ì¤‘...</div>
  </div>

  <div id="viewport">
    <div id="mapContainer">
      <div id="castlesLayer"></div>
    </div>
  </div>

  <div id="ownerBoardModal">
    <div class="board-box">
      <div class="board-title">ğŸ° ì„±ì£¼ í˜„í™©íŒ</div>
      <div id="ownerListContainer">
        </div>
      <button class="btn-close-board" onclick="closeOwnerBoard()">ë‹«ê¸°</button>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  // ì„± ìœ„ì¹˜ ë°ì´í„° (ì¢Œí‘œëŠ” ê¸°ì¡´ ìœ ì§€í•˜ë˜, í° ë§µ ë¹„ìœ¨ì— ë§ê²Œ ë°°ì¹˜ë¨)
  const CASTLES = [
    { id: 1, name: "ë² ë“œë¡œ ì„±", top: 18, left: 18 },
    { id: 2, name: "ì•ˆë“œë ˆ ì„±", top: 15, left: 51 },
    { id: 3, name: "ì•¼ê³ ë³´ ì„±", top: 20, left: 82 },
    { id: 4, name: "ìš”í•œ ì„±",   top: 38, left: 23 },
    { id: 5, name: "ë¹Œë¦½ ì„±",   top: 40, left: 56 },
    { id: 6, name: "ë°”ëŒë¡œë§¤ ì„±", top: 45, left: 85 },
    { id: 7, name: "ë„ë§ˆ ì„±",   top: 70, left: 16 },
    { id: 8, name: "ë§ˆíƒœ ì„±",   top: 58, left: 38 },
    { id: 9, name: "ì•ŒíŒ¨ì˜¤ ì„±", top: 60, left: 63 },
    { id: 10, name: "ë‹¤ëŒ€ì˜¤ ì„±", top: 82, left: 38 },
    { id: 11, name: "ì‹œëª¬ ì„±",   top: 80, left: 65 },
    { id: 12, name: "ë§›ë””ì•„ ì„±", top: 75, left: 85 }
  ];

  // [ì¶”ê°€] ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì„± ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
  let cachedCastleData = [];

  // [ìˆ˜ì •] ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸° í•¨ìˆ˜ (ë¶€ëª¨ ì°½ì˜ ëª¨ë‹¬ ë‹«ê¸°)
  function goBackToMenu() {
    try {
      if (window.parent && window.parent.closeMapModal) {
        window.parent.closeMapModal();
      } else {
        // ë‹¨ë… ì‹¤í–‰ ì‹œ fallback
        window.location.href = 'menu.html';
      }
    } catch(e) {
      window.location.href = 'menu.html';
    }
  }

  async function loadMapData() {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        redirect: "follow",
        body: JSON.stringify({ type: "getAllCastles" })
      });
      const castleData = await res.json();
      cachedCastleData = castleData; // ë°ì´í„° ìºì‹± (í˜„í™©íŒìš©)
      renderCastles(castleData);
    } catch (e) {
      console.error(e);
      alert("ì„± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      renderCastles([]);
    } finally {
      const loadingEl = document.getElementById("loading");
      loadingEl.style.transition = "opacity 0.5s";
      loadingEl.style.opacity = "0";
      setTimeout(() => loadingEl.style.display = "none", 500);
      
      // [ì¤‘ìš”] ë¡œë”©ì´ ëë‚˜ë©´ ë§µì˜ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
      centerMap();
    }
  }

  function renderCastles(serverData) {
    const layer = document.getElementById("castlesLayer");
    layer.innerHTML = "";

    CASTLES.forEach(c => {
      const info = serverData ? serverData.find(d => d.id == c.id) : null;
      
      let ownerName = "NPC ìˆ˜í˜¸ì";
      let ownerSkin = "C_boss" + c.id; 
      
      // ìœ ì €ê°€ ì ë ¹í•œ ê²½ìš°
      if (info && info.ownerName) {
        ownerName = `ğŸ‘‘ ${info.ownerName}`;
        ownerSkin = `skin_${info.skin}`;
      }

      // ìœ„ì¹˜ ì¡ëŠ” ìŠ¤íŒŸ
      const spot = document.createElement("div");
      spot.className = "castle-spot";
      spot.style.top = c.top + "%";
      spot.style.left = c.left + "%";

      // ì‹¤ì œ í´ë¦­ ê°€ëŠ¥í•œ ì¹´ë“œ ë²„íŠ¼
      const card = document.createElement("div");
      card.className = "castle-card";
      card.onclick = () => enterCastle(c.id);

      const skinUrl = `${ownerSkin}.png`;
      // [ìˆ˜ì •] fallbackUrl ì œê±°: ì´ë¯¸ì§€ê°€ ê²¹ì³ ë³´ì´ì§€ ì•Šë„ë¡ ìˆ˜ì •í•¨.
      // ì´ì œ skinUrl í•˜ë‚˜ë§Œ ë¡œë“œí•˜ë¯€ë¡œ, ë³´ìŠ¤ë©´ ë³´ìŠ¤ì–¼êµ´, ìœ ì €ë©´ ìœ ì €ìŠ¤í‚¨ë§Œ ëœ¸.

      card.innerHTML = `
        <div class="lord-icon" style="background-image:url('${skinUrl}')"></div>
        <div class="castle-name">${c.name}</div>
        <div class="lord-name">${ownerName}</div>
      `;
      
      spot.appendChild(card);
      layer.appendChild(spot);
    });
  }

  // ì…ì¥ ì‹œ 4000m ë‹¬ì„± ì—¬ë¶€ ì²´í¬
  function enterCastle(id) {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì €ì¥ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const saveStr = localStorage.getItem("run_save");
    let bestDistance = 0;

    if (saveStr) {
      try {
        const saveData = JSON.parse(saveStr);
        bestDistance = saveData.highScore || 0; 
      } catch (e) {
        console.warn("ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨", e);
      }
    }

    if (bestDistance < 4000) {
      alert("ğŸš« [ì…ì¥ ë¶ˆê°€]\n\nìµœê³  ê¸°ë¡ 4000më¥¼ ë‹¬ì„±í•´ì•¼\nê³µì„±ì „ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!\n\n(í˜„ì¬ ê¸°ë¡: " + Math.floor(bestDistance) + "m)");
      return;
    }

    // ì¡°ê±´ ì¶©ì¡± ì‹œ ì…ì¥
    window.location.href = `Siege.html?castle=${id}`;
  }

  // [ìˆ˜ì •] ì„±ì£¼ í˜„í™©íŒ ë¡œì§ (ì´ë¯¸ì§€ ê²¹ì¹¨ í•´ê²° ì ìš©)
  function openOwnerBoard() {
    const modal = document.getElementById("ownerBoardModal");
    const container = document.getElementById("ownerListContainer");
    
    let html = "";
    CASTLES.forEach(c => {
        const info = cachedCastleData ? cachedCastleData.find(d => d.id == c.id) : null;
        
        let ownerName = "NPC ìˆ˜í˜¸ì";
        let ownerSkin = "C_boss" + c.id;
        let styleClass = "color:#666;";

        if (info && info.ownerName) {
            ownerName = `ğŸ‘‘ ${info.ownerName}`;
            ownerSkin = `skin_${info.skin}`;
            styleClass = "color:#d32f2f;";
        }
        
        const skinUrl = `${ownerSkin}.png`;
        // ì—¬ê¸°ì„œë„ fallback url ì œê±°

        html += `
          <div class="owner-list-item">
             <div class="owner-list-icon" style="background-image:url('${skinUrl}')"></div>
             <div class="owner-list-info">
               <div class="owner-castle-title">${c.name}</div>
               <div class="owner-player-name" style="${styleClass}">${ownerName}</div>
             </div>
          </div>
        `;
    });
    
    container.innerHTML = html;
    modal.style.display = "flex";
  }

  function closeOwnerBoard() {
    document.getElementById("ownerBoardModal").style.display = "none";
  }

  // ë§µ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™ì‹œí‚¤ëŠ” í•¨ìˆ˜
  function centerMap() {
    const viewport = document.getElementById('viewport');
    const map = document.getElementById('mapContainer');
    
    // (ë§µ ë„ˆë¹„ - í™”ë©´ ë„ˆë¹„) / 2
    const scrollLeft = (map.offsetWidth - viewport.offsetWidth) / 2;
    const scrollTop = (map.offsetHeight - viewport.offsetHeight) / 2;

    viewport.scrollTo({ top: scrollTop, left: scrollLeft, behavior: 'smooth' });
  }

  // [PCìš©] ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ ì¶”ê°€ (ëª¨ë°”ì¼ì€ ê¸°ë³¸ í„°ì¹˜ ìŠ¤í¬ë¡¤ ë¨)
  const viewport = document.getElementById('viewport');
  let isDown = false;
  let startX;
  let startY;
  let scrollLeft;
  let scrollTop;

  viewport.addEventListener('mousedown', (e) => {
    isDown = true;
    viewport.style.cursor = 'grabbing';
    startX = e.pageX - viewport.offsetLeft;
    startY = e.pageY - viewport.offsetTop;
    scrollLeft = viewport.scrollLeft;
    scrollTop = viewport.scrollTop;
  });

  viewport.addEventListener('mouseleave', () => {
    isDown = false;
    viewport.style.cursor = 'grab';
  });

  viewport.addEventListener('mouseup', () => {
    isDown = false;
    viewport.style.cursor = 'grab';
  });

  viewport.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - viewport.offsetLeft;
    const y = e.pageY - viewport.offsetTop;
    const walkX = (x - startX) * 1.5; // ë“œë˜ê·¸ ì†ë„ ì¡°ì ˆ
    const walkY = (y - startY) * 1.5;
    viewport.scrollLeft = scrollLeft - walkX;
    viewport.scrollTop = scrollTop - walkY;
  });

  loadMapData();
</script>

</body>
</html>
