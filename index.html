<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì•ˆë””ì˜¥ ì²­ë…„ë¶€ ê²Œì„ â€“ Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<style>
  :root {
    --bg-panel: rgba(253, 250, 242, 0.95);
    --border-dark: #3a2513;
    --accent: #c47a3f;
    --accent-dark: #8b4f26;
    --text-main: #3a2513;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0; padding: 0; min-height: 100vh;
    display: flex; justify-content: center; align-items: center;
    background: url("https://antiochapp.github.io/TrapGame/bg_sky.png") no-repeat center bottom;
    background-size: cover;
    background-attachment: fixed;
    font-family: "Pretendard", system-ui, -apple-system, sans-serif;
    color: var(--text-main);
  }

  body::before {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 248, 235, 0.3); z-index: -1;
  }

  .pixel-card {
    width: 90%; max-width: 400px;
    padding: 40px 24px 32px; /* ìƒë‹¨ ì—¬ë°± í™•ë³´ */
    background: var(--bg-panel);
    border-radius: 16px;
    border: 4px solid var(--border-dark);
    box-shadow: 0 0 0 4px rgba(255,255,255,0.6), 0 12px 20px rgba(0,0,0,0.3);
    backdrop-filter: blur(5px);
    position: relative;
    margin-top: 20px;
  }

  /* [ìˆ˜ì •] ìºë¦­í„° ì¥ì‹ ì˜ì—­ */
  .deco-chars {
    display: flex;
    justify-content: center;
    gap: 20px; /* ê°„ê²© ë„“í˜ */
    margin-bottom: 15px;
  }

  /* [ìˆ˜ì •] ìºë¦­í„° ìŠ¤íƒ€ì¼ (ë°•ìŠ¤ ì œê±°, ì´ë¯¸ì§€ë§Œ í‘œì‹œ) */
  .char-img {
    width: 54px; height: 54px; /* í¬ê¸° ì¡°ê¸ˆ í‚¤ì›€ */
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
    animation: bounce 1s infinite alternate; /* ì½©ì½© ë›°ëŠ” íš¨ê³¼ */
  }
  
  /* ìºë¦­í„°ë³„ ì—‡ë°•ì ì í”„ */
  .char-img:nth-child(1) { animation-delay: 0s; }
  .char-img:nth-child(2) { animation-delay: 0.2s; }
  .char-img:nth-child(3) { animation-delay: 0.4s; }

  /* ì´ë¯¸ì§€ ì—°ê²° */
  .moses { background-image: url("pixel_moses.png"); } 
  .david { background-image: url("pixel_david.png"); }
  .peter { background-image: url("pixel_peter.png"); }

  @keyframes bounce {
    0% { transform: translateY(0); }
    100% { transform: translateY(-8px); }
  }

  .pixel-title {
    text-align: center; font-size: 28px; font-weight: 900;
    margin: 0 0 8px; letter-spacing: -0.02em; color: #4b2e12;
  }

  .pixel-sub {
    text-align: center; font-size: 14px; color: #8a735a; margin-bottom: 28px;
    font-weight: 600;
  }

  label { display: block; font-size: 13px; margin-top: 12px; margin-bottom: 6px; font-weight: 700; color: #5d4037; }

  input {
    width: 100%; padding: 12px 14px; border-radius: 8px;
    border: 2px solid #c9b79c; font-size: 15px; background: #fff; outline: none;
    transition: border 0.2s;
  }
  input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(196, 122, 63, 0.15); }

  .btn-main {
    width: 100%; padding: 14px; margin-top: 24px; border-radius: 10px; border: 0;
    background: var(--accent); color: #fff; font-size: 16px; font-weight: 800;
    cursor: pointer; box-shadow: 0 4px 0 var(--accent-dark); transition: transform 0.1s;
  }
  .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--accent-dark); }
  .btn-main:disabled { background: #aaa; box-shadow: none; cursor: not-allowed; }

  .link-row { text-align: center; margin-top: 18px; font-size: 13px; color: #888; }
  .link-btn {
    cursor: pointer; color: var(--accent-dark); font-weight: bold;
    margin: 0 8px; display: inline-block; padding: 4px;
  }
  .link-btn:hover { text-decoration: underline; }

  .hidden { display: none; }

  .spinner {
    width: 24px; height: 24px; border: 4px solid #e2d5c2;
    border-top: 4px solid var(--accent); border-radius: 50%;
    margin: 16px auto 0; display: none; animation: spin 0.9s linear infinite;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  .shake { animation: shake 0.4s ease-in-out; }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }
</style>
</head>

<body>

<div class="pixel-card" id="loginBox">
  
  <div class="deco-chars">
    <div class="char-img moses"></div>
    <div class="char-img david"></div>
    <div class="char-img peter"></div>
  </div>

  <h1 class="pixel-title">Disciple Run</h1>
  <div class="pixel-sub">ì•ˆë””ì˜¥ ì²­ë…„ë¶€ í™€ë¦¬ ìŠ¤íŒŒí¬ ëŸ°!</div>

  <label for="loginId">ID</label>
  <input id="loginId" type="text" autocomplete="username" placeholder="ì•„ì´ë”” ì…ë ¥">

  <label for="loginPw">Password</label>
  <input id="loginPw" type="password" autocomplete="current-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="handleEnter(event, login)">

  <button class="btn-main" onclick="login()" id="loginBtn">ë¡œê·¸ì¸</button>
  <div id="loginSpinner" class="spinner"></div>

  <div class="link-row">
    <span class="link-btn" onclick="showSignup()">íšŒì›ê°€ì…</span> |
    <span class="link-btn" onclick="showFindPw()">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</span>
  </div>
</div>

<div class="pixel-card hidden" id="signupBox">
  <h1 class="pixel-title">íšŒì›ê°€ì…</h1>
  <div class="pixel-sub">ë‚˜ë§Œì˜ ì‹ ì•™ ì—¬ì •ì„ ì‹œì‘í•´ë³´ì„¸ìš”</div>

  <label for="newId">ID</label>
  <input id="newId" type="text" placeholder="ì‚¬ìš©í•  ì•„ì´ë””">

  <label for="newPw">Password</label>
  <input id="newPw" type="password" placeholder="ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸">

  <label for="newName">ì´ë¦„</label>
  <input id="newName" type="text" placeholder="ë³¸ëª… (ë­í‚¹ í‘œì‹œìš©)">

  <label for="newBible">ì¢‹ì•„í•˜ëŠ” ì„±ê²½ ì¸ë¬¼</label>
  <input id="newBible" type="text" placeholder="ì˜ˆ: ë‹¤ìœ—, ë°”ìš¸ (ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ì§ˆë¬¸)">

  <button class="btn-main" onclick="signup()" id="signupBtn">ê°€ì…í•˜ê¸°</button>
  <div id="signupSpinner" class="spinner"></div>

  <div class="link-row">
    <span class="link-btn" onclick="showLogin()">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
  </div>
</div>

<div class="pixel-card hidden" id="findPwBox">
  <h1 class="pixel-title">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h1>
  <div class="pixel-sub">ê°€ì… ì‹œ ì…ë ¥í•œ ì •ë³´ë¥¼ ì ì–´ì£¼ì„¸ìš”</div>

  <label for="findName">ì´ë¦„</label>
  <input id="findName" type="text">

  <label for="findBible">ì¢‹ì•„í•˜ëŠ” ì„±ê²½ ì¸ë¬¼</label>
  <input id="findBible" type="text" onkeypress="handleEnter(event, findPw)">

  <button class="btn-main" onclick="findPw()" id="findPwBtn">ì°¾ê¸°</button>
  <div id="findPwSpinner" class="spinner"></div>

  <div class="link-row">
    <span class="link-btn" onclick="showLogin()">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";

  const loginBox  = document.getElementById("loginBox");
  const signupBox = document.getElementById("signupBox");
  const findPwBox = document.getElementById("findPwBox");

  function handleEnter(e, func) {
    if (e.key === "Enter") func();
  }

  function showSignup() {
    clearInputs();
    loginBox.classList.add("hidden");
    signupBox.classList.remove("hidden");
    findPwBox.classList.add("hidden");
  }
  function showFindPw() {
    clearInputs();
    loginBox.classList.add("hidden");
    signupBox.classList.add("hidden");
    findPwBox.classList.remove("hidden");
  }
  function showLogin() {
    clearInputs();
    loginBox.classList.remove("hidden");
    signupBox.classList.add("hidden");
    findPwBox.classList.add("hidden");
  }

  function clearInputs() {
    document.querySelectorAll("input").forEach(el => el.value = "");
  }

  // ë¡œê·¸ì¸
  async function login() {
    const idInput = document.getElementById("loginId");
    const pwInput = document.getElementById("loginPw");
    const id = idInput.value.trim();
    const pw = pwInput.value.trim();
    const btn = document.getElementById("loginBtn");
    const spinner = document.getElementById("loginSpinner");

    if (!id || !pw) {
      alert("IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    btn.disabled = true;
    spinner.style.display = "block";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "login", id, password: pw })
      });

      const txt = await res.text();

      if (txt === "fail") {
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨!\nID í˜¹ì€ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        loginBox.classList.add("shake");
        setTimeout(() => loginBox.classList.remove("shake"), 400);
      } else {
        const data = JSON.parse(txt);
        localStorage.setItem("run_id", id);
        localStorage.setItem("run_name", data.name);
        localStorage.setItem("run_bible", data.bible);
        localStorage.setItem("run_save", JSON.stringify(data.saveData));
        window.location.href = "/TrapGame/menu.html";
      }
    } catch (e) {
      console.error(e);
      alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }

    btn.disabled = false;
    spinner.style.display = "none";
  }

  // íšŒì›ê°€ì…
  async function signup() {
    const id = document.getElementById("newId").value.trim();
    const pw = document.getElementById("newPw").value.trim();
    const name = document.getElementById("newName").value.trim();
    const bible = document.getElementById("newBible").value.trim();

    if (!id || !pw || !name || !bible) {
      alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    const btn = document.getElementById("signupBtn");
    const spinner = document.getElementById("signupSpinner");

    btn.disabled = true;
    spinner.style.display = "block";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "signup", id, password: pw, name, bible })
      });
      
      const txt = await res.text();
      
      if(txt === "exist") {
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤.");
      } else {
        alert("íšŒì›ê°€ì… í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰\nì´ì œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        showLogin();
      }
    } catch (e) {
      alert("íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }

    btn.disabled = false;
    spinner.style.display = "none";
  }

  // ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°
  async function findPw() {
    const name = document.getElementById("findName").value.trim();
    const bible = document.getElementById("findBible").value.trim();

    if (!name || !bible) {
      alert("ì´ë¦„ê³¼ ì¢‹ì•„í•˜ëŠ” ì„±ê²½ ì¸ë¬¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const btn = document.getElementById("findPwBtn");
    const spinner = document.getElementById("findPwSpinner");
    
    btn.disabled = true;
    spinner.style.display = "block";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "findPw", name, bible })
      });

      const txt = await res.text();

      if (txt === "notfound") {
        alert("ì¼ì¹˜í•˜ëŠ” ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      } else {
        const data = JSON.parse(txt);
        alert(`[ì •ë³´ í™•ì¸]\nID: ${data.id}\nPW: ${data.password}`);
      }
    } catch (e) {
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }

    btn.disabled = false;
    spinner.style.display = "none";
  }
</script>

</body>
</html>
