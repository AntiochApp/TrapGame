<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì•ˆë””ì˜¥ ì²­ë…„ë¶€ ê²Œì„ â€“ Menu</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff">

<style>
  /* í°íŠ¸ ì •ì˜ */
  @font-face {
    font-family: 'DungGeunMo';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
    font-weight: normal;
    font-style: normal;
  }

  :root {
    --bg-overlay: rgba(60, 40, 20, 0.4);
    --panel-color: #fdf6e3;
    --border-color: #5d4037;
    --primary-color: #ff9800;
    --primary-shadow: #e65100;
    --secondary-color: #8d6e63;
    --secondary-shadow: #5d4037;
    --checkin-color: #29b6f6;
    --checkin-shadow: #0288d1;
    --text-color: #3e2723;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0; padding: 0; height: 100vh;
    display: flex; flex-direction: column;
    font-family: 'DungGeunMo', monospace; /* í°íŠ¸ ë³€ê²½ */
    color: var(--text-color);
    background: url("https://antiochapp.github.io/TrapGame/bg_sky.png") no-repeat center bottom;
    background-size: cover;
    overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
  }

  /* ë°°ê²½ì— í”½ì…€ íŒ¨í„´ ì¶”ê°€ (index.htmlê³¼ í†µì¼) */
  body::before {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-image: 
      linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    z-index: -1;
    pointer-events: none;
  }

  /* ìƒë‹¨ ë°” ë””ìì¸ ê°œì„  */
  .top-bar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px; 
    background: rgba(93, 64, 55, 0.95); 
    color: #fff8e1;
    font-size: 16px; 
    border-bottom: 4px solid #3e2723;
    box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    z-index: 10;
  }

  .game-logo { display: flex; align-items: center; gap: 10px; font-size: 18px; letter-spacing: 1px; text-shadow: 2px 2px 0 #000; }
  .logo-pixel {
    width: 32px; height: 32px; border-radius: 4px; background: #ffca28;
    border: 2px solid #fff; 
    background-image: url("pixel_cross.png"); background-size: cover;
    box-shadow: 0 0 0 2px #000;
  }

  .user-info { display: flex; align-items: center; gap: 12px; }
  .logout-btn {
    padding: 6px 12px; font-size: 14px; background: #ef5350; color: white;
    border: 2px solid #b71c1c; border-radius: 4px; cursor: pointer; 
    font-family: 'DungGeunMo', monospace;
    box-shadow: inset 2px 2px 0 rgba(255,255,255,0.3), 2px 2px 0 #b71c1c;
  }
  .logout-btn:active { transform: translateY(2px); box-shadow: none; }

  /* ë‰´ìŠ¤ í‹°ì»¤ ìŠ¤íƒ€ì¼ */
  .news-ticker {
    width: 100%;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    overflow: hidden;
    padding: 8px 0;
    font-size: 14px;
    white-space: nowrap;
    border-bottom: 2px solid #5d4037;
    z-index: 9;
  }
  .ticker-wrap {
    width: 100%;
    overflow: hidden;
  }
  
  .ticker-content {
    display: inline-block;
    padding-left: 100%;
    will-change: transform; 
  }

  /* í‹°ì»¤ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ */
  .ticker-moving {
    animation: tickerScroll 35s linear infinite; 
  }

  @keyframes tickerScroll {
    0% { transform: translate3d(0, 0, 0); }
    100% { transform: translate3d(-100%, 0, 0); }
  }
  .ticker-item {
    margin-right: 50px;
    color: #ffd54f;
    text-shadow: 2px 2px 0 #000;
  }

  /* ë©”ì¸ ë©”ë‰´ ì»¨í…Œì´ë„ˆ (index.html ìŠ¤íƒ€ì¼ ì ìš©) */
  #menuWrapper { 
    flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; 
    padding: 20px;
  }
  
  .container {
    width: 100%; max-width: 420px;
    padding: 30px 24px;
    background: var(--panel-color);
    border: 4px solid var(--border-color);
    border-radius: 8px;
    /* 3D í”½ì…€ ê·¸ë¦¼ì íš¨ê³¼ */
    box-shadow: 
      inset 4px 4px 0px #ffffff,
      inset -4px -4px 0px #d7ccc8,
      8px 8px 0px rgba(0,0,0,0.3);
    text-align: center;
    position: relative;
    /* ë‘¥ë‘¥ ë– ë‹¤ë‹ˆëŠ” ì• ë‹ˆë©”ì´ì…˜ */
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
    100% { transform: translateY(0px); }
  }

  /* ì¥ì‹ ìš”ì†Œ (ë³„) */
  .container::after {
    content: "â˜…"; position: absolute; top: 15px; right: 20px;
    font-size: 28px; color: #ffb74d; transform: rotate(15deg);
    text-shadow: 2px 2px 0 #000;
  }

  h1 { 
    font-size: 36px; margin: 0; 
    color: var(--text-color); 
    text-shadow: 3px 3px 0px #ffe0b2, 4px 4px 0px rgba(0,0,0,0.2);
    letter-spacing: 2px;
  }
  .sub { 
    font-size: 16px; color: var(--secondary-color); 
    margin-top: 8px; margin-bottom: 30px; 
    background: #fff; display: inline-block; padding: 4px 12px;
    border-radius: 20px; border: 2px dashed #bcaaa4;
  }

  /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ë²„íŠ¼ */
  .menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 12px;
  }

  /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ì•„ì¼€ì´ë“œ ë²„íŠ¼) */
  .pixel-btn {
    position: relative;
    border: 3px solid #000; border-radius: 8px; 
    color: #fff; cursor: pointer;
    font-family: 'DungGeunMo', monospace;
    font-size: 18px;
    transition: all 0.1s;
    display: flex; flex-direction: column; 
    justify-content: center; align-items: center; gap: 6px;
    /* ì…ì²´ê° */
    box-shadow: 
      inset 3px 3px 0 rgba(255,255,255,0.4),
      4px 4px 0 rgba(0,0,0,0.2),
      4px 4px 0 2px #000;
    top: 0; left: 0;
  }
  
  .pixel-btn:active:not(.disabled) { 
    top: 4px; left: 4px;
    box-shadow: inset 4px 4px 0 rgba(0,0,0,0.2); 
  }
  .pixel-btn:hover { filter: brightness(1.1); }

  /* ê²Œì„ ì‹œì‘ (ê°€ë¡œ ê½‰ ì°¸) */
  .btn-start {
    grid-column: span 2;
    background: #66bb6a;
    box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), 4px 4px 0 #2e7d32, 4px 4px 0 2px #000;
    padding: 20px; font-size: 24px;
    text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
  }
  .btn-start span { display: flex; align-items: center; gap: 10px; }

  /* ì¶œì„ì²´í¬ ë²„íŠ¼ (íŒŒë€ìƒ‰) */
  .btn-checkin {
    grid-column: span 2;
    background: var(--checkin-color);
    box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), 4px 4px 0 var(--checkin-shadow), 4px 4px 0 2px #000;
    padding: 14px; font-size: 18px;
    flex-direction: row; 
  }
  
  .btn-checkin.disabled {
    background: #cfd8dc; color: #90a4ae; 
    box-shadow: none; border-color: #90a4ae;
    cursor: default; top: 2px; left: 2px;
  }

  /* ì¼ë°˜ ë²„íŠ¼ (ì˜¤ë Œì§€) */
  .btn-normal {
    background: var(--primary-color);
    box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), 4px 4px 0 var(--primary-shadow), 4px 4px 0 2px #000;
    padding: 15px; height: 100px;
  }
  .btn-icon { font-size: 28px; margin-bottom: 4px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2)); }

  /* ê³µì§€ì‚¬í•­ ë²„íŠ¼ (ê°ˆìƒ‰) */
  .btn-notice {
    background: var(--secondary-color);
    box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), 4px 4px 0 var(--secondary-shadow), 4px 4px 0 2px #000;
    padding: 15px; height: 100px;
  }

  .version { margin-top: 24px; font-size: 14px; color: #a1887f; opacity: 0.8; }

  /* ëª¨ë‹¬ ê³µí†µ ë””ìì¸ ì—…ë°ì´íŠ¸ */
  .modal-bg {
    display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.7);
    justify-content: center; align-items: center; padding: 16px; z-index: 999;
    backdrop-filter: blur(4px);
  }
  .modal {
    width: 100%; max-width: 420px; background: var(--panel-color);
    padding: 24px; border-radius: 8px; border: 4px solid var(--border-color);
    box-shadow: 10px 10px 0 rgba(0,0,0,0.5); /* ì§™ì€ ê·¸ë¦¼ì */
    text-align: center;
    max-height: 85vh; overflow-y: auto;
    position: relative;
  }
  .modal h2 { 
    margin-top: 0; color: var(--text-color); font-size: 24px; 
    border-bottom: 3px dashed #bcaaa4; padding-bottom: 12px; margin-bottom: 12px; 
    text-shadow: 2px 2px 0 #fff;
  }
  
  /* ë­í‚¹ ìŠ¤íƒ€ì¼ */
  .rank-item {
    display: flex; justify-content: space-between; align-items: center;
    margin: 8px 0; padding: 12px 14px;
    background: #fff; border: 2px solid #d7ccc8;
    font-size: 16px; text-align: left;
    box-shadow: 3px 3px 0 #eee;
  }
  .rank-rank { font-weight: 900; color: var(--primary-shadow); width: 30px; font-size: 18px; }
  .rank-info { flex: 1; margin-left: 8px; }
  .rank-score { font-weight: bold; color: #d32f2f; background: #ffebee; padding: 4px 8px; border-radius: 4px; font-size: 14px; }
  
  /* ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ */
  .notice-list { text-align: left; min-height: 150px; font-size: 16px; }
  .notice-item { border-bottom: 2px solid #d7ccc8; padding: 10px 0; }
  .notice-title { font-weight: bold; color: #333; display:block; margin-bottom: 4px; text-shadow: 1px 1px 0 #eee;}
  .notice-date { font-size: 12px; color: #8d6e63; }
  .notice-content { font-size: 14px; color: #555; margin-top: 4px; white-space: pre-wrap; line-height: 1.4; }
  
  /* ê´€ë¦¬ì ë²„íŠ¼ */
  .admin-controls { margin-top: 15px; display: flex; gap: 8px; justify-content: flex-end; }
  .btn-mini { 
    padding: 6px 12px; border-radius: 4px; border: 2px solid #000; 
    font-size: 14px; cursor: pointer; font-weight: bold; color: white; 
    font-family: 'DungGeunMo', monospace;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
  }
  .btn-mini:active { transform: translate(2px, 2px); box-shadow: none; }
  .btn-write { background: #5c6bc0; }
  .btn-del { background: #ef5350; margin-left: auto; }

  .close-btn {
    margin-top: 18px; padding: 12px; background: #555;
    color: #fff; border-radius: 4px; cursor: pointer; border: 2px solid #333;
    font-weight: bold; width: 100%; font-size: 18px; font-family: 'DungGeunMo', monospace;
    box-shadow: 4px 4px 0 #222;
  }
  .close-btn:hover { background: #333; }
  .close-btn:active { transform: translate(4px, 4px); box-shadow: none; }

  /* ìŠ¤í”¼ë„ˆ */
  .spinner {
    width: 30px; height: 30px; border: 4px solid #eee;
    border-top: 4px solid var(--primary-color); border-radius: 50%;
    margin: 20px auto; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* ì…ë ¥ì°½ */
  .input-group { margin-top: 10px; text-align: left; display: none; background: #fffbf0; padding: 12px; border: 2px solid var(--border-color);}
  .input-field { 
    width: 100%; padding: 10px; margin-bottom: 8px; 
    border: 2px solid #bcaaa4; font-family: 'DungGeunMo', monospace; 
    font-size: 16px; background: #fff;
  }
  textarea.input-field { height: 80px; resize: none; }
</style>
</head>

<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false">

<div class="top-bar">
  <div class="game-logo">
    <div class="logo-pixel"></div>
    <span>Disciple Run</span>
  </div>
  <div class="user-info">
    <span id="playerName" style="font-weight:bold;">Guest</span>
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<div class="news-ticker">
  <div class="ticker-wrap">
    <div class="ticker-content" id="tickerArea">
      <span class="ticker-item">ğŸ”” í™˜ì˜í•©ë‹ˆë‹¤! ì•ˆë””ì˜¥ ì²­ë…„ë¶€ í™€ë¦¬ ìŠ¤íŒŒí¬ ëŸ°!</span>
      <span class="ticker-item">ğŸ’’ ì˜¤ëŠ˜ë„ ì£¼ë‹˜ ì•ˆì—ì„œ ìŠ¹ë¦¬í•˜ì„¸ìš”!</span>
    </div>
  </div>
</div>

<div id="menuWrapper">
  <div class="container">
    <h1>ë©”ì¸ ë©”ë‰´</h1>
    <div class="sub">ANTIOCH HOLY SPARK RUN</div>

    <div class="menu-grid">
      <button class="pixel-btn btn-start" onclick="startGame()">
        <span>ğŸš€ ê²Œì„ ì‹œì‘ RUN!</span>
      </button>

      <button class="pixel-btn btn-checkin" id="checkinBtn" onclick="dailyCheckIn()">
        <span id="checkinText">ğŸ“… ì¶œì„ì²´í¬ (+ì¡°ê°)</span>
      </button>

      <button class="pixel-btn btn-normal" onclick="openStore()">
        <div class="btn-icon">ğŸ›’</div>
        <span>ìƒì </span>
      </button>
      <button class="pixel-btn btn-normal" onclick="showRanking()">
        <div class="btn-icon">ğŸ†</div>
        <span>ë­í‚¹</span>
      </button>

      <button class="pixel-btn btn-notice" onclick="openNotice()">
        <div class="btn-icon">ğŸ“¢</div>
        <span>ê³µì§€ì‚¬í•­</span>
      </button>
      
      <button class="pixel-btn" style="background:#bcaaa4; cursor:default; box-shadow:none; border-color:#8d6e63;">
        <div class="btn-icon">ğŸ”’</div>
        <span>ì¤€ë¹„ì¤‘</span>
      </button>
    </div>

    <div class="version">v2.1 Â· Antioch Youth (Remastered)</div>
  </div>
</div>

<div id="rankingModal" class="modal-bg">
  <div class="modal">
    <h2>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h2>
    <div id="rankingList"></div>
    <button class="close-btn" onclick="closeModal('rankingModal')">ë‹«ê¸°</button>
  </div>
</div>

<div id="noticeModal" class="modal-bg">
  <div class="modal">
    <h2>ğŸ“¢ ì•ˆë””ì˜¥ ê²Œì‹œíŒ</h2>
    <div id="noticeList" class="notice-list">
      <p style="color:#999; text-align:center; padding:20px;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    
    <div id="writeForm" class="input-group">
      <input type="text" id="noticeTitle" class="input-field" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
      <textarea id="noticeContent" class="input-field" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <div style="display:flex; gap:5px;">
        <button class="btn-mini btn-write" style="flex:1" onclick="saveNotice()">ë“±ë¡ ì™„ë£Œ</button>
        <button class="btn-mini" style="background:#999; flex:1" onclick="cancelWrite()">ì·¨ì†Œ</button>
      </div>
    </div>

    <div class="admin-controls">
      <button class="btn-mini btn-write" onclick="tryWrite()">âœï¸ ê´€ë¦¬ì ê¸€ì“°ê¸°</button>
    </div>
    <button class="close-btn" onclick="closeModal('noticeModal')">ë‹«ê¸°</button>
  </div>
</div>

<script>
  // [ë³´ì•ˆ] F12 ë° ê°œë°œì ë„êµ¬ ë‹¨ì¶•í‚¤ ì°¨ë‹¨
  document.addEventListener('keydown', function(e) {
    if (e.key === 'F12' || 
       (e.ctrlKey && e.shiftKey && e.key === 'I') || 
       (e.ctrlKey && e.shiftKey && e.key === 'J') || 
       (e.ctrlKey && e.key === 'U')) {
      e.preventDefault();
      alert("ë³´ì•ˆì„ ìœ„í•´ ê°œë°œì ë„êµ¬ ì‚¬ìš©ì´ ì œí•œë©ë‹ˆë‹¤.");
    }
  });

  const API_URL = "https://script.google.com/macros/s/AKfycbzA10H2TuXRDXBXcttvHHR0Q1sOu8zGpYmrdGhfH-wBsl623k2ydwUkwL7wR8F90mC5Pg/exec";
  const ADMIN_PW = "Antioch1004"; 

  const name = localStorage.getItem("run_name");
  const id = localStorage.getItem("run_id");

  if (!id) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "/TrapGame/index.html";
  }

  document.getElementById("playerName").innerText = name || "Guest";

  // ==========================================
  // ì¶œì„ì²´í¬ ë¡œì§
  // ==========================================
  function initAttendance() {
    const btn = document.getElementById("checkinBtn");
    const txt = document.getElementById("checkinText");
    const lastCheckTime = localStorage.getItem("last_checkin_time");
    
    const now = new Date();
    const todayReset = new Date();
    todayReset.setHours(23, 0, 0, 0);

    const yesterdayReset = new Date(todayReset);
    yesterdayReset.setDate(yesterdayReset.getDate() - 1);

    let canCheckIn = true;
    if (lastCheckTime) {
      const last = new Date(parseInt(lastCheckTime));
      if (now < todayReset) {
        if (last > yesterdayReset) canCheckIn = false;
      } else {
        if (last > todayReset) canCheckIn = false;
      }
    }

    if (!canCheckIn) {
      btn.classList.add("disabled");
      txt.innerText = "âœ… ì¶œì„ì™„ë£Œ (ë‚´ì¼ 23ì‹œ)";
      btn.onclick = null;
    }
  }

  async function dailyCheckIn() {
    const btn = document.getElementById("checkinBtn");
    const txt = document.getElementById("checkinText");

    // ë³´ìƒ ì§€ê¸‰
    let saveData = JSON.parse(localStorage.getItem("run_save") || "{}");
    
    if (!saveData.fragments || typeof saveData.fragments !== 'object') {
      saveData.fragments = {}; 
    }
    
    const hiddenSkins = ["Hidden_Skin1", "Hidden_Skin2", "Hidden_Skin3", "Hidden_Skin4", "Hidden_Skin5"];
    const randomSkin = hiddenSkins[Math.floor(Math.random() * hiddenSkins.length)];
    const randomSkinName = "íˆë“  ìŠ¤í‚¨ " + randomSkin.slice(-1);

    saveData.fragments[randomSkin] = (saveData.fragments[randomSkin] || 0) + 5;
    
    localStorage.setItem("run_save", JSON.stringify(saveData));
    localStorage.setItem("last_checkin_time", Date.now().toString());

    alert(`ğŸ ì¶œì„ì²´í¬ ì™„ë£Œ!\n[${randomSkinName} ì¡°ê° +5]ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`);
    
    btn.classList.add("disabled");
    txt.innerText = "âœ… ì¶œì„ì™„ë£Œ (ë‚´ì¼ 23ì‹œ)";
    btn.onclick = null;

    try {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ 
          type: "saveGameData", 
          id: id,
          saveData: saveData
        })
      });
    } catch(e) { console.warn("Checkin Sync Fail"); }
  }

  initAttendance();


  // ==========================================
  // [ìˆ˜ì •] í‹°ì»¤ ë¡œë“œ (íŠ•ê¹€ í˜„ìƒ ë°©ì§€)
  // ==========================================
  async function loadTicker() {
    const area = document.getElementById("tickerArea");
    
    try {
      const res = await fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ type: "getRecentLog" }) 
      });
      const txt = await res.text();
      // í‹°ì»¤ë„ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•˜ë„ë¡ ìˆ˜ì •í•˜ë©´ ì¢‹ìœ¼ë‚˜, ìš”ì²­í•˜ì‹  ê³µì§€ì‚¬í•­ ìœ„ì£¼ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
      // ì—¬ê¸°ëŠ” ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
      const logs = JSON.parse(txt);
      
      if(logs && logs.length > 0) {
        let html = "";
        logs.forEach(l => {
           let msg = l.reward;
           if(msg.includes("Starbucks")) msg = "ìŠ¤íƒ€ë²…ìŠ¤ ì¿ í° ë‹¹ì²¨!";
           if(msg.includes("QT Book")) msg = "QTì±… ë‹¹ì²¨!";
           html += `<span class="ticker-item">ğŸ‰ [${l.name}]ë‹˜ì´ ${msg} íšë“!</span>`;
        });
        // ë‚´ìš© ì¶”ê°€
        area.innerHTML += html;
      }
    } catch(e) {
      console.log("Ticker Load Fail", e);
    } finally {
      // [í•µì‹¬] ë¡œë”©ì´ ì„±ê³µí•˜ë“  ì‹¤íŒ¨í•˜ë“ , ë‚´ìš©ì´ ì™„ì„±ëœ í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
      // ì´ë ‡ê²Œ í•´ì•¼ ê¸¸ì´ê°€ í™•ì •ëœ ìƒíƒœì—ì„œ ì›€ì§ì„ì´ ì‹œì‘ë˜ì–´ íŠ•ê¸°ì§€ ì•ŠìŒ
      area.classList.add("ticker-moving");
    }
  }
  loadTicker();


  // ==========================================
  // ê³µì§€ì‚¬í•­ (ê´€ë¦¬ì ê¸°ëŠ¥)
  // ==========================================
  function openNotice() {
    document.getElementById("noticeModal").style.display = "flex";
    loadNotices();
  }
  
  async function loadNotices() {
    const listDiv = document.getElementById("noticeList");
    try {
      const res = await fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ type: "getNotices" }) 
      });
      const txt = await res.text();

      // [ìˆ˜ì •ëœ ë¶€ë¶„] í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ "fail" ë¬¸ìì—´ì´ë©´ íŒŒì‹±í•˜ì§€ ì•Šê³  ì¢…ë£Œ
      if (!txt || txt.trim() === "fail") {
         listDiv.innerHTML = "<p style='color:#999; text-align:center; padding:20px;'>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
         return;
      }

      const notices = JSON.parse(txt);

      if (!notices || notices.length === 0) {
        listDiv.innerHTML = "<p style='color:#999; text-align:center; padding:20px;'>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      let html = "";
      notices.forEach((n) => {
        html += `
          <div class="notice-item">
            <span class="notice-title">ğŸ“¢ ${n.title}</span>
            <div class="notice-content">${n.content}</div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px;">
              <span class="notice-date">${n.date} Â· ${n.writer}</span>
              <button class="btn-mini btn-del" onclick="deleteNotice(${n.rowIndex})">ì‚­ì œ</button>
            </div>
          </div>
        `;
      });
      listDiv.innerHTML = html;
    } catch(e) {
      // íŒŒì‹± ì—ëŸ¬ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì‚¬ìš©ìì—ê²ŒëŠ” ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
      console.warn("Notice Load Error:", e);
      listDiv.innerHTML = "<p style='color:#999; text-align:center; padding:20px;'>ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
    }
  }

  function tryWrite() {
    const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", "");
    if (input === ADMIN_PW) {
      document.getElementById("writeForm").style.display = "block";
      document.querySelector(".admin-controls").style.display = "none";
    } else {
      if(input !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
  }

  function cancelWrite() {
    document.getElementById("writeForm").style.display = "none";
    document.querySelector(".admin-controls").style.display = "flex";
    document.getElementById("noticeTitle").value = "";
    document.getElementById("noticeContent").value = "";
  }

  async function saveNotice() {
    const title = document.getElementById("noticeTitle").value.trim();
    const content = document.getElementById("noticeContent").value.trim();

    if (!title || !content) { alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    if(!confirm("ê³µì§€ì‚¬í•­ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
      await fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ type: "addNotice", title, content, writer: "ê´€ë¦¬ì" }) 
      });
      alert("ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      cancelWrite();
      loadNotices();
    } catch(e) { alert("ë“±ë¡ ì‹¤íŒ¨"); }
  }

  async function deleteNotice(rowIndex) {
    const input = prompt("ì‚­ì œí•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", "");
    if (input === ADMIN_PW) {
       if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
       try {
         const res = await fetch(API_URL, { 
           method: "POST", 
           body: JSON.stringify({ type: "deleteNotice", rowIndex }) 
         });
         const txt = await res.text();
         if(txt === "success") {
           alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
           loadNotices();
         } else {
           alert("ì‚­ì œ ì‹¤íŒ¨");
         }
       } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    } else {
      if(input !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
  }


  // ==========================================
  // ê¸°ë³¸ ê¸°ëŠ¥
  // ==========================================
  function startGame() { window.location.href = "/TrapGame/game.html"; }
  function openStore() { window.location.href = "/TrapGame/store.html"; }
  function logout() {
    if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      localStorage.removeItem("run_id");
      localStorage.removeItem("run_name");
      window.location.href = "/TrapGame/index.html";
    }
  }
  function closeModal(id) { document.getElementById(id).style.display = "none"; }

  // ì„œë²„ ë™ê¸°í™”
  async function refreshSave() {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "getSaveData", id })
      });
      const txt = await res.text();
      if (txt !== "fail") {
        localStorage.setItem("run_save", txt);
      }
    } catch (e) { console.warn("Sync Fail:", e); }
  }
  refreshSave();

  // ë­í‚¹
  async function showRanking() {
    const modal = document.getElementById("rankingModal");
    modal.style.display = "flex";
    const listDiv = document.getElementById("rankingList");
    listDiv.innerHTML = "<div class='spinner'></div>";

    try {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ type: "getRanking" }) });
      const txt = await res.text();
      const list = JSON.parse(txt);

      let html = "";
      if (list.length === 0) {
        html = "<p>ì•„ì§ ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      } else {
        list.forEach((item, index) => {
          let rankIcon = (index + 1) + ".";
          if(index === 0) rankIcon = "ğŸ¥‡";
          if(index === 1) rankIcon = "ğŸ¥ˆ";
          if(index === 2) rankIcon = "ğŸ¥‰";

          html += `
            <div class="rank-item">
              <div class="rank-rank">${rankIcon}</div>
              <div class="rank-info">
                <div style="font-weight:bold;">${item.name}</div>
                <span class="msg" style="font-size:12px; color:#666;">${item.message || "í•œë§ˆë”” ì—†ìŒ"}</span>
              </div>
              <div class="rank-score">${item.distance}m</div>
            </div>
          `;
        });
      }
      listDiv.innerHTML = html;
    } catch (e) {
      listDiv.innerHTML = "<p>ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨ :(</p>";
    }
  }
</script>

</body>
</html>
